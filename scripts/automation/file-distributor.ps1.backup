<#
.SYNOPSIS
    Enterprise file distribution utility with GUI, depth control, and comprehensive audit logging.

.DESCRIPTION
    Distributes a source file to multiple directories based on configurable depth criteria.
    Features include:
    - GUI-based file and directory selection
    - Configurable recursion depth (0 to N levels, or -1 for full recursion)
    - Per-folder confirmation dialogs
    - Dry run mode for safe testing
    - Overwrite control
    - Structured audit logging (CSV and JSON)
    - Progress reporting with visual feedback
    - Configuration file support (.json)
    - SHA256 hash tracking for file integrity
    - Hidden folder inclusion control

.PARAMETER SourceFile
    Path to the file to distribute. If not specified, a GUI dialog will prompt for selection.

.PARAMETER RootDirectory
    Root directory where files will be distributed. If not specified, a GUI dialog will prompt for selection.

.PARAMETER Depth
    Recursion depth for folder enumeration:
    - 0  : Root directory only
    - 1  : Root + immediate subdirectories
    - N  : Root + N levels deep
    - -1 : Full recursive (all subdirectories)

.PARAMETER DryRun
    If specified, simulates the operation without actually copying files.

.PARAMETER Overwrite
    If specified, overwrites existing files at target locations.

.PARAMETER ConfirmEach
    If specified, prompts for confirmation before each folder operation.

.PARAMETER IncludeHidden
    If specified, includes hidden folders in the distribution.

.PARAMETER LogDirectory
    Directory where audit logs will be saved. Defaults to ~/Documents/FileDistributorLogs.

.PARAMETER ConfigFile
    Path to a JSON configuration file containing default settings.

.PARAMETER UseGUI
    Forces GUI mode even when parameters are provided.

.PARAMETER WhatIf
    Shows what would happen if the command runs without actually executing.

.PARAMETER Verbose
    Displays detailed progress and diagnostic information.

.EXAMPLE
    .\file-distributor.ps1
    Launches the GUI for interactive file distribution.

.EXAMPLE
    .\file-distributor.ps1 -SourceFile "C:\template.txt" -RootDirectory "C:\Projects" -Depth 1 -DryRun
    Distributes template.txt to C:\Projects and immediate subdirectories in dry run mode.

.EXAMPLE
    .\file-distributor.ps1 -ConfigFile ".\config.json" -Verbose
    Uses settings from config.json with verbose output.

.EXAMPLE
    .\file-distributor.ps1 -SourceFile ".\LICENSE" -RootDirectory "C:\Repos" -Depth -1 -Overwrite -WhatIf
    Shows what would happen when distributing LICENSE to all subdirectories with overwrite.

.NOTES
    File Name      : file-distributor.ps1
    Version        : v02.00.00
    Author         : MokoStandards
    Prerequisite   : PowerShell 5.1 or later, Windows (for WinForms GUI)
    Requires       : -Modules (none)
    Requires       : -Version 5.1

.LINK
    https://github.com/MokoStandards
#>

#Requires -Version 5.1

[CmdletBinding(SupportsShouldProcess, DefaultParameterSetName = 'Interactive')]
param(
    [Parameter(ParameterSetName = 'CLI', Mandatory = $false, HelpMessage = 'Path to the source file to distribute')]
    [ValidateNotNullOrEmpty()]
    [ValidateScript({ Test-Path -LiteralPath $_ -PathType Leaf }, ErrorMessage = 'Source file must exist')]
    [string]$SourceFile,

    [Parameter(ParameterSetName = 'CLI', Mandatory = $false, HelpMessage = 'Root directory for distribution')]
    [ValidateNotNullOrEmpty()]
    [ValidateScript({ Test-Path -LiteralPath $_ -PathType Container }, ErrorMessage = 'Root directory must exist')]
    [string]$RootDirectory,

    [Parameter(ParameterSetName = 'CLI', Mandatory = $false, HelpMessage = 'Folder depth: 0=root only, 1=root+1 level, -1=full recursive')]
    [ValidateRange(-1, 100)]
    [int]$Depth = 1,

    [Parameter(ParameterSetName = 'CLI', Mandatory = $false, HelpMessage = 'Simulate without making changes')]
    [switch]$DryRun,

    [Parameter(ParameterSetName = 'CLI', Mandatory = $false, HelpMessage = 'Overwrite existing files')]
    [switch]$Overwrite,

    [Parameter(ParameterSetName = 'CLI', Mandatory = $false, HelpMessage = 'Confirm each folder operation')]
    [switch]$ConfirmEach,

    [Parameter(ParameterSetName = 'CLI', Mandatory = $false, HelpMessage = 'Include hidden folders')]
    [switch]$IncludeHidden = $true,

    [Parameter(Mandatory = $false, HelpMessage = 'Directory for audit logs')]
    [ValidateNotNullOrEmpty()]
    [string]$LogDirectory,

    [Parameter(Mandatory = $false, HelpMessage = 'Path to JSON configuration file')]
    [ValidateNotNullOrEmpty()]
    [ValidateScript({ Test-Path -LiteralPath $_ -PathType Leaf }, ErrorMessage = 'Config file must exist')]
    [string]$ConfigFile,

    [Parameter(ParameterSetName = 'Interactive', Mandatory = $false, HelpMessage = 'Force GUI mode')]
    [switch]$UseGUI
)

#region Script Initialization
Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'
$ProgressPreference = 'Continue'

$script:Version = 'v02.00.00'
$script:StartTime = Get-Date

Write-Verbose "File Distributor $script:Version starting at $($script:StartTime.ToString('o'))"
Write-Debug "Parameter Set: $($PSCmdlet.ParameterSetName)"
#endregion

#region Configuration Management
<#
.SYNOPSIS
    Loads configuration from a JSON file.

.DESCRIPTION
    Reads and parses a JSON configuration file containing default settings for the file distributor.

.PARAMETER Path
    Path to the JSON configuration file.

.OUTPUTS
    PSCustomObject containing configuration settings.
#>
function Get-DistributorConfig {
    [CmdletBinding()]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]
        [string]$Path
    )

    try {
        Write-Verbose "Loading configuration from: $Path"
        $configContent = Get-Content -LiteralPath $Path -Raw -Encoding UTF8
        $config = $configContent | ConvertFrom-Json
        Write-Debug "Configuration loaded successfully"
        return $config
    }
    catch {
        Write-Error "Failed to load configuration file '$Path': $_"
        throw
    }
}

<#
.SYNOPSIS
    Merges command-line parameters with configuration file settings.

.DESCRIPTION
    Prioritizes explicit command-line parameters over configuration file settings.

.PARAMETER Config
    Configuration object from file.

.PARAMETER Parameters
    Hashtable of command-line parameters.

.OUTPUTS
    Merged configuration object.
#>
function Merge-Configuration {
    [CmdletBinding()]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory = $true)]
        [PSCustomObject]$Config,

        [Parameter(Mandatory = $true)]
        [hashtable]$Parameters
    )

    Write-Verbose "Merging configuration with command-line parameters"

    foreach ($key in $Parameters.Keys) {
        if ($null -ne $Parameters[$key] -and $Config.PSObject.Properties.Name -contains $key) {
            Write-Debug "Overriding config.$key with parameter value"
            $Config.$key = $Parameters[$key]
        }
    }

    return $Config
}
#endregion
