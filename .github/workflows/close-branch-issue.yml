# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: MokoStandards.Workflows
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/close-branch-issue.yml
# VERSION: 01.00.00
# BRIEF: Closes tracking issues when branches are merged or deleted

name: Close Branch Tracking Issue

on:
  pull_request:
    types: [closed]
  delete:
    branches:
      - 'dev/**'
      - 'rc/**'

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  close-tracking-issue:
    name: Close Branch Tracking Issue
    runs-on: ubuntu-latest
    
    steps:
      - name: Determine branch name
        id: branch
        uses: actions/github-script@v7
        with:
          script: |
            let branchName;
            
            if (context.eventName === 'pull_request') {
              // For PR events, get the head branch name
              branchName = context.payload.pull_request.head.ref;
              console.log(`PR event: Branch is ${branchName}`);
            } else if (context.eventName === 'delete') {
              // For delete events, get the ref being deleted
              branchName = context.payload.ref;
              console.log(`Delete event: Branch is ${branchName}`);
            }
            
            if (!branchName) {
              console.log('Could not determine branch name');
              return;
            }
            
            core.setOutput('branch_name', branchName);
            
            // Determine if this is a dev or rc branch
            const isDev = branchName.startsWith('dev/');
            const isRc = branchName.startsWith('rc/');
            core.setOutput('is_tracked_branch', isDev || isRc ? 'true' : 'false');
      
      - name: Find tracking issue
        id: find_issue
        if: steps.branch.outputs.is_tracked_branch == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.branch.outputs.branch_name }}';
            
            // Search for issues with dev-branch label
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dev-branch',
              per_page: 100
            });
            
            // Find issue with branch name in title
            const trackingIssue = issues.data.find(issue => 
              issue.title.includes(branchName) || 
              issue.body.includes(`\`${branchName}\``)
            );
            
            if (trackingIssue) {
              console.log(`Found tracking issue #${trackingIssue.number}: ${trackingIssue.title}`);
              core.setOutput('issue_number', trackingIssue.number);
              core.setOutput('issue_title', trackingIssue.title);
              core.setOutput('found', 'true');
            } else {
              console.log(`No tracking issue found for branch ${branchName}`);
              core.setOutput('found', 'false');
            }
      
      - name: Close tracking issue
        if: steps.find_issue.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.find_issue.outputs.issue_number }}');
            const branchName = '${{ steps.branch.outputs.branch_name }}';
            const isPR = context.eventName === 'pull_request';
            
            let closeComment = `## ðŸŽ‰ Branch Closed\n\n`;
            closeComment += `The branch \`${branchName}\` has been `;
            
            if (isPR && context.payload.pull_request.merged) {
              const prNumber = context.payload.pull_request.number;
              const prTitle = context.payload.pull_request.title;
              closeComment += `merged via PR #${prNumber}.\n\n`;
              closeComment += `### Merged PR\n`;
              closeComment += `- **PR**: #${prNumber} - ${prTitle}\n`;
              closeComment += `- **Merged by**: @${context.payload.pull_request.merged_by.login}\n`;
              closeComment += `- **Merged at**: ${context.payload.pull_request.merged_at}\n`;
            } else if (isPR && !context.payload.pull_request.merged) {
              closeComment += `closed without merging.\n\n`;
            } else {
              closeComment += `deleted.\n\n`;
            }
            
            closeComment += `\n### ðŸ Branch Lifecycle Complete\n\n`;
            closeComment += `This tracking issue is now closed. The development work for this branch has been completed.\n\n`;
            closeComment += `---\n`;
            closeComment += `*This issue was automatically closed by the close-branch-issue workflow.*`;
            
            // Add closing comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: closeComment
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
            
            console.log(`Closed tracking issue #${issueNumber}`);
      
      - name: Workflow summary
        if: always()
        run: |
          echo "## Branch Issue Closure Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tracked Branch**: ${{ steps.branch.outputs.is_tracked_branch }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.find_issue.outputs.found }}" == "true" ]; then
            echo "- **Tracking Issue**: #${{ steps.find_issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: âœ… Issue closed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.branch.outputs.is_tracked_branch }}" == "true" ]; then
            echo "- **Status**: â„¹ï¸ No tracking issue found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: â„¹ï¸ Not a tracked branch type" >> $GITHUB_STEP_SUMMARY
          fi
