# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Security
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/codeql-analysis.yml
# VERSION: 01.01.00
# BRIEF: CodeQL security scanning for vulnerability detection
# NOTE: Runs SAST analysis on all supported languages in the repository
#
# âš ï¸  IMPORTANT: ADVANCED SETUP CONFIGURATION âš ï¸
# This workflow uses CodeQL Advanced Setup (custom workflow configuration).
# GitHub's "default setup" for code scanning MUST BE DISABLED in repository settings.
#
# How to disable default setup:
# 1. Go to: Settings â†’ Security â†’ Code security and analysis
# 2. Find "Code scanning" section
# 3. If "Default" is enabled, click "..." â†’ "Switch to advanced"
# 4. Confirm the switch to advanced setup
#
# Why this is required:
# - Default setup and advanced setup cannot coexist
# - Default setup uses managed configuration, blocking custom workflows
# - This workflow requires advanced setup to use custom queries and schedules
#
# Error if not disabled:
# "CodeQL analyses from advanced configurations cannot be processed when 
#  the default setup is enabled"
#
# For more information, see:
# - docs/policy/security-scanning.md
# - docs/security/security-scanning-guide.md

name: "CodeQL Security Scanning"

env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

# MokoStandards Policy Compliance:
# - File formatting: Enforces organizational coding standards
# - Reference: docs/policy/file-formatting.md

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW FLOW DIAGRAM                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER: Push/PR/Schedule (Weekly Mon 6am UTC)
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Checkout Code    â”‚
#   â”‚  (Full Depth)    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Initialize       â”‚â”€â”€â”€â” Language: Python
#   â”‚ CodeQL Database  â”‚   â”‚ Query Suite: security-extended,
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚             security-and-quality
#        â”‚                 â”‚
#        â–¼                 â”‚
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
#   â”‚  Auto-Build      â”‚â—€â”€â”€â”˜
#   â”‚  Source Code     â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Run CodeQL       â”‚â”€â”€â”€â” SAST Analysis
#   â”‚   Analysis       â”‚   â”‚ Security Patterns
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Vulnerability Detection
#        â”‚                 â”‚
#        â–¼                 â”‚
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
#   â”‚ Upload Results   â”‚â—€â”€â”€â”˜
#   â”‚ to GitHub SARIF  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚    OUTPUTS:      â”‚
#   â”‚ â€¢ SARIF Report   â”‚
#   â”‚ â€¢ Security Tab   â”‚
#   â”‚ â€¢ Alert Summary  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  push:
    branches:
      - main
      - dev/**
      - rc/**
      - version/**
  pull_request:
    branches:
      - main
      - dev/**
      - rc/**
  schedule:
    # Run weekly on Monday at 6:00 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: read

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      matrix:
        # Only list languages that actually exist in this repository
        # Python is the primary language for MokoStandards scripts
        language: ['python']
        # Supported languages: 'cpp', 'csharp', 'go', 'java', 'javascript',
        # 'python', 'ruby', 'swift'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for CodeQL Default Setup Conflict
        run: |
          set -x
          echo "### âš™ï¸ CodeQL Configuration Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow uses **Advanced Setup** for CodeQL." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Important**: If you see an error like:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "CodeQL analyses from advanced configurations cannot be" >> $GITHUB_STEP_SUMMARY
          echo "processed when the default setup is enabled" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to: \`Settings â†’ Security â†’ Code security and analysis\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Find \"Code scanning\" section" >> $GITHUB_STEP_SUMMARY
          echo "3. Click \"...\" next to \"Default\" â†’ \"Switch to advanced\"" >> $GITHUB_STEP_SUMMARY
          echo "4. Confirm the switch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… This check is informational only. Continuing with analysis..." >> $GITHUB_STEP_SUMMARY

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # Use security-extended query suite for comprehensive coverage
          queries: security-extended,security-and-quality
          # Optional: Add custom queries
          # config-file: ./.github/codeql-config.yml

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          upload: true
          # Wait for processing to complete
          wait-for-processing: true

      - name: Check for Critical/High Findings
        if: always()
        run: |
          set -x
          echo "### ðŸ” CodeQL Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Language**: ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
          QUERY_SUITE="security-extended, security-and-quality"
          echo "**Query Suite**: $QUERY_SUITE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          SEC_URL="https://github.com/${{ github.repository }}/security/code-scanning"
          echo "Check the [Security tab]($SEC_URL) for detailed findings." \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Response Requirements**:" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: Fix within 7 days" >> $GITHUB_STEP_SUMMARY
          echo "- High: Fix within 14 days" >> $GITHUB_STEP_SUMMARY
          echo "- Medium: Fix within 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- Low: Fix within 60 days or next release" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: analyze
    if: always()

    steps:
      - name: Generate Summary
        run: |
          set -x
          echo "### ðŸ›¡ï¸ Security Scanning Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All CodeQL security scans have completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scanned Languages**: See matrix configuration" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          SECURITY_URL="https://github.com/${{ github.repository }}/security"
          echo "ðŸ“Š [View all security alerts]($SECURITY_URL)" >> $GITHUB_STEP_SUMMARY
          POLICY_URL="https://github.com/${{ github.repository }}"
          POLICY_URL="$POLICY_URL/blob/main/docs/policy/security-scanning.md"
          echo "ðŸ“‹ [Security scanning policy]($POLICY_URL)" >> $GITHUB_STEP_SUMMARY
