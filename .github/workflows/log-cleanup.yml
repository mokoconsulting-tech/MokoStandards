# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Maintenance
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/log-cleanup.yml
# VERSION: 03.01.02
# BRIEF: Automated cleanup workflow - prunes logs and caches
# NOTE: Runs every 30 days by default, can be triggered manually

name: Cleanup & Maintenance

# MokoStandards Policy Compliance:
# - Log retention: Enforces 30-day retention policy per logs/README.md
# - Cache cleanup: Removes old GitHub Actions cache entries
# - Reference: logs/README.md (Log Retention section)

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW FLOW DIAGRAM                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER: Every 30 days OR manual dispatch
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Clean GitHub    â”‚
#   â”‚  Actions cache   â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Find log files  â”‚
#   â”‚  older than N    â”‚
#   â”‚  days (default   â”‚
#   â”‚  30)             â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Compress logs   â”‚
#   â”‚  7-30 days old   â”‚
#   â”‚  (*.log.gz)      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Delete *.log    â”‚
#   â”‚  files older     â”‚
#   â”‚  than retention  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Delete *.log.gz â”‚
#   â”‚  files older     â”‚
#   â”‚  than 90 days    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Generate        â”‚
#   â”‚  cleanup report  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  # Run every 30 days at 02:00 UTC (approximately monthly)
  # Note: GitHub Actions doesn't support exact 30-day intervals,
  # so we use day-of-month 1 and 31 to approximate 30-day cycles
  schedule:
    - cron: '0 2 1 * *'  # 1st of each month
    - cron: '0 2 31 * *'  # 31st of each month (when it exists)

  # Allow manual trigger with configurable retention
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to retain uncompressed logs (default: 30)'
        required: false
        default: '30'
        type: number
      compress_days:
        description: 'Compress logs older than N days (default: 7)'
        required: false
        default: '7'
        type: number
      archive_retention_days:
        description: 'Delete compressed logs older than N days (default: 90)'
        required: false
        default: '90'
        type: number
      dry_run:
        description: 'Perform dry run without deleting files'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write  # Required to delete cache entries

jobs:
  cleanup-logs:
    name: Cleanup & Maintenance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set Cleanup Parameters
        id: params
        run: |
          # Set retention parameters
          # Use inputs if triggered manually, otherwise use defaults
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RETENTION="${{ inputs.retention_days }}"
            COMPRESS="${{ inputs.compress_days }}"
            ARCHIVE="${{ inputs.archive_retention_days }}"
            DRYRUN="${{ inputs.dry_run }}"
          else
            RETENTION="30"
            COMPRESS="7"
            ARCHIVE="90"
            DRYRUN="false"
          fi

          echo "retention_days=$RETENTION" >> $GITHUB_OUTPUT
          echo "compress_days=$COMPRESS" >> $GITHUB_OUTPUT
          echo "archive_retention_days=$ARCHIVE" >> $GITHUB_OUTPUT
          echo "dry_run=$DRYRUN" >> $GITHUB_OUTPUT

      - name: Clean GitHub Actions Cache
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "## ðŸ—„ï¸ GitHub Actions Cache Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get list of caches
          CACHE_LIST=$(gh cache list --repo "$REPO" --json key,createdAt \
            --limit 1000 2>/dev/null || echo "[]")

          if [ "$CACHE_LIST" = "[]" ] || [ -z "$CACHE_LIST" ]; then
            echo "â„¹ï¸ No caches found or unable to list caches." \
              >> $GITHUB_STEP_SUMMARY
          else
            # Calculate date 7 days ago (in seconds since epoch)
            CUTOFF_DATE=$(date -u -d '7 days ago' +%s 2>/dev/null || \
              date -u -v-7d +%s 2>/dev/null)

            TOTAL_COUNT=$(echo "$CACHE_LIST" | jq 'length')
            echo "Found $TOTAL_COUNT cache entries" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Use temp file for counting (avoids subshell scope issues)
            TEMP_COUNT_FILE=$(mktemp)
            echo "0" > "$TEMP_COUNT_FILE"

            # Process each cache entry using null-separated output
            echo "$CACHE_LIST" | jq -r '.[] | @base64' | while read -r ENTRY; do
              # Decode the base64 entry
              DECODED=$(echo "$ENTRY" | base64 -d)
              KEY=$(echo "$DECODED" | jq -r '.key')
              CREATED_AT=$(echo "$DECODED" | jq -r '.createdAt')

              # Extract just the date part (handles various ISO formats)
              # Strip milliseconds and timezone, convert to epoch
              CLEAN_DATE=$(echo "$CREATED_AT" | \
                sed 's/\.[0-9]*Z$/Z/' | sed 's/+00:00$/Z/')
              CACHE_DATE=$(date -u -d "$CLEAN_DATE" +%s 2>/dev/null || \
                date -j -u -f "%Y-%m-%dT%H:%M:%SZ" "$CLEAN_DATE" +%s 2>/dev/null)

              if [ -n "$CACHE_DATE" ] && \
                 [ "$CACHE_DATE" -lt "$CUTOFF_DATE" ]; then
                if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
                  echo "Would delete: $KEY (created: $CREATED_AT)"
                  CURRENT=$(cat "$TEMP_COUNT_FILE")
                  echo $((CURRENT + 1)) > "$TEMP_COUNT_FILE"
                else
                  if gh cache delete "$KEY" --repo "$REPO" 2>/dev/null; then
                    echo "Deleted: $KEY (created: $CREATED_AT)"
                    CURRENT=$(cat "$TEMP_COUNT_FILE")
                    echo $((CURRENT + 1)) > "$TEMP_COUNT_FILE"
                  fi
                fi
              fi
            done

            # Read final count from temp file
            DELETED_COUNT=$(cat "$TEMP_COUNT_FILE")
            rm -f "$TEMP_COUNT_FILE"

            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $DELETED_COUNT cache(s)" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Deleted $DELETED_COUNT old cache(s)" \
                >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Display Cleanup Configuration
        run: |
          echo "## ðŸ§¹ Cleanup & Maintenance Configuration" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          RETENTION="${{ steps.params.outputs.retention_days }}"
          COMPRESS="${{ steps.params.outputs.compress_days }}"
          ARCHIVE="${{ steps.params.outputs.archive_retention_days }}"
          DRYRUN="${{ steps.params.outputs.dry_run }}"
          echo "| Retention Period (uncompressed) | $RETENTION days |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Compress Logs After | $COMPRESS days |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Archive Retention Period | $ARCHIVE days |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | $DRYRUN |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Find and Report Log Files
        id: report
        run: |
          echo "## ðŸ“Š Current Log Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if logs directory exists
          if [ ! -d "logs" ]; then
            echo "âš ï¸ No logs directory found." >> $GITHUB_STEP_SUMMARY
            echo "has_logs=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_logs=true" >> $GITHUB_OUTPUT

          # Count current log files
          TOTAL_LOGS=$(find logs/ -name "*.log" -type f 2>/dev/null | wc -l)
          TOTAL_GZ=$(find logs/ -name "*.log.gz" -type f 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh logs/ 2>/dev/null | cut -f1)

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Uncompressed Logs | $TOTAL_LOGS |" >> $GITHUB_STEP_SUMMARY
          echo "| Compressed Logs | $TOTAL_GZ |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Size | $TOTAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Compress Old Logs
        if: steps.report.outputs.has_logs == 'true'
        run: |
          COMPRESS_DAYS="${{ steps.params.outputs.compress_days }}"
          DRY_RUN="${{ steps.params.outputs.dry_run }}"

          echo "### ðŸ“¦ Compress Logs Older Than $COMPRESS_DAYS Days" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find logs older than compress_days
          MATCHES=$(find logs/ -name "*.log" -type f \
            -mtime +$COMPRESS_DAYS 2>/dev/null)

          if [ -z "$MATCHES" ]; then
            echo "âœ… No logs older than $COMPRESS_DAYS days." \
              >> $GITHUB_STEP_SUMMARY
          else
            COUNT=$(echo "$MATCHES" | wc -l)
            echo "Found $COUNT log file(s) to compress:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MATCHES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            if [ "$DRY_RUN" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ” **Dry run** - Files not modified." \
                >> $GITHUB_STEP_SUMMARY
            else
              # Compress the files (using -print0/-0 for safe handling)
              find logs/ -name "*.log" -type f \
                -mtime +$COMPRESS_DAYS -print0 2>/dev/null | \
                xargs -0 -r gzip
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Compressed $COUNT log file(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Delete Old Uncompressed Logs
        if: steps.report.outputs.has_logs == 'true'
        run: |
          RETENTION_DAYS="${{ steps.params.outputs.retention_days }}"
          DRY_RUN="${{ steps.params.outputs.dry_run }}"

          echo "### ðŸ—‘ï¸ Delete Uncompressed Logs Older Than" \
            "$RETENTION_DAYS Days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find logs older than retention period
          MATCHES=$(find logs/ -name "*.log" -type f \
            -mtime +$RETENTION_DAYS 2>/dev/null)

          if [ -z "$MATCHES" ]; then
            echo "âœ… No uncompressed logs older than $RETENTION_DAYS days." \
              >> $GITHUB_STEP_SUMMARY
          else
            COUNT=$(echo "$MATCHES" | wc -l)
            echo "Found $COUNT log file(s) to delete:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MATCHES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            if [ "$DRY_RUN" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ” **Dry run** - Files not modified." \
                >> $GITHUB_STEP_SUMMARY
            else
              # Delete the files (using -print0/-0 for safe handling)
              find logs/ -name "*.log" -type f \
                -mtime +$RETENTION_DAYS -print0 2>/dev/null | \
                xargs -0 -r rm -f
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Deleted $COUNT log file(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Delete Old Compressed Archives
        if: steps.report.outputs.has_logs == 'true'
        run: |
          ARCHIVE_RETENTION="${{ steps.params.outputs.archive_retention_days }}"
          DRY_RUN="${{ steps.params.outputs.dry_run }}"

          echo "### ðŸ—„ï¸ Delete Compressed Archives Older Than" \
            "$ARCHIVE_RETENTION Days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find compressed logs older than archive retention period
          MATCHES=$(find logs/ -name "*.log.gz" -type f \
            -mtime +$ARCHIVE_RETENTION 2>/dev/null)

          if [ -z "$MATCHES" ]; then
            echo "âœ… No archives older than $ARCHIVE_RETENTION days." \
              >> $GITHUB_STEP_SUMMARY
          else
            COUNT=$(echo "$MATCHES" | wc -l)
            echo "Found $COUNT archive(s) to delete:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MATCHES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            if [ "$DRY_RUN" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ” **Dry run** - Files not modified." \
                >> $GITHUB_STEP_SUMMARY
            else
              # Delete the files (using -print0/-0 for safe handling)
              find logs/ -name "*.log.gz" -type f \
                -mtime +$ARCHIVE_RETENTION -print0 2>/dev/null | \
                xargs -0 -r rm -f
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Deleted $COUNT archive(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Generate Final Report
        if: steps.report.outputs.has_logs == 'true'
        run: |
          echo "## ðŸ“ˆ Final Log Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count remaining log files
          REMAINING=$(find logs/ -name "*.log" -type f 2>/dev/null | wc -l)
          REMAINING_GZ=$(find logs/ -name "*.log.gz" -type f \
            2>/dev/null | wc -l)
          FINAL_SIZE=$(du -sh logs/ 2>/dev/null | cut -f1)

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Remaining Uncompressed Logs | $REMAINING |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Remaining Compressed Logs | $REMAINING_GZ |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Total Size | $FINAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Log cleanup completed successfully!**" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          LINK="[logs/README.md](../blob/main/logs/README.md)"
          echo "For more information, see $LINK." >> $GITHUB_STEP_SUMMARY

      - name: Commit Changes
        if: |
          steps.report.outputs.has_logs == 'true' &&
          steps.params.outputs.dry_run == 'false'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            git add logs/

            COMPRESS="${{ steps.params.outputs.compress_days }}"
            RETENTION="${{ steps.params.outputs.retention_days }}"
            ARCHIVE="${{ steps.params.outputs.archive_retention_days }}"

            git commit -m "chore: automated log cleanup" \
              -m "" \
              -m "- Compressed logs older than $COMPRESS days" \
              -m "- Deleted uncompressed logs older than $RETENTION days" \
              -m "- Deleted archives older than $ARCHIVE days" \
              -m "" \
              -m "Automated by log-cleanup workflow"

            git push
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ Changes committed and pushed." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ No changes to commit." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Workflow Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Information**" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "- Timestamp: $TIMESTAMP" >> $GITHUB_STEP_SUMMARY
