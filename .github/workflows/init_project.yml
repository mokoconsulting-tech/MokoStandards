name: Initialize ProjectV2 with Custom Fields

on:
  workflow_dispatch:
    inputs:
      owner_login:
        description: "GitHub org or user login (e.g., mokoconsulting-tech)"
        required: true
        default: "mokoconsulting-tech"
      project_title:
        description: "Project title (e.g., MokoStandards Documentation Control Register)"
        required: true
        default: "MokoStandards Documentation Control Register"

permissions:
  contents: read

jobs:
  init_project:
    runs-on: ubuntu-latest

    steps:
      - name: Guardrails
        shell: bash
        run: |
          set -euo pipefail
          command -v gh >/dev/null 2>&1 || { echo "ERROR: gh not found"; exit 1; }
          command -v python3 >/dev/null 2>&1 || { echo "ERROR: python3 not found"; exit 1; }
          if [[ -z "${{ secrets.GH_PAT }}" ]]; then
            echo "ERROR: Missing required secret GH_PAT (needs Projects scope)"
            exit 1
          fi

      - name: Create ProjectV2 and Custom Fields
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          OWNER_LOGIN: ${{ inputs.owner_login }}
          PROJECT_TITLE: ${{ inputs.project_title }}
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'EOF'
          import json
          import os
          import subprocess
          import sys
          from typing import Any, Dict, List, Optional

          OWNER_LOGIN = os.environ["OWNER_LOGIN"]
          PROJECT_TITLE = os.environ["PROJECT_TITLE"]

          def gh_graphql(query: str, variables: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
            args = ["gh", "api", "graphql", "-f", f"query={query}"]
            if variables:
              for k, v in variables.items():
                if isinstance(v, (dict, list)):
                  args += ["-F", f"{k}={json.dumps(v)}"]
                else:
                  args += ["-F", f"{k}={v}"]
            p = subprocess.run(args, text=True, capture_output=True)
            if p.returncode != 0:
              print(p.stderr.strip(), file=sys.stderr)
              raise SystemExit(1)
            return json.loads(p.stdout)

          # Resolve owner ID (org preferred, fallback to user)
          # Try organization first
          owner_id = None
          owner_type = None
          
          q_org = "query($login:String!){ organization(login:$login){ id } }"
          try:
            owner_data = gh_graphql(q_org, {"login": OWNER_LOGIN})
            org = (owner_data.get("data", {}) or {}).get("organization")
            if org and org.get("id"):
              owner_id = org["id"]
              owner_type = "organization"
          except:
            pass  # Organization not found, try user
          
          # If not found as organization, try user
          if not owner_id:
            q_user = "query($login:String!){ user(login:$login){ id } }"
            try:
              owner_data = gh_graphql(q_user, {"login": OWNER_LOGIN})
              usr = (owner_data.get("data", {}) or {}).get("user")
              if usr and usr.get("id"):
                owner_id = usr["id"]
                owner_type = "user"
            except:
              pass  # User not found either
          
          if not owner_id:
            print(f"ERROR: Owner not found: {OWNER_LOGIN}", file=sys.stderr)
            raise SystemExit(1)

          print(f"Owner resolved: {OWNER_LOGIN} (type: {owner_type})")

          # Create ProjectV2
          q_create_project = """
          mutation($ownerId:ID!,$title:String!){
            createProjectV2(input:{ownerId:$ownerId,title:$title}){
              projectV2 { id number title }
            }
          }
          """

          create_result = gh_graphql(q_create_project, {"ownerId": owner_id, "title": PROJECT_TITLE})
          project = (((create_result.get("data", {}) or {}).get("createProjectV2", {}) or {}).get("projectV2", {}) or {})

          if not project or not project.get("id"):
            print("ERROR: Failed to create ProjectV2", file=sys.stderr)
            raise SystemExit(1)

          project_id = project["id"]
          project_number = project["number"]
          print(f"Created ProjectV2: #{project_number} - {project.get('title', '')}")
          print(f"Project ID: {project_id}")

          # Define custom fields
          # NOTE: GitHub GraphQL API does not support setting option colors via createProjectV2Field mutation.
          # Colors must be set manually via the GitHub web UI after field creation.

          single_select_fields = [
            {
              "name": "Status",
              "options": ["Planned", "In Progress", "In Review", "Approved", "Published", "Blocked", "Archived"]
            },
            {
              "name": "Priority",
              "options": ["High", "Medium", "Low"]
            },
            {
              "name": "Risk Level",
              "options": ["High", "Medium", "Low"]
            },
            {
              "name": "Document Type",
              "options": ["overview", "index", "policy", "guide", "checklist"]
            },
            {
              "name": "Document Subtype",
              "options": ["core", "waas", "catalog", "policy", "guide"]
            },
            {
              "name": "Owner Role",
              "options": ["Documentation Owner", "Governance Owner", "Security Owner", "Operations Owner", "Release Owner"]
            },
            {
              "name": "Approval Required",
              "options": ["Yes", "No"]
            },
            {
              "name": "Evidence Required",
              "options": ["Yes", "No"]
            },
            {
              "name": "Review Cycle",
              "options": ["Annual", "Semiannual", "Quarterly", "Ad hoc"]
            },
            {
              "name": "Retention",
              "options": ["Indefinite", "7 Years", "5 Years", "3 Years"]
            }
          ]

          multi_select_fields = [
            {
              "name": "Compliance Tags",
              "options": ["Governance", "Audit", "Security", "Compliance", "Operations", "Release", "Engineering"]
            },
            {
              "name": "Evidence Artifacts",
              "options": ["Pull Request", "Review Approval", "Published Document", "Audit Record"]
            }
          ]

          text_fields = [
            "Document Path",
            "Dependencies",
            "Acceptance Criteria",
            "RACI",
            "KPI – Timeliness",
            "KPI – Quality",
            "KPI – Compliance"
          ]

          q_create_single_select = """
          mutation($projectId:ID!,$name:String!,$options:[ProjectV2SingleSelectFieldOptionInput!]!){
            createProjectV2Field(input:{projectId:$projectId,dataType:SINGLE_SELECT,name:$name,singleSelectOptions:$options}){
              projectV2Field { id name }
            }
          }
          """

          q_create_multi_select = """
          mutation($projectId:ID!,$name:String!,$options:[ProjectV2SingleSelectFieldOptionInput!]!){
            createProjectV2Field(input:{projectId:$projectId,dataType:MULTI_SELECT,name:$name,multiSelectOptions:$options}){
              projectV2Field { id name }
            }
          }
          """

          q_create_text = """
          mutation($projectId:ID!,$name:String!){
            createProjectV2Field(input:{projectId:$projectId,dataType:TEXT,name:$name}){
              projectV2Field { id name }
            }
          }
          """

          # Create single select fields
          for field_def in single_select_fields:
            try:
              options = [{"name": opt} for opt in field_def["options"]]
              result = gh_graphql(q_create_single_select, {
                "projectId": project_id,
                "name": field_def["name"],
                "options": options
              })
              field = (((result.get("data", {}) or {}).get("createProjectV2Field", {}) or {}).get("projectV2Field", {}) or {})
              if field.get("id"):
                print(f"Created single select field: {field_def['name']}")
              else:
                print(f"WARN: Failed to create field: {field_def['name']}")
            except Exception as e:
              # Idempotent: if field exists, log and continue
              print(f"WARN: Could not create field {field_def['name']} (may already exist): {e}")

          # Create multi select fields
          for field_def in multi_select_fields:
            try:
              options = [{"name": opt} for opt in field_def["options"]]
              result = gh_graphql(q_create_multi_select, {
                "projectId": project_id,
                "name": field_def["name"],
                "options": options
              })
              field = (((result.get("data", {}) or {}).get("createProjectV2Field", {}) or {}).get("projectV2Field", {}) or {})
              if field.get("id"):
                print(f"Created multi select field: {field_def['name']}")
              else:
                print(f"WARN: Failed to create field: {field_def['name']}")
            except Exception as e:
              # Idempotent: if field exists, log and continue
              print(f"WARN: Could not create field {field_def['name']} (may already exist): {e}")

          # Create text fields
          for field_name in text_fields:
            try:
              result = gh_graphql(q_create_text, {
                "projectId": project_id,
                "name": field_name
              })
              field = (((result.get("data", {}) or {}).get("createProjectV2Field", {}) or {}).get("projectV2Field", {}) or {})
              if field.get("id"):
                print(f"Created text field: {field_name}")
              else:
                print(f"WARN: Failed to create field: {field_name}")
            except Exception as e:
              # Idempotent: if field exists, log and continue
              print(f"WARN: Could not create field {field_name} (may already exist): {e}")

          print("\n" + "="*60)
          print("Project initialization complete!")
          print(f"Project Number: {project_number}")
          print(f"Project Title: {PROJECT_TITLE}")
          print("="*60)
          print("\nNOTE: Option colors cannot be set via GraphQL API.")
          print("Please configure colors manually in the GitHub web UI:")
          print("- Status: Planned (GRAY), In Progress (BLUE), In Review (YELLOW),")
          print("  Approved (GREEN), Published (PURPLE), Blocked (RED), Archived (GRAY)")
          EOF
