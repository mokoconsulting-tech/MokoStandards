# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: MokoStandards.Workflows
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/reserve-dolibarr-module-id.yml
# VERSION: 04.00.00
# BRIEF: Automatically reserves a Dolibarr module ID and creates a pull request
# NOTE: Reserves module IDs from the range 185064-185099 (Moko Consulting reserved range)

name: Reserve Dolibarr Module ID

env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

# MokoStandards Policy Compliance:
# - File formatting: Enforces organizational coding standards
# - Reference: docs/policy/file-formatting.md
# - Module ID Reservation: docs/policy/crm/development-standards.md

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW FLOW DIAGRAM                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER: Manual Workflow Dispatch
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Find Next        â”‚
#   â”‚ Available ID     â”‚â”€â”€â”€â” Scan 185064-185099 range
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Parse existing table
#        â”‚                 â”‚
#        â–¼                 â”‚
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
#   â”‚ Update Module    â”‚â—€â”€â”€â”˜
#   â”‚ Registry Table   â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Create Branch    â”‚â”€â”€â”€â” reserve-module-id/<id>
#   â”‚ and Commit       â”‚   â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
#        â”‚                 â”‚
#        â–¼                 â”‚
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
#   â”‚ Create Pull      â”‚â—€â”€â”€â”˜
#   â”‚ Request          â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#        â–¼                â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ PR Link â”‚    â”‚  Push to â”‚
#   â”‚ Output  â”‚    â”‚  Remote  â”‚ (Optional)
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  workflow_dispatch:
    inputs:
      module_name:
        description: 'Module name (e.g., MokoDoliExample)'
        required: true
        type: string
      description:
        description: 'Brief description of the module'
        required: true
        type: string
      developer:
        description: 'Developer name'
        required: true
        type: string
      repository:
        description: 'Repository URL (use "TBD" if not yet created)'
        required: false
        type: string
        default: 'TBD'
      push_to_remote:
        description: 'Push to remote repository src folder'
        type: boolean
        default: false
      remote_repository:
        description: 'Remote repository URL (required if push_to_remote is true)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  reserve:
    name: Reserve Dolibarr Module ID
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find next available module ID
        id: find_id
        run: |
          REGISTRY_FILE="docs/policy/crm/development-standards.md"

          echo "ğŸ“– Reading module registry..."

          # Extract module IDs from the table, only from the 185064-185099 range
          USED_IDS=$(grep -oP '(?<=\| )1850(6[4-9]|[7-8][0-9]|9[0-9])(?= \|)' "$REGISTRY_FILE" | sort -n || true)

          echo "Used IDs in range 185064-185099:"
          echo "$USED_IDS"

          # Find the first available ID in the range 185064-185099
          NEXT_ID=""
          for id in $(seq 185064 185099); do
            if ! echo "$USED_IDS" | grep -q "^$id$"; then
              NEXT_ID=$id
              break
            fi
          done

          if [ -z "$NEXT_ID" ]; then
            echo "âŒ Error: No available module IDs in range 185064-185099"
            exit 1
          fi

          echo "âœ… Next available module ID: $NEXT_ID"
          echo "module_id=$NEXT_ID" >> $GITHUB_OUTPUT

      - name: Detect ID conflicts
        id: detect_conflicts
        env:
          MODULE_ID: ${{ steps.find_id.outputs.module_id }}
        run: |
          REGISTRY_FILE="docs/policy/crm/development-standards.md"

          echo "ğŸ” Checking for ID conflicts..."

          # Check if the ID already exists in the registry
          if grep -q "| $MODULE_ID |" "$REGISTRY_FILE"; then
            echo "âŒ Error: Module ID $MODULE_ID is already in use!"
            echo "conflict=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… No conflicts detected for module ID $MODULE_ID"
          echo "conflict=false" >> $GITHUB_OUTPUT

      - name: Create module registry documentation
        id: create_docs
        env:
          MODULE_NAME: ${{ github.event.inputs.module_name }}
          MODULE_ID: ${{ steps.find_id.outputs.module_id }}
          DESCRIPTION: ${{ github.event.inputs.description }}
          REPOSITORY: ${{ github.event.inputs.repository }}
          DEVELOPER: ${{ github.event.inputs.developer }}
        run: |
          DOC_FILE="docs/modules/${MODULE_NAME}.md"
          mkdir -p docs/modules

          echo "ğŸ“š Creating module registry documentation..."

          cat > "$DOC_FILE" << EOF
          # ${MODULE_NAME}

          ## Module ID Assignment

          **DOLIBARR_MODULE_ID: ${MODULE_ID}**

          This is the official Dolibarr module ID reserved for ${MODULE_NAME}.

          ## Basic Information

          | Property | Value |
          |----------|-------|
          | Module ID | ${MODULE_ID} |
          | Module Name | ${MODULE_NAME} |
          | Status | Reserved |
          | Developer | ${DEVELOPER} |
          | Repository | ${REPOSITORY} |
          | Reserved Date | $(date -u +"%Y-%m-%d") |
          | Reserved Range | 185051-185099 (Moko Consulting) |

          ## Description

          ${DESCRIPTION}

          ## Module Configuration

          ### Module Descriptor

          The module descriptor should use this ID:

          \`\`\`php
          <?php
          class mod${MODULE_NAME} extends DolibarrModules
          {
              public function __construct(\$db)
              {
                  parent::__construct(\$db);

                  // DO NOT CHANGE THIS ID!
                  // This ID is officially reserved in MokoStandards
                  \$this->numero = ${MODULE_ID};

                  \$this->rights_class = '$(echo "${MODULE_NAME}" | tr '[:upper:]' '[:lower:]')';
                  \$this->family = "mokoconsulting";
                  \$this->name = preg_replace('/^mod/i', '', get_class(\$this));
                  \$this->description = "${DESCRIPTION}";

                  \$this->editor_name = 'Moko Consulting';
                  \$this->editor_url = 'https://www.mokoconsulting.tech';

                  \$this->version = '1.0.0';
                  \$this->const_name = 'MAIN_MODULE_'.strtoupper(\$this->name);
              }
          }
          \`\`\`

          ## Technical Details

          - **Module Number:** ${MODULE_ID}
          - **Rights Class:** $(echo "${MODULE_NAME}" | tr '[:upper:]' '[:lower:]')
          - **Family:** mokoconsulting
          - **Position:** 90

          ## Reservation Details

          - **Reserved Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Reserved By:** ${DEVELOPER}
          - **Reservation Method:** Automated via reserve-dolibarr-module-id workflow
          - **Registry Entry:** docs/policy/crm/development-standards.md

          ## Module ID File

          A \`DOLIBARR_MODULE_ID.txt\` file should be placed in the repository's \`src/\` directory:

          \`\`\`
          DOLIBARR_MODULE_ID=${MODULE_ID}
          \`\`\`

          This file serves as a reference and prevents accidental ID changes.

          ## Next Steps

          1. Create the repository at ${REPOSITORY} (if not already created)
          2. Add \`src/DOLIBARR_MODULE_ID.txt\` with the module ID
          3. Create module descriptor: \`src/mod${MODULE_NAME}.class.php\`
          4. Implement module functionality
          5. Update status from "Reserved" to "Active" in the registry once deployed

          ## Important Notes

          âš ï¸ **DO NOT CHANGE THE MODULE ID!**

          This module ID (${MODULE_ID}) has been officially reserved in MokoStandards and registered in the Dolibarr module number registry. Changing this ID will cause conflicts and break compatibility.

          ## References

          - [CRM Development Standards](../policy/crm/development-standards.md)
          - [Dolibarr Module Development Guide](../guide/crm/dolibarr-development-guide.md)
          - [MokoStandards Module Registry](../policy/crm/development-standards.md#reserved-module-numbers)

          ---

          **Module ID:** ${MODULE_ID}
          **Status:** Reserved
          **Last Updated:** $(date -u +"%Y-%m-%d")

          _Generated by reserve-dolibarr-module-id workflow v04.00.00_
          EOF

          echo "âœ… Created module description documentation: $DOC_FILE"
          echo "doc_file=$DOC_FILE" >> $GITHUB_OUTPUT

          # Create README for the module documentation
          README_FILE="docs/modules/${MODULE_NAME}_README.md"
          cat > "$README_FILE" << EOF
          # ${MODULE_NAME}

          **Dolibarr Module ID: ${MODULE_ID}**

          ${DESCRIPTION}

          ## Module ID

          This module has been assigned the official Dolibarr module ID: **${MODULE_ID}**

          âš ï¸ **DO NOT CHANGE THIS ID!** It is officially reserved in MokoStandards.

          ## Quick Reference

          - **Module ID:** ${MODULE_ID}
          - **Module Name:** ${MODULE_NAME}
          - **Status:** Reserved
          - **Reserved Date:** $(date -u +"%Y-%m-%d")
          - **Developer:** ${DEVELOPER}
          - **Repository:** ${REPOSITORY}

          ## Installation

          1. Clone this repository
          2. Copy to Dolibarr's \`htdocs/custom/\` directory
          3. Enable the module in Dolibarr admin interface
          4. Configure module settings as needed

          ## Module Information

          This module is part of the Moko Consulting Dolibarr extension suite.

          - **Family:** mokoconsulting
          - **Reserved Range:** 185051-185099 (Moko Consulting)
          - **Rights Class:** $(echo "${MODULE_NAME}" | tr '[:upper:]' '[:lower:]')

          ## Files

          Key files in this module:

          - \`src/DOLIBARR_MODULE_ID.txt\` - Module ID reference (DO NOT MODIFY)
          - \`src/mod${MODULE_NAME}.class.php\` - Module descriptor class
          - \`README.md\` - This file

          ## Documentation

          Full module documentation is available in MokoStandards:

          - [Module Registry Entry](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/policy/crm/development-standards.md)
          - [Module Documentation](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/modules/${MODULE_NAME}.md)
          - [Dolibarr Development Guide](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/guide/crm/dolibarr-development-guide.md)

          ## Support

          For support, please contact ${DEVELOPER} or file an issue in the repository.

          ## License

          GPL-3.0-or-later

          ---

          **Module ID:** ${MODULE_ID} | **Reserved:** $(date -u +"%Y-%m-%d") | **Moko Consulting**
          EOF

          echo "âœ… Created module README: $README_FILE"
          echo "readme_file=$README_FILE" >> $GITHUB_OUTPUT

          # Also create a simple MODULE_ID.txt file for easy reference
          MODULE_ID_REF="docs/modules/${MODULE_NAME}_MODULE_ID.txt"
          cat > "$MODULE_ID_REF" << EOF
          DOLIBARR_MODULE_ID=${MODULE_ID}
          MODULE_NAME=${MODULE_NAME}
          RESERVED_DATE=$(date -u +"%Y-%m-%d")
          DEVELOPER=${DEVELOPER}
          REPOSITORY=${REPOSITORY}
          EOF

          echo "âœ… Created module ID reference file: $MODULE_ID_REF"
          echo "module_id_ref=$MODULE_ID_REF" >> $GITHUB_OUTPUT

      - name: Update module registry
        id: update_registry
        env:
          MODULE_NAME: ${{ github.event.inputs.module_name }}
          MODULE_ID: ${{ steps.find_id.outputs.module_id }}
          DESCRIPTION: ${{ github.event.inputs.description }}
          REPOSITORY: ${{ github.event.inputs.repository }}
        run: |
          REGISTRY_FILE="docs/policy/crm/development-standards.md"

          echo "ğŸ“ Updating module registry..."

          # Find the line with "Available for Assignment"
          LINE_NUM=$(grep -n "| Available for Assignment |" "$REGISTRY_FILE" | cut -d: -f1)

          if [ -z "$LINE_NUM" ]; then
            echo "âŒ Error: Could not find 'Available for Assignment' line in registry"
            exit 1
          fi

          # Create new entry
          NEW_ENTRY="| $MODULE_NAME | $MODULE_ID | Reserved | $DESCRIPTION | $REPOSITORY |"

          # Insert the new entry before "Available for Assignment" line
          sed -i "${LINE_NUM}i\\${NEW_ENTRY}" "$REGISTRY_FILE"

          echo "âœ… Registry updated with:"
          echo "$NEW_ENTRY"

      - name: Update MokoStandards.override.tf
        id: update_override
        env:
          MODULE_NAME: ${{ github.event.inputs.module_name }}
        run: |
          OVERRIDE_FILE="MokoStandards.override.tf"
          DOC_FILE="docs/modules/${MODULE_NAME}.md"

          echo "ğŸ”§ Updating MokoStandards.override.tf to exclude module docs from distribution..."

          # Find the line number for the search pattern
          LINE_NUM=$(grep -n "# Keep new Week 1 enterprise workflows (MokoStandards-specific)" "$OVERRIDE_FILE" | cut -d: -f1)

          if [ -z "$LINE_NUM" ]; then
            echo "âš ï¸ Could not find insertion point in $OVERRIDE_FILE"
            echo "Skipping override file update"
          else
            # Create the new entry lines
            printf "    # Keep module registry documentation\n" > /tmp/module_entry.txt
            printf "    {\n" >> /tmp/module_entry.txt
            printf "      path   = \"%s\"\n" "$DOC_FILE" >> /tmp/module_entry.txt
            printf "      reason = \"Module registry documentation - MokoStandards specific\"\n" >> /tmp/module_entry.txt
            printf "    },\n" >> /tmp/module_entry.txt

            # Insert the new entry before the found line
            head -n $((LINE_NUM - 1)) "$OVERRIDE_FILE" > /tmp/override_new.tf
            cat /tmp/module_entry.txt >> /tmp/override_new.tf
            tail -n +$LINE_NUM "$OVERRIDE_FILE" >> /tmp/override_new.tf

            mv /tmp/override_new.tf "$OVERRIDE_FILE"

            echo "âœ… Updated $OVERRIDE_FILE to protect module documentation"
          fi

      - name: Create branch and commit changes
        id: commit
        env:
          MODULE_ID: ${{ steps.find_id.outputs.module_id }}
          MODULE_NAME: ${{ github.event.inputs.module_name }}
          DEVELOPER: ${{ github.event.inputs.developer }}
          DOC_FILE: ${{ steps.create_docs.outputs.doc_file }}
          README_FILE: ${{ steps.create_docs.outputs.readme_file }}
        run: |
          BRANCH_NAME="reserve-module-id/$MODULE_ID"

          echo "ğŸ”€ Creating branch: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"

          echo "ğŸ“¦ Committing changes..."
          git add docs/policy/crm/development-standards.md
          git add docs/modules/
          git add MokoStandards.override.tf

          # Create commit message
          printf "Reserve Dolibarr module ID %s for %s\n\n" "$MODULE_ID" "$MODULE_NAME" > /tmp/commit_msg.txt
          printf "Requested by %s\n" "$DEVELOPER" >> /tmp/commit_msg.txt
          printf "Module name %s\n" "$MODULE_NAME" >> /tmp/commit_msg.txt
          printf "Module ID %s\n\n" "$MODULE_ID" >> /tmp/commit_msg.txt
          printf "This PR reserves module ID %s from Moko Consulting range (185051-185099).\n\n" "$MODULE_ID" >> /tmp/commit_msg.txt
          printf "Updates in this PR\n" >> /tmp/commit_msg.txt
          printf -- "- Module registry in docs/policy/crm/development-standards.md\n" >> /tmp/commit_msg.txt
          printf -- "- Module documentation in %s\n" "$DOC_FILE" >> /tmp/commit_msg.txt
          printf -- "- Module README in %s\n" "$README_FILE" >> /tmp/commit_msg.txt
          printf -- "- Module ID reference file\n" >> /tmp/commit_msg.txt
          printf -- "- MokoStandards.override.tf protection\n\n" >> /tmp/commit_msg.txt
          printf "Automated via reserve-dolibarr-module-id workflow.\n" >> /tmp/commit_msg.txt

          git commit -F /tmp/commit_msg.txt

          echo "â¬†ï¸ Pushing branch..."
          git push origin "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: actions/github-script@v8
        id: create_pr
        env:
          MODULE_NAME: ${{ github.event.inputs.module_name }}
          MODULE_ID: ${{ steps.find_id.outputs.module_id }}
          DESCRIPTION: ${{ github.event.inputs.description }}
          DEVELOPER: ${{ github.event.inputs.developer }}
          REPOSITORY: ${{ github.event.inputs.repository }}
          BRANCH_NAME: ${{ steps.commit.outputs.branch_name }}
        with:
          script: |
            const moduleId = process.env.MODULE_ID;
            const moduleName = process.env.MODULE_NAME;
            const description = process.env.DESCRIPTION;
            const developer = process.env.DEVELOPER;
            const repository = process.env.REPOSITORY;
            const branchName = process.env.BRANCH_NAME;

            const title = `Reserve Dolibarr Module ID ${moduleId} for ${moduleName}`;
            const body = `## Module ID Reservation Request

            **Module Name:** ${moduleName}
            **Module ID:** ${moduleId}
            **Description:** ${description}
            **Requested by:** ${developer}
            **Repository:** ${repository}

            ---

            This PR reserves module ID **${moduleId}** from the Moko Consulting reserved range (185051-185099) for the **${moduleName}** module.

            ### Changes
            - âœ… Updated module registry table in \`docs/policy/crm/development-standards.md\`
            - âœ… Created module documentation in \`docs/modules/${moduleName}.md\`
            - âœ… Updated \`MokoStandards.override.tf\` to protect module docs from distribution
            - âœ… Reserved ID: **${moduleId}**
            - âœ… Status: **Reserved**
            - âœ… Conflict detection: Verified ID is available

            ### Next Steps
            1. Review this PR
            2. Approve if the reservation is appropriate
            3. Merge to officially reserve the module ID
            4. If \`push_to_remote\` was enabled, verify \`DOLIBARR_MODULE_ID.txt\` in remote repo

            ### Policy Compliance
            - Follows module ID reservation process per [CRM Development Standards](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/policy/crm/development-standards.md#module-id-reservation-process)
            - Module ID from reserved Moko Consulting range (185051-185099)
            - Module registry documentation created for tracking

            ---

            ğŸ¤– _This PR was automatically created by the [reserve-dolibarr-module-id](.github/workflows/reserve-dolibarr-module-id.yml) workflow._`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: branchName,
              base: 'main'
            });

            console.log(`âœ… Pull request created: ${pr.data.html_url}`);
            core.setOutput('pr_url', pr.data.html_url);
            core.setOutput('pr_number', pr.data.number);

            return pr.data.html_url;

      - name: Add labels to PR
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ steps.create_pr.outputs.pr_number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['dolibarr', 'module-id-reservation', 'automated']
            });

            console.log('âœ… Labels added to PR');

      - name: Validate push_to_remote inputs
        if: ${{ github.event.inputs.push_to_remote == 'true' }}
        env:
          REMOTE_REPO: ${{ github.event.inputs.remote_repository }}
        run: |
          if [ -z "$REMOTE_REPO" ]; then
            echo "âŒ Error: push_to_remote is enabled but remote_repository is not provided!"
            echo "Please provide a valid repository URL in the remote_repository input."
            exit 1
          fi
          echo "âœ… Remote repository validation passed: $REMOTE_REPO"

      - name: Push to remote repository (optional)
        if: ${{ github.event.inputs.push_to_remote == 'true' && github.event.inputs.remote_repository != '' }}
        env:
          MODULE_ID: ${{ steps.find_id.outputs.module_id }}
          MODULE_NAME: ${{ github.event.inputs.module_name }}
          DESCRIPTION: ${{ github.event.inputs.description }}
          REMOTE_REPO: ${{ github.event.inputs.remote_repository }}
        run: |
          echo "ğŸš€ Pushing module ID to remote repository..."

          # Create a temporary directory for the remote repo
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"

          # Clone the remote repository
          echo "ğŸ“¥ Cloning remote repository..."
          git clone "$REMOTE_REPO" repo
          cd repo

          # Configure Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create src directory if it doesn't exist
          mkdir -p src

          # Create DOLIBARR_MODULE_ID.txt file
          MODULE_ID_FILE="src/DOLIBARR_MODULE_ID.txt"

          cat > "$MODULE_ID_FILE" << EOF
          DOLIBARR_MODULE_ID=$MODULE_ID

          This module ID has been officially reserved in MokoStandards.

          Module Name: $MODULE_NAME
          Module ID: $MODULE_ID
          Reserved Range: 185051-185099 (Moko Consulting)
          Description: $DESCRIPTION

          Reserved: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          DO NOT CHANGE THIS ID!

          This ID is registered in the MokoStandards module registry:
          https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/policy/crm/development-standards.md

          For more information, see the module documentation:
          https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/modules/$MODULE_NAME.md
          EOF

          echo "âœ… Created $MODULE_ID_FILE"

          # Also create a template module descriptor
          MODULE_DESCRIPTOR="src/mod${MODULE_NAME}.class.php"

          cat > "$MODULE_DESCRIPTOR" << 'PHPEOF'
          <?php
          /* Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
           * SPDX-License-Identifier: GPL-3.0-or-later
           */

          /**
           * \file       mod%%MODULE_NAME%%.class.php
           * \ingroup    %%MODULE_NAME%%
           * \brief      Module descriptor for %%MODULE_NAME%%
           */

          require_once DOL_DOCUMENT_ROOT.'/core/modules/DolibarrModules.class.php';

          /**
           * Class to describe and enable module %%MODULE_NAME%%
           */
          class mod%%MODULE_NAME%% extends DolibarrModules
          {
              /**
               * Constructor
               *
               * @param DoliDB $db Database handler
               */
              public function __construct($db)
              {
                  global $langs, $conf;

                  parent::__construct($db);

                  // Module identification - RESERVED in MokoStandards
                  // DO NOT CHANGE THIS ID!
                  $this->numero = %%MODULE_ID%%;
                  $this->rights_class = '%%MODULE_RIGHTS_CLASS%%';

                  // Module family
                  $this->family = "mokoconsulting";
                  $this->familyinfo = array(
                      'mokoconsulting' => array(
                          'position' => '01',
                          'label'    => $langs->trans("Moko Consulting")
                      )
                  );

                  $this->module_position = '90';
                  $this->name = preg_replace('/^mod/i', '', get_class($this));
                  $this->description = "%%DESCRIPTION%%";

                  // Author information
                  $this->editor_name = 'Moko Consulting';
                  $this->editor_url = 'https://www.mokoconsulting.tech';

                  $this->version = '1.0.0';
                  $this->const_name = 'MAIN_MODULE_'.strtoupper($this->name);

                  // Dolibarr minimum version
                  $this->need_dolibarr_version = array(15, 0);

                  // Permissions
                  $this->rights = array();
              }
          }
          PHPEOF

          # Replace placeholders in the PHP file
          sed -i "s/%%MODULE_NAME%%/$MODULE_NAME/g" "$MODULE_DESCRIPTOR"
          sed -i "s/%%MODULE_ID%%/$MODULE_ID/g" "$MODULE_DESCRIPTOR"
          sed -i "s/%%MODULE_RIGHTS_CLASS%%/$(echo "$MODULE_NAME" | tr '[:upper:]' '[:lower:]')/g" "$MODULE_DESCRIPTOR"
          sed -i "s/%%DESCRIPTION%%/$DESCRIPTION/g" "$MODULE_DESCRIPTOR"

          echo "âœ… Created template module descriptor: $MODULE_DESCRIPTOR"

          # Create README.md for the remote repository
          README_FILE="README.md"

          cat > "$README_FILE" << 'READMEOF'
          # %%MODULE_NAME%%

          **Dolibarr Module ID: %%MODULE_ID%%**

          %%DESCRIPTION%%

          ## Module ID

          This module has been assigned the official Dolibarr module ID: **%%MODULE_ID%%**

          âš ï¸ **DO NOT CHANGE THIS ID!** It is officially reserved in MokoStandards.

          The module ID is stored in `src/DOLIBARR_MODULE_ID.txt` for reference.

          ## Quick Reference

          - **Module ID:** %%MODULE_ID%%
          - **Module Name:** %%MODULE_NAME%%
          - **Status:** Reserved
          - **Reserved Date:** %%RESERVED_DATE%%
          - **Reserved Range:** 185051-185099 (Moko Consulting)

          ## Installation

          1. Clone this repository
          2. Copy to Dolibarr's `htdocs/custom/%%MODULE_NAME_LOWER%%/` directory
          3. Enable the module in Dolibarr admin interface
          4. Configure module settings as needed

          ## Module Structure

          ```
          %%MODULE_NAME%%/
          â”œâ”€â”€ src/
          â”‚   â”œâ”€â”€ DOLIBARR_MODULE_ID.txt      # Module ID reference (DO NOT MODIFY)
          â”‚   â””â”€â”€ mod%%MODULE_NAME%%.class.php # Module descriptor
          â”œâ”€â”€ class/                           # Business logic classes
          â”œâ”€â”€ langs/                           # Translation files
          â”‚   â”œâ”€â”€ en_US/
          â”‚   â””â”€â”€ fr_FR/
          â”œâ”€â”€ sql/                            # Database scripts
          â”œâ”€â”€ admin/                          # Admin pages
          â””â”€â”€ README.md                       # This file
          ```

          ## Module Information

          This module is part of the Moko Consulting Dolibarr extension suite.

          - **Family:** mokoconsulting
          - **Rights Class:** %%MODULE_RIGHTS_CLASS%%
          - **Module Position:** 90

          ## Development

          ### Module Descriptor

          The module descriptor (`src/mod%%MODULE_NAME%%.class.php`) contains the module configuration with the reserved ID:

          ```php
          $this->numero = %%MODULE_ID%%; // DO NOT CHANGE!
          ```

          ### Important Notes

          - **Never change the module ID!** It is officially registered in MokoStandards
          - The ID is reserved in the range 185051-185099 (Moko Consulting)
          - Changing the ID will cause conflicts and break compatibility

          ## Documentation

          Full module documentation is available in MokoStandards:

          - [Module Registry Entry](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/policy/crm/development-standards.md)
          - [Module Documentation](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/modules/%%MODULE_NAME%%.md)
          - [Dolibarr Development Guide](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/guide/crm/dolibarr-development-guide.md)

          ## Support

          For support or questions:
          - Open an issue in this repository
          - Contact Moko Consulting: hello@mokoconsulting.tech
          - Visit: https://www.mokoconsulting.tech

          ## License

          GPL-3.0-or-later

          Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>

          ---

          **Module ID:** %%MODULE_ID%% | **Reserved:** %%RESERVED_DATE%% | **Moko Consulting**
          READMEOF

          # Replace placeholders in README
          sed -i "s/%%MODULE_NAME%%/$MODULE_NAME/g" "$README_FILE"
          sed -i "s/%%MODULE_ID%%/$MODULE_ID/g" "$README_FILE"
          sed -i "s/%%MODULE_NAME_LOWER%%/$(echo "$MODULE_NAME" | tr '[:upper:]' '[:lower:]')/g" "$README_FILE"
          sed -i "s/%%MODULE_RIGHTS_CLASS%%/$(echo "$MODULE_NAME" | tr '[:upper:]' '[:lower:]')/g" "$README_FILE"
          sed -i "s/%%DESCRIPTION%%/$DESCRIPTION/g" "$README_FILE"
          sed -i "s/%%RESERVED_DATE%%/$(date -u +"%Y-%m-%d")/g" "$README_FILE"

          echo "âœ… Created README.md for remote repository"

          # Commit and push all files
          git add "$MODULE_ID_FILE" "$MODULE_DESCRIPTOR" "$README_FILE"

          # Create commit message for remote repo
          printf "Reserve Dolibarr module ID %s\n\n" "$MODULE_ID" > /tmp/remote_commit.txt
          printf "Module %s\n" "$MODULE_NAME" >> /tmp/remote_commit.txt
          printf "ID %s\n\n" "$MODULE_ID" >> /tmp/remote_commit.txt
          printf "Added files\n" >> /tmp/remote_commit.txt
          printf -- "- src/DOLIBARR_MODULE_ID.txt with reserved module ID\n" >> /tmp/remote_commit.txt
          printf -- "- src/mod%s.class.php template module descriptor\n" "$MODULE_NAME" >> /tmp/remote_commit.txt
          printf -- "- README.md with module ID documentation\n\n" >> /tmp/remote_commit.txt
          printf "This ID has been officially reserved in MokoStandards.\n" >> /tmp/remote_commit.txt
          printf "See https://github.com/mokoconsulting-tech/MokoStandards\n\n" >> /tmp/remote_commit.txt
          printf "DO NOT change the module ID!\n" >> /tmp/remote_commit.txt

          git commit -F /tmp/remote_commit.txt

          # Detect and push to the default branch
          echo "ğŸ“¤ Detecting default branch..."
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)

          if [ -z "$DEFAULT_BRANCH" ]; then
            echo "âš ï¸ Could not detect default branch, trying main then master..."
            DEFAULT_BRANCH="main"
          fi

          echo "Default branch: $DEFAULT_BRANCH"

          if git push origin "$DEFAULT_BRANCH"; then
            echo "âœ… Pushed to $DEFAULT_BRANCH successfully"
          else
            echo "âŒ Failed to push to $DEFAULT_BRANCH"
            echo "Please check if the branch exists and you have push permissions"
            exit 1
          fi

          echo "âœ… Pushed module ID, template, and README to remote repository"

          # Cleanup
          cd /
          rm -rf "$TEMP_DIR"

      - name: Output summary
        env:
          MODULE_NAME: ${{ github.event.inputs.module_name }}
          MODULE_ID: ${{ steps.find_id.outputs.module_id }}
          PR_URL: ${{ steps.create_pr.outputs.pr_url }}
        run: |
          echo "## ğŸ‰ Module ID Reservation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Module Name:** $MODULE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Reserved ID:** $MODULE_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Request:** $PR_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the pull request" >> $GITHUB_STEP_SUMMARY
          echo "2. Get approval from CRM Development Lead" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge the PR to officially reserve the module ID" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by reserve-dolibarr-module-id workflow v04.00.00_" >> $GITHUB_STEP_SUMMARY
