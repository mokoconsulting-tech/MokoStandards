# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.HealthCheck
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/health-check.yml
# VERSION: 04.00.00
# BRIEF: Hourly library health check and circuit breaker testing
# NOTE: Monitors library health and tests circuit breakers using PHP ApiClient

name: Health Check

on:
  schedule:
    # Run hourly
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      test_circuit_breaker:
        description: 'Test circuit breaker functionality'
        required: false
        type: boolean
        default: true
      check_all_libraries:
        description: 'Check all enterprise libraries'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  health-check:
    name: Library Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up PHP
        uses: shivammathur/setup-php@2cb9b829437ee246e9b3cac53555a39208ca6d28 # v2.31.0
        with:
          php-version: '8.1'
          extensions: mbstring, curl, json
          tools: composer

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create Health Check Directory
        run: |
          mkdir -p logs/health
          mkdir -p logs/reports

      - name: Check Library Health
        id: health
        run: |
          echo "## ðŸ¥ Library Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          php << 'EOF'
          <?php
          require_once __DIR__ . '/vendor/autoload.php';

          use MokoStandards\Enterprise\ApiClient;
          use MokoStandards\Enterprise\AuditLogger;
          use MokoStandards\Enterprise\MetricsCollector;
          use MokoStandards\Enterprise\SecurityValidator;
          use MokoStandards\Enterprise\RepositoryHealthChecker;

          $healthStatus = [];
          $failedLibraries = [];

          // Test ApiClient
          try {
              $client = new ApiClient(
                  'https://api.github.com',
                  5000,
                  5,
                  30
              );
              $healthStatus['ApiClient'] = [
                  'status' => 'healthy',
                  'circuit_state' => $client->getCircuitState(),
                  'version' => '04.00.00'
              ];
              echo "âœ… ApiClient: healthy\n";
          } catch (Exception $e) {
              $healthStatus['ApiClient'] = ['status' => 'unhealthy', 'error' => $e->getMessage()];
              $failedLibraries[] = 'ApiClient';
              echo "âŒ ApiClient: " . $e->getMessage() . "\n";
          }

          // Test AuditLogger
          try {
              $logger = new AuditLogger('health_check');
              $healthStatus['AuditLogger'] = [
                  'status' => 'healthy',
                  'version' => '04.00.00'
              ];
              echo "âœ… AuditLogger: healthy\n";
          } catch (Exception $e) {
              $healthStatus['AuditLogger'] = ['status' => 'unhealthy', 'error' => $e->getMessage()];
              $failedLibraries[] = 'AuditLogger';
              echo "âŒ AuditLogger: " . $e->getMessage() . "\n";
          }

          // Test MetricsCollector
          try {
              $metrics = new MetricsCollector('health_check');
              $metrics->increment('health_check_test');
              $healthStatus['MetricsCollector'] = [
                  'status' => 'healthy',
                  'version' => '04.00.00'
              ];
              echo "âœ… MetricsCollector: healthy\n";
          } catch (Exception $e) {
              $healthStatus['MetricsCollector'] = ['status' => 'unhealthy', 'error' => $e->getMessage()];
              $failedLibraries[] = 'MetricsCollector';
              echo "âŒ MetricsCollector: " . $e->getMessage() . "\n";
          }

          // Test SecurityValidator
          try {
              $validator = new SecurityValidator();
              $healthStatus['SecurityValidator'] = [
                  'status' => 'healthy',
                  'version' => '04.00.00'
              ];
              echo "âœ… SecurityValidator: healthy\n";
          } catch (Exception $e) {
              $healthStatus['SecurityValidator'] = ['status' => 'unhealthy', 'error' => $e->getMessage()];
              $failedLibraries[] = 'SecurityValidator';
              echo "âŒ SecurityValidator: " . $e->getMessage() . "\n";
          }

          // Save health report
          file_put_contents('logs/health/health-report.json', json_encode($healthStatus, JSON_PRETTY_PRINT));

          $summary = [
              'total' => count($healthStatus),
              'healthy' => count(array_filter($healthStatus, fn($s) => $s['status'] === 'healthy')),
              'unhealthy' => count($failedLibraries),
              'failed' => $failedLibraries
          ];
          file_put_contents('/tmp/health_summary.json', json_encode($summary));

          if (count($failedLibraries) > 0) {
              exit(1);
          }
          EOF

          # Read summary and output
          if [ -f "/tmp/health_summary.json" ]; then
            SUMMARY=$(cat /tmp/health_summary.json)
            TOTAL=$(echo $SUMMARY | php -r 'echo json_decode(file_get_contents("php://stdin"), true)["total"];')
            HEALTHY=$(echo $SUMMARY | php -r 'echo json_decode(file_get_contents("php://stdin"), true)["healthy"];')
            UNHEALTHY=$(echo $SUMMARY | php -r 'echo json_decode(file_get_contents("php://stdin"), true)["unhealthy"];')

            echo "total_libraries=$TOTAL" >> $GITHUB_OUTPUT
            echo "healthy_count=$HEALTHY" >> $GITHUB_OUTPUT
            echo "unhealthy_count=$UNHEALTHY" >> $GITHUB_OUTPUT

            echo "### Health Status" >> $GITHUB_STEP_SUMMARY
            echo "- Total libraries checked: **${TOTAL}**" >> $GITHUB_STEP_SUMMARY
            echo "- Healthy: **${HEALTHY}** âœ…" >> $GITHUB_STEP_SUMMARY
            echo "- Unhealthy: **${UNHEALTHY}** âŒ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test Circuit Breaker
        if: github.event.inputs.test_circuit_breaker != 'false'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”Œ Circuit Breaker Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          php << 'EOF'
          <?php
          require_once __DIR__ . '/vendor/autoload.php';

          use MokoStandards\Enterprise\ApiClient;

          try {
              // Create test client with low threshold
              $client = new ApiClient(
                  'https://httpbin.org',
                  5000,
                  3,
                  5
              );

              echo "Initial state: " . $client->getCircuitState() . "\n";

              // Simulate failures to trip circuit breaker
              for ($i = 0; $i < 4; $i++) {
                  try {
                      $client->simulateFailure();
                  } catch (Exception $e) {
                      // Expected
                  }
              }

              echo "After simulated failures: " . $client->getCircuitState() . "\n";

              // Verify circuit is open
              if ($client->getCircuitState() === 'OPEN') {
                  echo "âœ… Circuit breaker correctly opened after threshold\n";
              } else {
                  echo "âš ï¸ Circuit breaker did not open as expected\n";
              }

              // Wait for timeout
              echo "Waiting for circuit timeout...\n";
              sleep(6);

              // Check if circuit moved to half-open
              $client->checkCircuitBreaker();
              echo "After timeout: " . $client->getCircuitState() . "\n";

              echo "âœ… Circuit breaker test completed successfully\n";

          } catch (Exception $e) {
              echo "âŒ Circuit breaker test failed: " . $e->getMessage() . "\n";
              exit(1);
          }
          EOF

          echo "âœ… Circuit breaker test passed" >> $GITHUB_STEP_SUMMARY

      - name: Upload Health Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: health-report-${{ github.run_number }}
          path: |
            logs/health/
          retention-days: 7

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Health check failed" >> $GITHUB_STEP_SUMMARY
          echo "One or more libraries are unhealthy" >> $GITHUB_STEP_SUMMARY
