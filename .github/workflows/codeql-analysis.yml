# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Security
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/codeql-analysis.yml
# VERSION: 01.00.00
# BRIEF: CodeQL security scanning workflow for vulnerability detection
# NOTE: Runs on push to main and PRs, weekly scheduled scans

name: "CodeQL Security Scanning"

on:
  push:
    branches: 
      - main
      - dev/**
      - rc/**
  pull_request:
    branches: 
      - main
      - dev/**
      - rc/**
  schedule:
    # Run at 6:00 AM UTC every Monday
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python', 'javascript', 'php' ]
        # CodeQL supports: 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby', 'php'
        # Learn more about CodeQL language support at https://aka.ms/codeql-docs/language-support
        # Note: This repository contains primarily documentation with Python scripts.
        # JavaScript and PHP are included for comprehensive scanning when present.
        # The initialization step is configured with continue-on-error to gracefully handle languages not found.

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Initialize CodeQL
      id: init
      continue-on-error: true
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.
        
        # For more details on CodeQL's query packs, refer to: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
        queries: +security-extended,security-and-quality

    # Autobuild attempts to build any compiled languages  (C/C++, C#, Go, or Java).
    # If this step fails, then you should remove it and run the build manually
    - name: Autobuild
      if: steps.init.outcome == 'success'
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      if: steps.init.outcome == 'success'
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{matrix.language}}"
        upload: true

  php-security-scan:
    name: PHP Security Scanning
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Detect PHP files
      id: detect
      run: |
        if find . -name "*.php" -type f ! -path "*/vendor/*" ! -path "*/.git/*" | head -1 | grep -q .; then
          echo "has_php=true" >> $GITHUB_OUTPUT
          echo "✅ PHP files detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "has_php=false" >> $GITHUB_OUTPUT
          echo "ℹ️ No PHP files detected, skipping PHP security scan" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Setup PHP
      if: steps.detect.outputs.has_php == 'true'
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml
        tools: composer:v2
        coverage: none

    - name: Install PHP security scanning tools
      if: steps.detect.outputs.has_php == 'true'
      run: |
        # Install security checker tools
        composer global require enlightn/security-checker --quiet
        
        # Add composer global bin to PATH
        echo "$HOME/.composer/vendor/bin" >> $GITHUB_PATH

    - name: Check for composer.json
      if: steps.detect.outputs.has_php == 'true'
      id: composer
      run: |
        if [ -f "composer.json" ]; then
          echo "has_composer=true" >> $GITHUB_OUTPUT
        else
          echo "has_composer=false" >> $GITHUB_OUTPUT
        fi

    - name: Install project dependencies
      if: steps.detect.outputs.has_php == 'true' && steps.composer.outputs.has_composer == 'true'
      run: composer install --prefer-dist --no-progress --no-interaction --no-dev

    - name: Run Enlightn Security Checker
      if: steps.detect.outputs.has_php == 'true' && steps.composer.outputs.has_composer == 'true'
      continue-on-error: true
      run: |
        echo "### Enlightn Security Checker Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if security-checker security:check composer.lock --format=json > security-report.json 2>&1; then
          echo "✅ No known security vulnerabilities found in dependencies" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Security vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat security-report.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Run PHPCS security ruleset
      if: steps.detect.outputs.has_php == 'true'
      continue-on-error: true
      run: |
        # Install PHP_CodeSniffer with security standards
        composer global require squizlabs/php_codesniffer --quiet
        composer global require phpcompatibility/php-compatibility --quiet
        composer global require dealerdirect/phpcodesniffer-composer-installer --quiet
        composer global require pheromone/phpcs-security-audit --quiet || true
        
        echo "### PHP Security Code Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run security-focused checks
        if phpcs --standard=Security --report=summary --report-width=120 . 2>/dev/null; then
          echo "✅ No security issues found by PHPCS Security standard" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ Running basic security checks" >> $GITHUB_STEP_SUMMARY
          # Fallback to basic checks
          phpcs --standard=PSR12 --report=summary --report-width=120 . || echo "ℹ️ Basic code style checks completed" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Scan for common PHP vulnerabilities
      if: steps.detect.outputs.has_php == 'true'
      continue-on-error: true
      run: |
        echo "### PHP Vulnerability Pattern Scan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Scanning for common vulnerability patterns..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Scan for common vulnerability patterns
        ISSUES=0
        
        # Check for unsafe functions (with better pattern)
        echo "Checking for unsafe PHP functions..." >> $GITHUB_STEP_SUMMARY
        if grep -rn "\\(eval\\|exec\\|system\\|passthru\\|shell_exec\\|assert\\)\\s*(" --include="*.php" . 2>/dev/null | head -5; then
          echo "⚠️ Found potentially unsafe PHP functions" >> $GITHUB_STEP_SUMMARY
          ISSUES=$((ISSUES + 1))
        fi
        
        # Check for preg_replace with /e modifier (more precise pattern)
        if grep -rn 'preg_replace\s*(\s*["\'"'"'][^"'"'"']*/[^"'"'"']*e' --include="*.php" . 2>/dev/null | head -5; then
          echo "⚠️ Found deprecated preg_replace /e modifier" >> $GITHUB_STEP_SUMMARY
          ISSUES=$((ISSUES + 1))
        fi
        
        # Check for potential SQL injection (basic pattern - may have false positives)
        echo "Checking for potential SQL injection patterns..." >> $GITHUB_STEP_SUMMARY
        if grep -rn '\$_\(GET\|POST\|REQUEST\)\[.*\].*\(mysql_query\|mysqli_query\)' --include="*.php" . 2>/dev/null | grep -v "mysqli_real_escape_string\|prepare" | head -5; then
          echo "⚠️ Found potential SQL injection patterns (review recommended)" >> $GITHUB_STEP_SUMMARY
          ISSUES=$((ISSUES + 1))
        fi
        
        # Check for potential XSS (basic pattern - may have false positives)
        echo "Checking for potential XSS vulnerabilities..." >> $GITHUB_STEP_SUMMARY
        if grep -rn '\(echo\|print\)\s*.*\$_\(GET\|POST\|REQUEST\)' --include="*.php" . 2>/dev/null | grep -v "htmlspecialchars\|htmlentities\|esc_html\|esc_attr" | head -5; then
          echo "⚠️ Found potential XSS vulnerabilities - unescaped output (review recommended)" >> $GITHUB_STEP_SUMMARY
          ISSUES=$((ISSUES + 1))
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ $ISSUES -eq 0 ]; then
          echo "✅ No common vulnerability patterns detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Found $ISSUES potential security issue types" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: These are basic pattern matches and may include false positives." >> $GITHUB_STEP_SUMMARY
          echo "Review the workflow logs for details and validate each finding." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Security scan summary
      if: always() && steps.detect.outputs.has_php == 'true'
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "PHP Security Scan completed. Review the detailed findings above." >> $GITHUB_STEP_SUMMARY
