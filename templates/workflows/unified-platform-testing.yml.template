# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Testing
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /templates/workflows/unified-platform-testing.yml.template
# VERSION: 02.00.00
# BRIEF: Unified Platform Testing workflow for Joomla and Dolibarr
# NOTE: Automatically detects platform and runs appropriate tests
# NOTE: Supports unit tests, integration tests, and code quality checks

name: Unified Platform Testing

on:
  push:
    branches:
      - main
      - dev/**
      - rc/**
  pull_request:
    branches:
      - main
      - dev/**
      - rc/**
  workflow_dispatch:
    inputs:
      platform:
        description: 'Force platform type (auto-detect if not specified)'
        required: false
        type: choice
        options:
          - auto
          - joomla
          - dolibarr
        default: auto

permissions:
  contents: read

jobs:
  detect-platform:
    name: Detect Platform Type
    runs-on: ubuntu-latest
    outputs:
      platform: ${{ steps.detect.outputs.platform }}
      platform-version: ${{ steps.detect.outputs.platform_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Detect platform type
        id: detect
        run: |
          PLATFORM="${{ inputs.platform }}"
          
          if [ "$PLATFORM" = "auto" ] || [ -z "$PLATFORM" ]; then
            # Auto-detect platform
            if [ -f "joomla.xml" ] || find . -maxdepth 2 \( -name "mod_*.xml" -o -name "plg_*.xml" -o -name "com_*.xml" -o -name "pkg_*.xml" -o -name "tpl_*.xml" \) 2>/dev/null | head -1 | grep -q .; then
              PLATFORM="joomla"
              echo "✓ Detected Joomla extension" >> $GITHUB_STEP_SUMMARY
            elif [ -d "htdocs" ] || [ -d "core/modules" ] || ([ -f "composer.json" ] && grep -q "dolibarr" composer.json 2>/dev/null); then
              PLATFORM="dolibarr"
              echo "✓ Detected Dolibarr module" >> $GITHUB_STEP_SUMMARY
            else
              PLATFORM="generic"
              echo "ℹ️ Generic PHP project detected" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "Platform: $PLATFORM" >> $GITHUB_STEP_SUMMARY

  phpunit:
    name: PHPUnit Tests (PHP ${{ matrix.php-version }})
    runs-on: ubuntu-latest
    needs: detect-platform
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    strategy:
      fail-fast: false
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2', '8.3']
        include:
          # Joomla-specific matrix
          - platform-version: '4.4'
            php-version: '7.4'
          - platform-version: '4.4'
            php-version: '8.0'
          - platform-version: '4.4'
            php-version: '8.1'
          - platform-version: '5.0'
            php-version: '8.1'
          - platform-version: '5.0'
            php-version: '8.2'
          - platform-version: '5.0'
            php-version: '8.3'
          # Dolibarr-specific matrix
          - platform-version: '17.0'
            php-version: '7.4'
          - platform-version: '17.0'
            php-version: '8.0'
          - platform-version: '18.0'
            php-version: '8.1'
          - platform-version: '18.0'
            php-version: '8.2'
        exclude:
          # Exclude incompatible combinations based on platform
          - php-version: '7.4'
            platform-version: '5.0'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, mysqli, gd, curl, zip, intl
          coverage: xdebug
          tools: composer:v2

      - name: Validate composer.json
        run: composer validate --strict
        if: hashFiles('composer.json') != ''

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress
        if: hashFiles('composer.json') != ''

      - name: Setup Joomla environment
        if: needs.detect-platform.outputs.platform == 'joomla'
        run: |
          echo "Setting up Joomla ${{ matrix.platform-version }} environment..."
          
          # Download and setup Joomla if needed
          if [ ! -d "tests/joomla" ]; then
            mkdir -p tests/joomla
            # Add Joomla setup commands here
          fi

      - name: Setup Dolibarr environment
        if: needs.detect-platform.outputs.platform == 'dolibarr'
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_USER: root
          MYSQL_PASSWORD: root
          MYSQL_DATABASE: test_db
        run: |
          echo "Setting up Dolibarr ${{ matrix.platform-version }} environment..."
          
          # Download and setup Dolibarr if needed
          if [ ! -d "tests/dolibarr" ]; then
            mkdir -p tests/dolibarr
            # Add Dolibarr setup commands here
          fi

      - name: Run PHPUnit tests
        run: |
          if [ -f "phpunit.xml" ] || [ -f "phpunit.xml.dist" ]; then
            vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml
          else
            echo "No PHPUnit configuration found, skipping tests"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: phpunit
          name: php-${{ matrix.php-version }}
        if: hashFiles('coverage.xml') != ''

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: detect-platform
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml
          tools: composer:v2, phpcs, phpstan, psalm

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress
        if: hashFiles('composer.json') != ''

      - name: PHP CodeSniffer
        run: |
          if [ -f "phpcs.xml" ] || [ -f "phpcs.xml.dist" ]; then
            phpcs --standard=phpcs.xml --report=full --report-file=phpcs-report.txt . || true
            cat phpcs-report.txt
          else
            echo "No PHPCS configuration found"
          fi

      - name: PHPStan
        run: |
          if [ -f "phpstan.neon" ] || [ -f "phpstan.neon.dist" ]; then
            phpstan analyse --error-format=table --no-progress
          else
            echo "No PHPStan configuration found"
          fi

      - name: Psalm
        run: |
          if [ -f "psalm.xml" ] || [ -f "psalm.xml.dist" ]; then
            psalm --show-info=true --output-format=text
          else
            echo "No Psalm configuration found"
          fi

  platform-specific-tests:
    name: Platform-Specific Tests
    runs-on: ubuntu-latest
    needs: detect-platform
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, mysqli, gd, curl, zip, intl

      - name: Joomla manifest validation
        if: needs.detect-platform.outputs.platform == 'joomla'
        run: |
          echo "Validating Joomla manifests..."
          
          # Find and validate XML manifests
          for manifest in $(find . -maxdepth 2 -name "*.xml" -not -path "*/vendor/*" -not -name "phpunit.xml*" -not -name "phpcs.xml*"); do
            echo "Checking $manifest"
            xmllint --noout "$manifest" 2>&1 || exit 1
          done
          
          echo "✓ All manifests are valid"

      - name: Dolibarr module structure validation
        if: needs.detect-platform.outputs.platform == 'dolibarr'
        run: |
          echo "Validating Dolibarr module structure..."
          
          # Check for required Dolibarr files
          if [ ! -d "core" ] && [ ! -d "htdocs" ]; then
            echo "⚠️ Warning: Neither 'core' nor 'htdocs' directory found"
          fi
          
          # Check for module descriptor
          if [ -f "core/modules/modMyModule.class.php" ]; then
            echo "✓ Module descriptor found"
          else
            echo "ℹ️ No standard module descriptor found"
          fi

      - name: Run platform-specific validation scripts
        run: |
          PLATFORM="${{ needs.detect-platform.outputs.platform }}"
          
          # Run platform-specific validation if scripts exist
          if [ -f "scripts/validate/${PLATFORM}_validate.sh" ]; then
            bash "scripts/validate/${PLATFORM}_validate.sh"
          elif [ -f "scripts/validate/${PLATFORM}_validate.py" ]; then
            python3 "scripts/validate/${PLATFORM}_validate.py"
          else
            echo "No platform-specific validation scripts found"
          fi

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-platform, phpunit]
    if: needs.detect-platform.outputs.platform != 'generic'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: integration_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, mysqli, gd, curl, zip, intl

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress
        if: hashFiles('composer.json') != ''

      - name: Run integration tests
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_USER: root
          MYSQL_PASSWORD: root
          MYSQL_DATABASE: integration_test
          PLATFORM: ${{ needs.detect-platform.outputs.platform }}
        run: |
          if [ -d "tests/integration" ]; then
            echo "Running integration tests for $PLATFORM..."
            vendor/bin/phpunit --testsuite integration || echo "No integration test suite configured"
          else
            echo "No integration tests directory found"
          fi

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-platform, phpunit, code-quality, platform-specific-tests]
    if: always()
    
    steps:
      - name: Generate test summary
        run: |
          echo "# Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: ${{ needs.detect-platform.outputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- PHPUnit Tests: ${{ needs.phpunit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Platform Tests: ${{ needs.platform-specific-tests.result }}" >> $GITHUB_STEP_SUMMARY
