# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.AuditLogArchival
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/audit-log-archival.yml
# VERSION: 04.00.03
# BRIEF: Weekly audit log archival and compliance report generation
# NOTE: Archives audit logs and generates compliance reports using PHP AuditLogger

name: Audit Log Archival

on:
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Days to retain audit logs'
        required: false
        type: number
        default: 90
      generate_report:
        description: 'Generate compliance report'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  archive-audit-logs:
    name: Archive Audit Logs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.31.0
        with:
          php-version: '8.1'
          extensions: mbstring, curl, json
          tools: composer

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create Archive Directory
        run: |
          mkdir -p logs/audit/archive
          mkdir -p logs/reports

      - name: Archive Audit Logs
        id: archive
        run: |
          echo "## ðŸ“¦ Audit Log Archival" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RETENTION_DAYS="${{ github.event.inputs.retention_days || 90 }}"

          php << 'EOF'
          <?php
          require_once __DIR__ . '/vendor/autoload.php';

          use MokoStandards\Enterprise\AuditLogger;

          try {
              // Initialize audit logger
              $logger = new AuditLogger('audit_archival', 'logs/audit');
              $retentionDays = (int)'${{ github.event.inputs.retention_days || 90 }}';

              // Archive old logs
              $transaction = $logger->startTransaction('archive_logs');
              $archivedCount = $logger->rotateLogs($retentionDays);
              $transaction->logEvent('logs_archived', [
                  'count' => $archivedCount,
                  'retention_days' => $retentionDays
              ]);
              $transaction->commit();

              echo "âœ… Successfully archived {$archivedCount} log files\n";
              file_put_contents('/tmp/archive_output.txt', "archive_count={$archivedCount}");

          } catch (Exception $e) {
              echo "âŒ Archival failed: " . $e->getMessage() . "\n";
              exit(1);
          }
          EOF

          ARCHIVE_COUNT=$(grep archive_count /tmp/archive_output.txt | cut -d= -f2)
          echo "archive_count=$ARCHIVE_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… Archived **${ARCHIVE_COUNT}** log files" >> $GITHUB_STEP_SUMMARY

      - name: Generate Compliance Report
        if: github.event.inputs.generate_report != 'false'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Compliance Report Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          php << 'EOF'
          <?php
          require_once __DIR__ . '/vendor/autoload.php';

          use MokoStandards\Enterprise\AuditLogger;

          try {
              $logger = new AuditLogger('compliance_report', 'logs/audit');

              // Generate compliance report for last 7 days
              $endDate = new DateTime();
              $startDate = (clone $endDate)->modify('-7 days');

              $report = $logger->generateComplianceReport(
                  $startDate,
                  $endDate,
                  'logs/reports/compliance-report.json'
              );

              echo "âœ… Compliance report generated\n";
              echo "Report period: " . $startDate->format('Y-m-d') . " to " . $endDate->format('Y-m-d') . "\n";
              echo "Total events: " . ($report['total_events'] ?? 0) . "\n";
              echo "Security events: " . ($report['security_events'] ?? 0) . "\n";

          } catch (Exception $e) {
              echo "âš ï¸ Report generation failed: " . $e->getMessage() . "\n";
              // Don't fail the job if report generation fails
          }
          EOF

          if [ -f "logs/reports/compliance-report.json" ]; then
            echo "âœ… Compliance report generated successfully" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Archive Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.5.0
        with:
          name: audit-archive-report-${{ github.run_number }}
          path: |
            logs/audit/archive/
            logs/reports/compliance-report.json
          retention-days: 90

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Audit log archival failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
