# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/sync_docs_to_project.yml
# VERSION: 01.00.00
# BRIEF: Automatically sync created/updated docs and templates to GitHub Project
# NOTE: Creates or updates project tasks when files are added or modified

name: Sync Docs to Project

on:
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Specific file or folder path to sync'
        required: false
        type: string
      project_number:
        description: 'Project number to sync to'
        required: false
        default: '7'
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  sync-to-project:
    name: Sync Files to Project
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      
      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y)
      
      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      
      - name: Sync specific path (manual trigger)
        if: github.event.inputs.file_path != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Syncing specific path: ${{ github.event.inputs.file_path }}"
          
          # Make script executable
          chmod +x scripts/sync_file_to_project.py
          
          FILE_PATH="${{ github.event.inputs.file_path }}"
          PROJECT_NUM="${{ github.event.inputs.project_number }}"
          
          if [ -f "$FILE_PATH" ]; then
            python3 scripts/sync_file_to_project.py "$FILE_PATH" "$PROJECT_NUM"
          elif [ -d "$FILE_PATH" ]; then
            python3 scripts/sync_file_to_project.py "$FILE_PATH" "$PROJECT_NUM" --folder
          else
            echo "Error: Path does not exist: $FILE_PATH"
            exit 1
          fi
      
      - name: Summary
        if: always()
        run: |
          {
            echo "### Sync to Project Summary"
            echo ""
            echo "- Event: ${{ github.event_name }}"
            echo "- Repository: ${{ github.repository }}"
            echo "- Branch: ${{ github.ref_name }}"
            
            if [ -n "${{ github.event.inputs.file_path }}" ]; then
              echo "- Path synced: ${{ github.event.inputs.file_path }}"
            fi
            
            echo ""
            echo "Tasks have been created or updated in Project #${{ github.event.inputs.project_number }}"
          } >> "$GITHUB_STEP_SUMMARY"
