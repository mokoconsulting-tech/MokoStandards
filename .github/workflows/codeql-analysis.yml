# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Security
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/codeql-analysis.yml
# VERSION: 01.01.00
# BRIEF: CodeQL security scanning workflow for vulnerability detection
# NOTE: Runs on push to main and PRs, weekly scheduled scans. Automatically detects supported languages.

name: "CodeQL Security Scanning"

on:
  push:
    branches: 
      - main
      - dev/**
      - rc/**
  pull_request:
    branches: 
      - main
      - dev/**
      - rc/**
  schedule:
    # Run at 6:00 AM UTC every Monday
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  detect-languages:
    name: Detect Languages
    runs-on: ubuntu-latest
    outputs:
      has-python: ${{ steps.detect.outputs.has-python }}
      has-javascript: ${{ steps.detect.outputs.has-javascript }}
      has-php: ${{ steps.detect.outputs.has-php }}
      languages: ${{ steps.detect.outputs.languages }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Detect Languages
        id: detect
        run: |
          # Detect Python files
          if find . -type f -name "*.py" \
            -not -path "./node_modules/*" \
            -not -path "./vendor/*" \
            -not -path "./.git/*" \
            -not -path "./build/*" \
            -not -path "./dist/*" \
            | grep -q .; then
            echo "has-python=true" >> $GITHUB_OUTPUT
            echo "âœ“ Python files detected"
            LANGUAGES="python"
          else
            echo "has-python=false" >> $GITHUB_OUTPUT
            echo "âœ— No Python files detected"
            LANGUAGES=""
          fi
          
          # Detect JavaScript/TypeScript files
          if find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) \
            -not -path "./node_modules/*" \
            -not -path "./vendor/*" \
            -not -path "./.git/*" \
            -not -path "./build/*" \
            -not -path "./dist/*" \
            | grep -q .; then
            echo "has-javascript=true" >> $GITHUB_OUTPUT
            echo "âœ“ JavaScript/TypeScript files detected"
            if [ -n "$LANGUAGES" ]; then
              LANGUAGES="$LANGUAGES, javascript"
            else
              LANGUAGES="javascript"
            fi
          else
            echo "has-javascript=false" >> $GITHUB_OUTPUT
            echo "âœ— No JavaScript/TypeScript files detected"
          fi
          
          # Detect PHP files
          if find . -type f -name "*.php" \
            -not -path "./node_modules/*" \
            -not -path "./vendor/*" \
            -not -path "./.git/*" \
            -not -path "./build/*" \
            -not -path "./dist/*" \
            | grep -q .; then
            echo "has-php=true" >> $GITHUB_OUTPUT
            echo "âœ“ PHP files detected"
            if [ -n "$LANGUAGES" ]; then
              LANGUAGES="$LANGUAGES, php"
            else
              LANGUAGES="php"
            fi
          else
            echo "has-php=false" >> $GITHUB_OUTPUT
            echo "âœ— No PHP files detected"
          fi
          
          # Output detected languages
          if [ -z "$LANGUAGES" ]; then
            echo "languages=" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ No supported languages detected for CodeQL analysis"
            echo "    Supported: Python (.py), JavaScript/TypeScript (.js, .ts, .jsx, .tsx), PHP (.php)"
          else
            echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“Š Languages detected for CodeQL analysis: $LANGUAGES"
          fi
      
      - name: Summary
        run: |
          echo "## CodeQL Language Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detect.outputs.languages }}" == "" ]; then
            echo "âš ï¸ **No supported languages detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "CodeQL analysis will be skipped as no supported language files were found." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Detected languages:** ${{ steps.detect.outputs.languages }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "CodeQL security analysis will run for the detected languages." >> $GITHUB_STEP_SUMMARY
          fi

  analyze:
    name: CodeQL Analysis (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: detect-languages
    # Only run if at least one supported language is detected
    if: |
      needs.detect-languages.outputs.languages != '' &&
      (
        (matrix.language == 'python' && needs.detect-languages.outputs.has-python == 'true') ||
        (matrix.language == 'javascript' && needs.detect-languages.outputs.has-javascript == 'true') ||
        (matrix.language == 'php' && needs.detect-languages.outputs.has-php == 'true')
      )
    
    strategy:
      fail-fast: false
      matrix:
        # Attempt to analyze all possible languages; actual execution is controlled by the if condition
        # CodeQL supports: 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby', 'php'
        # This workflow automatically detects Python, JavaScript/TypeScript, and PHP
        language: ['python', 'javascript', 'php']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.
        
        # For more details on CodeQL's query packs, refer to: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
        queries: +security-extended,security-and-quality

    # Autobuild attempts to build any compiled languages  (C/C++, C#, Go, or Java).
    # If this step fails, then you should remove it and run the build manually
    - name: Autobuild
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{matrix.language}}"
        upload: true
