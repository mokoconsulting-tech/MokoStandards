# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# FILE INFORMATION
# DEFGROUP: GitHub.WorkflowTemplate
# INGROUP: MokoStandards.Quality
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflow-templates/code-quality.yml
# VERSION: 01.00.00
# BRIEF: Multi-language code quality and linting workflow
# NOTE: Supports PHP, JavaScript/TypeScript, Python, and HTML5 validation

name: Code Quality

on:
  push:
    branches:
      - main
      - dev/**
      - rc/**
  pull_request:
    branches:
      - main
      - dev/**
      - rc/**
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  detect-languages:
    name: Detect Project Languages
    runs-on: ubuntu-latest
    outputs:
      has-php: ${{ steps.detect.outputs.has-php }}
      has-javascript: ${{ steps.detect.outputs.has-javascript }}
      has-python: ${{ steps.detect.outputs.has-python }}
      has-html: ${{ steps.detect.outputs.has-html }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Detect Languages
        id: detect
        run: |
          # Detect PHP
          if find . -name "*.php" -type f ! -path "./vendor/*" | head -1 | grep -q .; then
            echo "has-php=true" >> $GITHUB_OUTPUT
          else
            echo "has-php=false" >> $GITHUB_OUTPUT
          fi
          
          # Detect JavaScript/TypeScript
          if find . \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) -type f ! -path "./node_modules/*" ! -path "./vendor/*" | head -1 | grep -q .; then
            echo "has-javascript=true" >> $GITHUB_OUTPUT
          else
            echo "has-javascript=false" >> $GITHUB_OUTPUT
          fi
          
          # Detect Python
          if find . -name "*.py" -type f ! -path "./.venv/*" ! -path "./venv/*" | head -1 | grep -q .; then
            echo "has-python=true" >> $GITHUB_OUTPUT
          else
            echo "has-python=false" >> $GITHUB_OUTPUT
          fi
          
          # Detect HTML
          if find . -name "*.html" -type f ! -path "./node_modules/*" ! -path "./vendor/*" | head -1 | grep -q .; then
            echo "has-html=true" >> $GITHUB_OUTPUT
          else
            echo "has-html=false" >> $GITHUB_OUTPUT
          fi

  php-quality:
    name: PHP Code Quality
    runs-on: ubuntu-latest
    needs: detect-languages
    if: needs.detect-languages.outputs.has-php == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml
          tools: composer:v2, phpcs, phpstan, psalm
          coverage: none
      
      - name: Install Dependencies
        if: hashFiles('composer.json') != ''
        run: composer install --prefer-dist --no-progress --no-suggest
      
      - name: PHP_CodeSniffer
        run: |
          echo "### PHP_CodeSniffer Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "phpcs.xml" ] || [ -f "phpcs.xml.dist" ]; then
            phpcs --standard=phpcs.xml --report=summary --report-width=120 || echo "âš ï¸ PHPCS found issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No phpcs.xml configuration found, using PSR12" >> $GITHUB_STEP_SUMMARY
            phpcs --standard=PSR12 --report=summary --report-width=120 . || echo "âš ï¸ PHPCS found issues" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: PHPStan
        run: |
          echo "### PHPStan Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "phpstan.neon" ] || [ -f "phpstan.neon.dist" ]; then
            phpstan analyse --no-progress --error-format=github || echo "âš ï¸ PHPStan found issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No phpstan.neon configuration found, skipping" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Psalm
        if: hashFiles('psalm.xml') != '' || hashFiles('psalm.xml.dist') != ''
        run: |
          echo "### Psalm Results" >> $GITHUB_STEP_SUMMARY
          psalm --show-info=true --output-format=github || echo "âš ï¸ Psalm found issues" >> $GITHUB_STEP_SUMMARY

  javascript-quality:
    name: JavaScript/TypeScript Quality
    runs-on: ubuntu-latest
    needs: detect-languages
    if: needs.detect-languages.outputs.has-javascript == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        if: hashFiles('package.json') != ''
        run: npm ci || npm install
      
      - name: ESLint
        run: |
          echo "### ESLint Results" >> $GITHUB_STEP_SUMMARY
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.yml" ]; then
            npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0 || echo "âš ï¸ ESLint found issues" >> $GITHUB_STEP_SUMMARY
          elif command -v eslint &> /dev/null; then
            npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0 || echo "âš ï¸ ESLint found issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ ESLint not configured, skipping" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Prettier Check
        run: |
          echo "### Prettier Results" >> $GITHUB_STEP_SUMMARY
          if [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]; then
            npx prettier --check . || echo "âš ï¸ Prettier found formatting issues" >> $GITHUB_STEP_SUMMARY
          elif command -v prettier &> /dev/null; then
            npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}" || echo "âš ï¸ Prettier found formatting issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Prettier not configured, skipping" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: TypeScript Check
        if: hashFiles('tsconfig.json') != ''
        run: |
          echo "### TypeScript Results" >> $GITHUB_STEP_SUMMARY
          npx tsc --noEmit || echo "âš ï¸ TypeScript found type errors" >> $GITHUB_STEP_SUMMARY

  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    needs: detect-languages
    if: needs.detect-languages.outputs.has-python == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
      
      - name: Install Quality Tools
        run: |
          python -m pip install --upgrade pip
          pip install pylint black mypy isort
      
      - name: Install Dependencies
        if: hashFiles('requirements.txt') != '' || hashFiles('setup.py') != '' || hashFiles('pyproject.toml') != ''
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          elif [ -f "setup.py" ]; then
            pip install -e .
          elif [ -f "pyproject.toml" ]; then
            pip install -e .
          fi
      
      - name: Black Format Check
        run: |
          echo "### Black Results" >> $GITHUB_STEP_SUMMARY
          black --check --diff . || echo "âš ï¸ Black found formatting issues" >> $GITHUB_STEP_SUMMARY
      
      - name: isort Import Check
        run: |
          echo "### isort Results" >> $GITHUB_STEP_SUMMARY
          isort --check-only --diff . || echo "âš ï¸ isort found import sorting issues" >> $GITHUB_STEP_SUMMARY
      
      - name: Pylint
        run: |
          echo "### Pylint Results" >> $GITHUB_STEP_SUMMARY
          if [ -f ".pylintrc" ] || [ -f "pylintrc" ]; then
            pylint **/*.py || echo "âš ï¸ Pylint found issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No pylintrc configuration found, skipping" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: mypy Type Check
        run: |
          echo "### mypy Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "pyproject.toml" ] || [ -f "mypy.ini" ]; then
            mypy . || echo "âš ï¸ mypy found type issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No mypy configuration found, skipping" >> $GITHUB_STEP_SUMMARY
          fi

  html-validation:
    name: HTML5 Validation
    runs-on: ubuntu-latest
    needs: detect-languages
    if: needs.detect-languages.outputs.has-html == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install HTMLHint
        run: npm install -g htmlhint
      
      - name: HTML Validation
        run: |
          echo "### HTMLHint Results" >> $GITHUB_STEP_SUMMARY
          if [ -f ".htmlhintrc" ]; then
            htmlhint "**/*.html" || echo "âš ï¸ HTMLHint found issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No .htmlhintrc configuration found, using defaults" >> $GITHUB_STEP_SUMMARY
            htmlhint "**/*.html" || echo "âš ï¸ HTMLHint found issues" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Quality Check Summary
    runs-on: ubuntu-latest
    needs: [detect-languages, php-quality, javascript-quality, python-quality, html-validation]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Languages Detected:" >> $GITHUB_STEP_SUMMARY
          echo "- PHP: ${{ needs.detect-languages.outputs.has-php }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript/TypeScript: ${{ needs.detect-languages.outputs.has-javascript }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python: ${{ needs.detect-languages.outputs.has-python }}" >> $GITHUB_STEP_SUMMARY
          echo "- HTML: ${{ needs.detect-languages.outputs.has-html }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quality Check Results:" >> $GITHUB_STEP_SUMMARY
          echo "- PHP Quality: ${{ needs.php-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript Quality: ${{ needs.javascript-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Quality: ${{ needs.python-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Validation: ${{ needs.html-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š Configuration templates: https://github.com/mokoconsulting-tech/MokoStandards/tree/main/templates/configs" >> $GITHUB_STEP_SUMMARY

# CUSTOMIZATION GUIDE:
#
# 1. **Adjust Quality Standards**: Modify linter configurations for your project
# 2. **Add Language-Specific Tools**: Extend jobs for additional languages
# 3. **Configure Auto-Fixing**: Add steps to auto-fix and commit formatting issues
# 4. **Set Failure Thresholds**: Control when checks should fail vs. warn
# 5. **Add Coverage Requirements**: Integrate code coverage checks
