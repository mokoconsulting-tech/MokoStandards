# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.AuditLogArchival
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/audit-log-archival.yml
# VERSION: 03.02.00
# BRIEF: Weekly audit log archival and compliance report generation
# NOTE: Archives audit logs and generates compliance reports using enterprise_audit.py

name: Audit Log Archival

on:
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Days to retain audit logs'
        required: false
        type: number
        default: 90
      generate_report:
        description: 'Generate compliance report'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  archive-audit-logs:
    name: Archive Audit Logs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2


      - name: Create Archive Directory
        run: |
          mkdir -p logs/audit/archive
          mkdir -p logs/reports

      - name: Archive Audit Logs
        id: archive
        run: |
          echo "## ðŸ“¦ Audit Log Archival" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RETENTION_DAYS="${{ github.event.inputs.retention_days || 90 }}"

          python3 << 'EOF'
          import sys
          import json
          from pathlib import Path
          sys.path.insert(0, 'scripts/lib')

          from enterprise_audit import AuditLogger

          try:
              # Initialize audit logger
              logger = AuditLogger(
                  service='audit_archival',
                  log_dir=Path('logs/audit'),
                  retention_days=int('${{ github.event.inputs.retention_days || 90 }}')
              )

              # Archive old logs
              with logger.transaction('archive_logs') as txn:
                  archived_count = logger.rotate_logs()
                  txn.log_event('logs_archived', {
                      'count': archived_count,
                      'retention_days': int('${{ github.event.inputs.retention_days || 90 }}')
                  })

              print(f"âœ… Successfully archived {archived_count} log files")
              print(f"archive_count={archived_count}", file=open('/tmp/archive_output.txt', 'w'))

          except Exception as e:
              print(f"âŒ Archival failed: {e}")
              sys.exit(1)
          EOF

          ARCHIVE_COUNT=$(grep archive_count /tmp/archive_output.txt | cut -d= -f2)
          echo "archive_count=$ARCHIVE_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… Archived **${ARCHIVE_COUNT}** log files" >> $GITHUB_STEP_SUMMARY

      - name: Generate Compliance Report
        if: github.event.inputs.generate_report != 'false'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Compliance Report Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          python3 << 'EOF'
          import sys
          import json
          from pathlib import Path
          from datetime import datetime, timedelta
          sys.path.insert(0, 'scripts/lib')

          from enterprise_audit import AuditLogger

          try:
              logger = AuditLogger(
                  service='compliance_report',
                  log_dir=Path('logs/audit')
              )

              # Generate compliance report for last 7 days
              end_date = datetime.now()
              start_date = end_date - timedelta(days=7)

              report = logger.generate_compliance_report(
                  start_date=start_date,
                  end_date=end_date,
                  output_file=Path('logs/reports/compliance-report.json')
              )

              print(f"âœ… Compliance report generated")
              print(f"Report period: {start_date.date()} to {end_date.date()}")
              print(f"Total events: {report.get('total_events', 0)}")
              print(f"Security events: {report.get('security_events', 0)}")

          except Exception as e:
              print(f"âš ï¸ Report generation failed: {e}")
              # Don't fail the job if report generation fails
          EOF

          if [ -f "logs/reports/compliance-report.json" ]; then
            echo "âœ… Compliance report generated successfully" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Archive Report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.5.0
        with:
          name: audit-archive-report-${{ github.run_number }}
          path: |
            logs/audit/archive/
            logs/reports/compliance-report.json
          retention-days: 90

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Audit log archival failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
