# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Maintenance
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/repository-cleanup.yml
# VERSION: 03.01.02
# BRIEF: Automated cleanup workflow - comprehensive repository maintenance
# NOTE: Runs monthly on 1st by default, can be triggered manually

name: Repository Cleanup

# MokoStandards Policy Compliance:
# - Repository cleanup: Comprehensive automated maintenance
# - Log retention: Enforces 30-day retention policy per logs/README.md
# - Cache cleanup: Removes old GitHub Actions cache entries
# - Build artifacts: Cleans temporary build outputs
# - Reference: logs/README.md (Log Retention section)

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW FLOW DIAGRAM                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER: Monthly (1st) OR manual dispatch
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Clean GitHub    â”‚
#   â”‚  Actions cache   â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Clean Python    â”‚
#   â”‚  cache files     â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Clean build     â”‚
#   â”‚  artifacts       â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Clean editor    â”‚
#   â”‚  temp files      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Clean PHP       â”‚
#   â”‚  cache files     â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Clean test      â”‚
#   â”‚  artifacts       â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Find log files  â”‚
#   â”‚  older than N    â”‚
#   â”‚  days (default   â”‚
#   â”‚  30)             â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Compress logs   â”‚
#   â”‚  7-30 days old   â”‚
#   â”‚  (*.log.gz)      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Delete *.log    â”‚
#   â”‚  files older     â”‚
#   â”‚  than retention  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Delete *.log.gz â”‚
#   â”‚  files older     â”‚
#   â”‚  than 90 days    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Generate        â”‚
#   â”‚  cleanup report  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  # Run monthly on the 1st at 02:00 UTC
  schedule:
    - cron: '0 2 1 * *'  # 1st of each month

  # Allow manual trigger with configurable retention
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to retain uncompressed logs (default: 30)'
        required: false
        default: '30'
        type: number
      compress_days:
        description: 'Compress logs older than N days (default: 7)'
        required: false
        default: '7'
        type: number
      archive_retention_days:
        description: 'Delete compressed logs older than N days (default: 90)'
        required: false
        default: '90'
        type: number
      dry_run:
        description: 'Perform dry run without deleting files'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write  # Required to delete cache entries

jobs:
  cleanup-repository:
    name: Repository Cleanup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set Cleanup Parameters
        id: params
        run: |
          # Set retention parameters
          # Use inputs if triggered manually, otherwise use defaults
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RETENTION="${{ inputs.retention_days }}"
            COMPRESS="${{ inputs.compress_days }}"
            ARCHIVE="${{ inputs.archive_retention_days }}"
            DRYRUN="${{ inputs.dry_run }}"
          else
            RETENTION="30"
            COMPRESS="7"
            ARCHIVE="90"
            DRYRUN="false"
          fi

          echo "retention_days=$RETENTION" >> $GITHUB_OUTPUT
          echo "compress_days=$COMPRESS" >> $GITHUB_OUTPUT
          echo "archive_retention_days=$ARCHIVE" >> $GITHUB_OUTPUT
          echo "dry_run=$DRYRUN" >> $GITHUB_OUTPUT

      - name: Clean GitHub Actions Cache
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "## ðŸ—„ï¸ GitHub Actions Cache Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get list of caches
          CACHE_LIST=$(gh cache list --repo "$REPO" --json key,createdAt \
            --limit 1000 2>/dev/null || echo "[]")

          if [ "$CACHE_LIST" = "[]" ] || [ -z "$CACHE_LIST" ]; then
            echo "â„¹ï¸ No caches found or unable to list caches." \
              >> $GITHUB_STEP_SUMMARY
          else
            # Calculate date 7 days ago (in seconds since epoch)
            CUTOFF_DATE=$(date -u -d '7 days ago' +%s 2>/dev/null || \
              date -u -v-7d +%s 2>/dev/null)

            TOTAL_COUNT=$(echo "$CACHE_LIST" | jq 'length')
            echo "Found $TOTAL_COUNT cache entries" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Use temp file for counting (avoids subshell scope issues)
            TEMP_COUNT_FILE=$(mktemp)
            echo "0" > "$TEMP_COUNT_FILE"

            # Process each cache entry using null-separated output
            echo "$CACHE_LIST" | jq -r '.[] | @base64' | while read -r ENTRY; do
              # Decode the base64 entry
              DECODED=$(echo "$ENTRY" | base64 -d)
              KEY=$(echo "$DECODED" | jq -r '.key')
              CREATED_AT=$(echo "$DECODED" | jq -r '.createdAt')

              # Extract just the date part (handles various ISO formats)
              # Strip milliseconds and timezone, convert to epoch
              CLEAN_DATE=$(echo "$CREATED_AT" | \
                sed 's/\.[0-9]*Z$/Z/' | sed 's/+00:00$/Z/')
              CACHE_DATE=$(date -u -d "$CLEAN_DATE" +%s 2>/dev/null || \
                date -j -u -f "%Y-%m-%dT%H:%M:%SZ" "$CLEAN_DATE" +%s 2>/dev/null)

              if [ -n "$CACHE_DATE" ] && \
                 [ "$CACHE_DATE" -lt "$CUTOFF_DATE" ]; then
                if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
                  echo "Would delete: $KEY (created: $CREATED_AT)"
                  CURRENT=$(cat "$TEMP_COUNT_FILE")
                  echo $((CURRENT + 1)) > "$TEMP_COUNT_FILE"
                else
                  if gh cache delete "$KEY" --repo "$REPO" 2>/dev/null; then
                    echo "Deleted: $KEY (created: $CREATED_AT)"
                    CURRENT=$(cat "$TEMP_COUNT_FILE")
                    echo $((CURRENT + 1)) > "$TEMP_COUNT_FILE"
                  fi
                fi
              fi
            done

            # Read final count from temp file
            DELETED_COUNT=$(cat "$TEMP_COUNT_FILE")
            rm -f "$TEMP_COUNT_FILE"

            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $DELETED_COUNT cache(s)" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Deleted $DELETED_COUNT old cache(s)" \
                >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Clean Python Cache Files
        run: |
          echo "## ðŸ Python Cache Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DRY_RUN="${{ steps.params.outputs.dry_run }}"
          CLEANED=0

          # Clean __pycache__ directories
          PYCACHE_DIRS=$(find . -type d -name "__pycache__" 2>/dev/null)
          if [ -n "$PYCACHE_DIRS" ]; then
            COUNT=$(echo "$PYCACHE_DIRS" | wc -l)
            echo "Found $COUNT __pycache__ directories" >> $GITHUB_STEP_SUMMARY
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $COUNT directories" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "$PYCACHE_DIRS" | xargs rm -rf 2>/dev/null || true
              CLEANED=$((CLEANED + COUNT))
            fi
          fi

          # Clean .pyc files
          PYC_FILES=$(find . -type f -name "*.pyc" 2>/dev/null)
          if [ -n "$PYC_FILES" ]; then
            COUNT=$(echo "$PYC_FILES" | wc -l)
            echo "Found $COUNT .pyc files" >> $GITHUB_STEP_SUMMARY
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $COUNT files" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "$PYC_FILES" | xargs rm -f 2>/dev/null || true
              CLEANED=$((CLEANED + COUNT))
            fi
          fi

          # Clean pytest cache
          PYTEST_DIRS=$(find . -type d -name ".pytest_cache" 2>/dev/null)
          if [ -n "$PYTEST_DIRS" ]; then
            COUNT=$(echo "$PYTEST_DIRS" | wc -l)
            echo "Found $COUNT .pytest_cache directories" >> $GITHUB_STEP_SUMMARY
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $COUNT directories" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "$PYTEST_DIRS" | xargs rm -rf 2>/dev/null || true
              CLEANED=$((CLEANED + COUNT))
            fi
          fi

          # Clean other Python caches
          for CACHE_DIR in ".mypy_cache" ".ruff_cache" ".tox" ".nox"; do
            CACHE_FOUND=$(find . -type d -name "$CACHE_DIR" 2>/dev/null)
            if [ -n "$CACHE_FOUND" ]; then
              COUNT=$(echo "$CACHE_FOUND" | wc -l)
              echo "Found $COUNT $CACHE_DIR directories" >> $GITHUB_STEP_SUMMARY
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” **Dry run** - Would delete $COUNT directories" \
                  >> $GITHUB_STEP_SUMMARY
              else
                echo "$CACHE_FOUND" | xargs rm -rf 2>/dev/null || true
                CLEANED=$((CLEANED + COUNT))
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" = "false" ] && [ $CLEANED -gt 0 ]; then
            echo "âœ… Cleaned $CLEANED Python cache items" >> $GITHUB_STEP_SUMMARY
          elif [ $CLEANED -eq 0 ]; then
            echo "âœ… No Python cache files found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Clean Build Artifacts
        run: |
          echo "## ðŸ—ï¸ Build Artifacts Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DRY_RUN="${{ steps.params.outputs.dry_run }}"
          CLEANED=0

          # Clean build directories
          for BUILD_DIR in ".cache" "build" "dist" "out" "site" \
                            ".mkdocs-build" ".parcel-cache"; do
            BUILD_FOUND=$(find . -maxdepth 2 -type d -name "$BUILD_DIR" 2>/dev/null)
            if [ -n "$BUILD_FOUND" ]; then
              COUNT=$(echo "$BUILD_FOUND" | wc -l)
              echo "Found $COUNT $BUILD_DIR directories" >> $GITHUB_STEP_SUMMARY
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” **Dry run** - Would delete $COUNT directories" \
                  >> $GITHUB_STEP_SUMMARY
              else
                echo "$BUILD_FOUND" | xargs rm -rf 2>/dev/null || true
                CLEANED=$((CLEANED + COUNT))
              fi
            fi
          done

          # Clean .tsbuildinfo files
          TSB_FILES=$(find . -type f -name "*.tsbuildinfo" 2>/dev/null)
          if [ -n "$TSB_FILES" ]; then
            COUNT=$(echo "$TSB_FILES" | wc -l)
            echo "Found $COUNT .tsbuildinfo files" >> $GITHUB_STEP_SUMMARY
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $COUNT files" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "$TSB_FILES" | xargs rm -f 2>/dev/null || true
              CLEANED=$((CLEANED + COUNT))
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" = "false" ] && [ $CLEANED -gt 0 ]; then
            echo "âœ… Cleaned $CLEANED build artifacts" >> $GITHUB_STEP_SUMMARY
          elif [ $CLEANED -eq 0 ]; then
            echo "âœ… No build artifacts found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Clean Editor Temp Files
        run: |
          echo "## ðŸ“ Editor Temp Files Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DRY_RUN="${{ steps.params.outputs.dry_run }}"
          CLEANED=0

          # Clean various temp file types
          for EXT in "bak" "swp" "swo" "tmp"; do
            TEMP_FILES=$(find . -type f -name "*.$EXT" 2>/dev/null)
            if [ -n "$TEMP_FILES" ]; then
              COUNT=$(echo "$TEMP_FILES" | wc -l)
              echo "Found $COUNT .$EXT files" >> $GITHUB_STEP_SUMMARY
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” **Dry run** - Would delete $COUNT files" \
                  >> $GITHUB_STEP_SUMMARY
              else
                echo "$TEMP_FILES" | xargs rm -f 2>/dev/null || true
                CLEANED=$((CLEANED + COUNT))
              fi
            fi
          done

          # Clean OS-specific files
          DS_STORE=$(find . -type f -name ".DS_Store" 2>/dev/null)
          if [ -n "$DS_STORE" ]; then
            COUNT=$(echo "$DS_STORE" | wc -l)
            echo "Found $COUNT .DS_Store files" >> $GITHUB_STEP_SUMMARY
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $COUNT files" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "$DS_STORE" | xargs rm -f 2>/dev/null || true
              CLEANED=$((CLEANED + COUNT))
            fi
          fi

          THUMBS=$(find . -type f -name "Thumbs.db" 2>/dev/null)
          if [ -n "$THUMBS" ]; then
            COUNT=$(echo "$THUMBS" | wc -l)
            echo "Found $COUNT Thumbs.db files" >> $GITHUB_STEP_SUMMARY
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $COUNT files" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "$THUMBS" | xargs rm -f 2>/dev/null || true
              CLEANED=$((CLEANED + COUNT))
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" = "false" ] && [ $CLEANED -gt 0 ]; then
            echo "âœ… Cleaned $CLEANED editor temp files" >> $GITHUB_STEP_SUMMARY
          elif [ $CLEANED -eq 0 ]; then
            echo "âœ… No editor temp files found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Clean PHP Cache Files
        run: |
          echo "## ðŸ˜ PHP Cache Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DRY_RUN="${{ steps.params.outputs.dry_run }}"
          CLEANED=0

          # Clean PHP cache files
          for CACHE_FILE in ".phpunit.result.cache" ".php-cs-fixer.cache" \
                             ".phpstan.cache" ".phplint-cache"; do
            PHP_CACHE=$(find . -type f -name "$CACHE_FILE" 2>/dev/null)
            if [ -n "$PHP_CACHE" ]; then
              COUNT=$(echo "$PHP_CACHE" | wc -l)
              echo "Found $COUNT $CACHE_FILE files" >> $GITHUB_STEP_SUMMARY
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” **Dry run** - Would delete $COUNT files" \
                  >> $GITHUB_STEP_SUMMARY
              else
                echo "$PHP_CACHE" | xargs rm -f 2>/dev/null || true
                CLEANED=$((CLEANED + COUNT))
              fi
            fi
          done

          # Clean PHP cache directories
          for CACHE_DIR in "phpmd-cache" ".psalm" ".rector"; do
            PHP_DIR=$(find . -type d -name "$CACHE_DIR" 2>/dev/null)
            if [ -n "$PHP_DIR" ]; then
              COUNT=$(echo "$PHP_DIR" | wc -l)
              echo "Found $COUNT $CACHE_DIR directories" >> $GITHUB_STEP_SUMMARY
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” **Dry run** - Would delete $COUNT directories" \
                  >> $GITHUB_STEP_SUMMARY
              else
                echo "$PHP_DIR" | xargs rm -rf 2>/dev/null || true
                CLEANED=$((CLEANED + COUNT))
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" = "false" ] && [ $CLEANED -gt 0 ]; then
            echo "âœ… Cleaned $CLEANED PHP cache items" >> $GITHUB_STEP_SUMMARY
          elif [ $CLEANED -eq 0 ]; then
            echo "âœ… No PHP cache files found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Clean Test Artifacts
        run: |
          echo "## ðŸ§ª Test Artifacts Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DRY_RUN="${{ steps.params.outputs.dry_run }}"
          CLEANED=0

          # Clean test artifact directories
          for TEST_DIR in "coverage" "htmlcov" "test-results" ".coverage"; do
            TEST_FOUND=$(find . -maxdepth 2 -type d -name "$TEST_DIR" 2>/dev/null)
            if [ -n "$TEST_FOUND" ]; then
              COUNT=$(echo "$TEST_FOUND" | wc -l)
              echo "Found $COUNT $TEST_DIR directories" >> $GITHUB_STEP_SUMMARY
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” **Dry run** - Would delete $COUNT directories" \
                  >> $GITHUB_STEP_SUMMARY
              else
                echo "$TEST_FOUND" | xargs rm -rf 2>/dev/null || true
                CLEANED=$((CLEANED + COUNT))
              fi
            fi
          done

          # Clean coverage files
          COV_FILES=$(find . -maxdepth 2 -type f -name ".coverage.*" 2>/dev/null)
          if [ -n "$COV_FILES" ]; then
            COUNT=$(echo "$COV_FILES" | wc -l)
            echo "Found $COUNT coverage files" >> $GITHUB_STEP_SUMMARY
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ” **Dry run** - Would delete $COUNT files" \
                >> $GITHUB_STEP_SUMMARY
            else
              echo "$COV_FILES" | xargs rm -f 2>/dev/null || true
              CLEANED=$((CLEANED + COUNT))
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" = "false" ] && [ $CLEANED -gt 0 ]; then
            echo "âœ… Cleaned $CLEANED test artifacts" >> $GITHUB_STEP_SUMMARY
          elif [ $CLEANED -eq 0 ]; then
            echo "âœ… No test artifacts found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Display Cleanup Configuration
        run: |
          echo "## ðŸ§¹ Repository Cleanup Configuration" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          RETENTION="${{ steps.params.outputs.retention_days }}"
          COMPRESS="${{ steps.params.outputs.compress_days }}"
          ARCHIVE="${{ steps.params.outputs.archive_retention_days }}"
          DRYRUN="${{ steps.params.outputs.dry_run }}"
          echo "| Retention Period (uncompressed) | $RETENTION days |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Compress Logs After | $COMPRESS days |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Archive Retention Period | $ARCHIVE days |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | $DRYRUN |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Find and Report Log Files
        id: report
        run: |
          echo "## ðŸ“Š Current Log Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if logs directory exists
          if [ ! -d "logs" ]; then
            echo "âš ï¸ No logs directory found." >> $GITHUB_STEP_SUMMARY
            echo "has_logs=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_logs=true" >> $GITHUB_OUTPUT

          # Count current log files
          TOTAL_LOGS=$(find logs/ -name "*.log" -type f 2>/dev/null | wc -l)
          TOTAL_GZ=$(find logs/ -name "*.log.gz" -type f 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh logs/ 2>/dev/null | cut -f1)

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Uncompressed Logs | $TOTAL_LOGS |" >> $GITHUB_STEP_SUMMARY
          echo "| Compressed Logs | $TOTAL_GZ |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Size | $TOTAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Compress Old Logs
        if: steps.report.outputs.has_logs == 'true'
        run: |
          COMPRESS_DAYS="${{ steps.params.outputs.compress_days }}"
          DRY_RUN="${{ steps.params.outputs.dry_run }}"

          echo "### ðŸ“¦ Compress Logs Older Than $COMPRESS_DAYS Days" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find logs older than compress_days
          MATCHES=$(find logs/ -name "*.log" -type f \
            -mtime +$COMPRESS_DAYS 2>/dev/null)

          if [ -z "$MATCHES" ]; then
            echo "âœ… No logs older than $COMPRESS_DAYS days." \
              >> $GITHUB_STEP_SUMMARY
          else
            COUNT=$(echo "$MATCHES" | wc -l)
            echo "Found $COUNT log file(s) to compress:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MATCHES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            if [ "$DRY_RUN" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ” **Dry run** - Files not modified." \
                >> $GITHUB_STEP_SUMMARY
            else
              # Compress the files (using -print0/-0 for safe handling)
              find logs/ -name "*.log" -type f \
                -mtime +$COMPRESS_DAYS -print0 2>/dev/null | \
                xargs -0 -r gzip
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Compressed $COUNT log file(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Delete Old Uncompressed Logs
        if: steps.report.outputs.has_logs == 'true'
        run: |
          RETENTION_DAYS="${{ steps.params.outputs.retention_days }}"
          DRY_RUN="${{ steps.params.outputs.dry_run }}"

          echo "### ðŸ—‘ï¸ Delete Uncompressed Logs Older Than" \
            "$RETENTION_DAYS Days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find logs older than retention period
          MATCHES=$(find logs/ -name "*.log" -type f \
            -mtime +$RETENTION_DAYS 2>/dev/null)

          if [ -z "$MATCHES" ]; then
            echo "âœ… No uncompressed logs older than $RETENTION_DAYS days." \
              >> $GITHUB_STEP_SUMMARY
          else
            COUNT=$(echo "$MATCHES" | wc -l)
            echo "Found $COUNT log file(s) to delete:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MATCHES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            if [ "$DRY_RUN" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ” **Dry run** - Files not modified." \
                >> $GITHUB_STEP_SUMMARY
            else
              # Delete the files (using -print0/-0 for safe handling)
              find logs/ -name "*.log" -type f \
                -mtime +$RETENTION_DAYS -print0 2>/dev/null | \
                xargs -0 -r rm -f
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Deleted $COUNT log file(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Delete Old Compressed Archives
        if: steps.report.outputs.has_logs == 'true'
        run: |
          ARCHIVE_RETENTION="${{ steps.params.outputs.archive_retention_days }}"
          DRY_RUN="${{ steps.params.outputs.dry_run }}"

          echo "### ðŸ—„ï¸ Delete Compressed Archives Older Than" \
            "$ARCHIVE_RETENTION Days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find compressed logs older than archive retention period
          MATCHES=$(find logs/ -name "*.log.gz" -type f \
            -mtime +$ARCHIVE_RETENTION 2>/dev/null)

          if [ -z "$MATCHES" ]; then
            echo "âœ… No archives older than $ARCHIVE_RETENTION days." \
              >> $GITHUB_STEP_SUMMARY
          else
            COUNT=$(echo "$MATCHES" | wc -l)
            echo "Found $COUNT archive(s) to delete:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MATCHES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            if [ "$DRY_RUN" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ” **Dry run** - Files not modified." \
                >> $GITHUB_STEP_SUMMARY
            else
              # Delete the files (using -print0/-0 for safe handling)
              find logs/ -name "*.log.gz" -type f \
                -mtime +$ARCHIVE_RETENTION -print0 2>/dev/null | \
                xargs -0 -r rm -f
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Deleted $COUNT archive(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Generate Final Report
        if: steps.report.outputs.has_logs == 'true'
        run: |
          echo "## ðŸ“ˆ Final Log Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count remaining log files
          REMAINING=$(find logs/ -name "*.log" -type f 2>/dev/null | wc -l)
          REMAINING_GZ=$(find logs/ -name "*.log.gz" -type f \
            2>/dev/null | wc -l)
          FINAL_SIZE=$(du -sh logs/ 2>/dev/null | cut -f1)

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Remaining Uncompressed Logs | $REMAINING |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Remaining Compressed Logs | $REMAINING_GZ |" \
            >> $GITHUB_STEP_SUMMARY
          echo "| Total Size | $FINAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Log cleanup completed successfully!**" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          LINK="[logs/README.md](../blob/main/logs/README.md)"
          echo "For more information, see $LINK." >> $GITHUB_STEP_SUMMARY

      - name: Commit Changes
        if: |
          steps.report.outputs.has_logs == 'true' &&
          steps.params.outputs.dry_run == 'false'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            git add logs/

            COMPRESS="${{ steps.params.outputs.compress_days }}"
            RETENTION="${{ steps.params.outputs.retention_days }}"
            ARCHIVE="${{ steps.params.outputs.archive_retention_days }}"

            git commit -m "chore: automated log cleanup" \
              -m "" \
              -m "- Compressed logs older than $COMPRESS days" \
              -m "- Deleted uncompressed logs older than $RETENTION days" \
              -m "- Deleted archives older than $ARCHIVE days" \
              -m "" \
              -m "Automated by log-cleanup workflow"

            git push
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ Changes committed and pushed." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ No changes to commit." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Workflow Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Information**" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "- Timestamp: $TIMESTAMP" >> $GITHUB_STEP_SUMMARY
