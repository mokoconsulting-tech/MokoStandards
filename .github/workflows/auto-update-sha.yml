# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/auto-update-sha.yml
# VERSION: 04.00.01
# BRIEF: Automatically update SHA-256 hashes after merge to main
# NOTE: Ensures security verification hashes stay synchronized with file changes

name: Auto-Update SHA Hashes

# MokoStandards Policy Compliance:
# - File formatting: Enforces organizational coding standards
# - Reference: docs/policy/file-formatting.md

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW FLOW DIAGRAM                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER: Push to main (after merge)
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Check if files  â”‚
#   â”‚  with SHA hashes â”‚
#   â”‚    changed       â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Calculate new   â”‚
#   â”‚  SHA-256 hashes  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Update workflow â”‚
#   â”‚  files if needed â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Commit & Push   â”‚
#   â”‚  if changes made â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  push:
    branches:
      - main
    paths:
      # Trigger when tracked script files change
      - 'scripts/**/*.py'
      - 'scripts/**/*.sh'
      - 'scripts/**/*.ps1'
      - 'scripts/.script-registry.json'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update even if no changes detected'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update-sha-hashes:
    name: Update SHA-256 Hashes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.31.0
        with:
          php-version: '8.1'
          extensions: json
          coverage: none

      - name: Check for changes
        id: check_changes
        run: |
          set -x
          echo "## ðŸ” SHA-256 Hash Update Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run script in dry-run mode to check if updates needed
          if php scripts/maintenance/update_sha_hashes.php --dry-run --verbose > /tmp/sha_check.txt 2>&1; then
            echo "âœ… Script execution successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Script execution failed" >> $GITHUB_STEP_SUMMARY
            cat /tmp/sha_check.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          cat /tmp/sha_check.txt

          # Check if changes would be made
          if grep -q "Hash updated" /tmp/sha_check.txt || [ "${{ github.event.inputs.force }}" = "true" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Updates Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/sha_check.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ No updates needed - all hashes are current" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update SHA hashes
        if: steps.check_changes.outputs.needs_update == 'true'
        run: |
          set -x
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Updating Hashes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          php scripts/maintenance/update_sha_hashes.php --verbose | tee /tmp/sha_update.txt

          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat /tmp/sha_update.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Configure Git
        if: steps.check_changes.outputs.needs_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push changes
        if: steps.check_changes.outputs.needs_update == 'true'
        run: |
          set -x

          # Check if there are actual changes to commit
          if git diff --quiet scripts/.script-registry.json; then
            echo "â„¹ï¸ No changes to commit" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          git add scripts/.script-registry.json
          git commit -m "chore: auto-update SHA-256 hashes after merge" \
                     -m "" \
                     -m "[skip ci]" \
                     -m "" \
                     -m "Updated SHA-256 hashes in script registry." \
                     -m "Generated by: .github/workflows/auto-update-sha.yml" \
                     -m "Commit: ${{ github.sha }}" \
                     -m "Triggered by: ${{ github.event_name }}"

          git push

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Changes Committed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SHA-256 hashes have been automatically updated and committed." >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** Auto-Update SHA Hashes" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
