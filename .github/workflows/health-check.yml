# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.HealthCheck
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/health-check.yml
# VERSION: 03.02.00
# BRIEF: Hourly library health check and circuit breaker testing
# NOTE: Monitors library health and tests circuit breakers using api_client.py

name: Health Check

on:
  schedule:
    # Run hourly
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      test_circuit_breaker:
        description: 'Test circuit breaker functionality'
        required: false
        type: boolean
        default: true
      check_all_libraries:
        description: 'Check all enterprise libraries'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  health-check:
    name: Library Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Create Health Check Directory
        run: |
          mkdir -p logs/health
          mkdir -p logs/reports

      - name: Check Library Health
        id: health
        run: |
          echo "## ðŸ¥ Library Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          python3 << 'EOF'
          import sys
          import json
          from pathlib import Path
          sys.path.insert(0, 'scripts/lib')

          health_status = {}
          failed_libraries = []

          # Test api_client.py
          try:
              from api_client import APIClient, CircuitState

              # Create a test client
              client = APIClient(
                  base_url='https://api.github.com',
                  max_requests_per_hour=5000,
                  circuit_breaker_threshold=5,
                  circuit_breaker_timeout=30
              )

              # Check circuit breaker state
              health_status['api_client'] = {
                  'status': 'healthy',
                  'circuit_state': client.circuit_state.value,
                  'version': getattr(client, 'VERSION', 'unknown')
              }
              print("âœ… api_client.py: healthy")

          except Exception as e:
              health_status['api_client'] = {'status': 'unhealthy', 'error': str(e)}
              failed_libraries.append('api_client')
              print(f"âŒ api_client.py: {e}")

          # Test enterprise_audit.py
          try:
              from enterprise_audit import AuditLogger

              logger = AuditLogger(service='health_check', enable_file=False)
              health_status['enterprise_audit'] = {
                  'status': 'healthy',
                  'version': logger.VERSION
              }
              print("âœ… enterprise_audit.py: healthy")

          except Exception as e:
              health_status['enterprise_audit'] = {'status': 'unhealthy', 'error': str(e)}
              failed_libraries.append('enterprise_audit')
              print(f"âŒ enterprise_audit.py: {e}")

          # Test metrics_collector.py
          try:
              from metrics_collector import MetricsCollector

              metrics = MetricsCollector()
              metrics.increment('health_check_test')
              health_status['metrics_collector'] = {
                  'status': 'healthy',
                  'version': metrics.VERSION
              }
              print("âœ… metrics_collector.py: healthy")

          except Exception as e:
              health_status['metrics_collector'] = {'status': 'unhealthy', 'error': str(e)}
              failed_libraries.append('metrics_collector')
              print(f"âŒ metrics_collector.py: {e}")

          # Test security_validator.py
          try:
              from security_validator import SecurityValidator

              validator = SecurityValidator()
              health_status['security_validator'] = {
                  'status': 'healthy',
                  'version': validator.VERSION
              }
              print("âœ… security_validator.py: healthy")

          except Exception as e:
              health_status['security_validator'] = {'status': 'unhealthy', 'error': str(e)}
              failed_libraries.append('security_validator')
              print(f"âŒ security_validator.py: {e}")

          # Save health report
          with open('logs/health/health-report.json', 'w') as f:
              json.dump(health_status, f, indent=2)

          with open('/tmp/health_summary.json', 'w') as f:
              json.dump({
                  'total': len(health_status),
                  'healthy': len([s for s in health_status.values() if s['status'] == 'healthy']),
                  'unhealthy': len(failed_libraries),
                  'failed': failed_libraries
              }, f)

          if failed_libraries:
              sys.exit(1)
          EOF

          # Read summary and output
          if [ -f "/tmp/health_summary.json" ]; then
            SUMMARY=$(cat /tmp/health_summary.json)
            TOTAL=$(echo $SUMMARY | python3 -c "import sys, json; print(json.load(sys.stdin)['total'])")
            HEALTHY=$(echo $SUMMARY | python3 -c "import sys, json; print(json.load(sys.stdin)['healthy'])")
            UNHEALTHY=$(echo $SUMMARY | python3 -c "import sys, json; print(json.load(sys.stdin)['unhealthy'])")

            echo "total_libraries=$TOTAL" >> $GITHUB_OUTPUT
            echo "healthy_count=$HEALTHY" >> $GITHUB_OUTPUT
            echo "unhealthy_count=$UNHEALTHY" >> $GITHUB_OUTPUT

            echo "### Health Status" >> $GITHUB_STEP_SUMMARY
            echo "- Total libraries checked: **${TOTAL}**" >> $GITHUB_STEP_SUMMARY
            echo "- Healthy: **${HEALTHY}** âœ…" >> $GITHUB_STEP_SUMMARY
            echo "- Unhealthy: **${UNHEALTHY}** âŒ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test Circuit Breaker
        if: github.event.inputs.test_circuit_breaker != 'false'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”Œ Circuit Breaker Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          python3 << 'EOF'
          import sys
          import time
          sys.path.insert(0, 'scripts/lib')

          try:
              from api_client import APIClient, CircuitState, CircuitBreakerOpen

              # Create test client with low threshold
              client = APIClient(
                  base_url='https://httpbin.org',
                  circuit_breaker_threshold=3,
                  circuit_breaker_timeout=5
              )

              print(f"Initial state: {client.circuit_state.value}")

              # Simulate failures to trip circuit breaker
              for i in range(4):
                  try:
                      # This will fail and increment failure count
                      client._circuit_breaker_failures = i
                      if i >= 3:
                          client.circuit_state = CircuitState.OPEN
                          client._circuit_breaker_open_until = time.time() + 5
                  except:
                      pass

              print(f"After simulated failures: {client.circuit_state.value}")

              # Verify circuit is open
              try:
                  if client.circuit_state == CircuitState.OPEN:
                      print("âœ… Circuit breaker correctly opened after threshold")
                  else:
                      print("âš ï¸ Circuit breaker did not open as expected")
              except CircuitBreakerOpen:
                  print("âœ… Circuit breaker is open (raising exception)")

              # Wait for timeout
              print("Waiting for circuit timeout...")
              time.sleep(6)

              # Check if circuit moved to half-open
              client._check_circuit_breaker()
              print(f"After timeout: {client.circuit_state.value}")

              print("âœ… Circuit breaker test completed successfully")

          except Exception as e:
              print(f"âŒ Circuit breaker test failed: {e}")
              sys.exit(1)
          EOF

          echo "âœ… Circuit breaker test passed" >> $GITHUB_STEP_SUMMARY

      - name: Upload Health Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: health-report-${{ github.run_number }}
          path: |
            logs/health/
          retention-days: 7

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Health check failed" >> $GITHUB_STEP_SUMMARY
          echo "One or more libraries are unhealthy" >> $GITHUB_STEP_SUMMARY
