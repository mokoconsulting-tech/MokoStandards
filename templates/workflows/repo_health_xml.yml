# ============================================================================
# Copyright (C) 2025 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Validation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /templates/workflows/repo_health_xml.yml
# VERSION: 01.00.00
# BRIEF: XML-based repository health check workflow using remote configuration
# NOTE: This workflow uses the new XML-based health checking system
# ============================================================================

name: Repository Health Check (XML-based)

concurrency:
  group: repo-health-xml-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

on:
  workflow_dispatch:
    inputs:
      config_url:
        description: 'Health configuration URL (leave empty for default)'
        required: false
        default: ''
      output_format:
        description: 'Output format'
        required: true
        default: 'text'
        type: choice
        options:
          - text
          - json
  pull_request:
    paths:
      - .github/workflows/**
      - scripts/**
      - docs/**
      - README.md
      - LICENSE
      - CHANGELOG.md
      - CONTRIBUTING.md
      - SECURITY.md
  push:
    branches:
      - main
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read

env:
  # Default remote configuration URL
  DEFAULT_CONFIG_URL: https://raw.githubusercontent.com/mokoconsulting-tech/MokoStandards/main/schemas/repo-health-default.xml
  
  # Scripts URLs
  HEALTH_CHECKER_URL: https://raw.githubusercontent.com/mokoconsulting-tech/MokoStandards/main/scripts/validate/check_repo_health.py
  CONFIG_VALIDATOR_URL: https://raw.githubusercontent.com/mokoconsulting-tech/MokoStandards/main/scripts/validate/validate_repo_health.py

jobs:
  health-check:
    name: Repository Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download health checker script
        run: |
          echo "Downloading health checker from MokoStandards..."
          # Note: Downloading and executing remote scripts poses a security risk.
          # For production use, consider pinning to specific commit SHA or adding checksum verification.
          # See SECURITY_NOTES_REPO_HEALTH.md for mitigation strategies.
          curl -sSL "${HEALTH_CHECKER_URL}" -o check_repo_health.py
          chmod +x check_repo_health.py
          
          echo "Downloading config validator from MokoStandards..."
          curl -sSL "${CONFIG_VALIDATOR_URL}" -o validate_repo_health.py
          chmod +x validate_repo_health.py

      - name: Determine configuration URL
        id: config
        run: |
          # Use workflow input if provided, otherwise use default
          CONFIG_URL="${{ github.event.inputs.config_url }}"
          if [ -z "${CONFIG_URL}" ]; then
            CONFIG_URL="${DEFAULT_CONFIG_URL}"
          fi
          
          echo "config_url=${CONFIG_URL}" >> "${GITHUB_OUTPUT}"
          echo "Using configuration: ${CONFIG_URL}"

      - name: Validate configuration
        run: |
          echo "Validating health configuration..."
          python3 validate_repo_health.py "${{ steps.config.outputs.config_url }}" --verbose

      - name: Run health check
        id: health_check
        run: |
          OUTPUT_FORMAT="${{ github.event.inputs.output_format }}"
          if [ -z "${OUTPUT_FORMAT}" ]; then
            OUTPUT_FORMAT="text"
          fi
          
          echo "Running health check with output format: ${OUTPUT_FORMAT}"
          
          # Always generate JSON for artifact upload and summary generation
          python3 check_repo_health.py \
            --config "${{ steps.config.outputs.config_url }}" \
            --repo-path . \
            --output json \
            --verbose > health-report.json
          
          # Also display human-readable output in logs if text format was requested
          if [ "${OUTPUT_FORMAT}" = "text" ]; then
            echo ""
            echo "=== Human-readable health report ==="
            python3 check_repo_health.py \
              --config "${{ steps.config.outputs.config_url }}" \
              --repo-path . \
              --output text \
              --verbose
          fi

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health-report.json
          if-no-files-found: ignore
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          if [ -f health-report.json ]; then
            # Parse JSON and create markdown summary
            python3 - <<'EOF'
          import json
          import sys
          
          try:
            with open('health-report.json', 'r') as f:
              data = json.load(f)
            
            score = data.get('score', 0)
            max_score = data.get('max_score', 100)
            percentage = data.get('percentage', 0)
            level = data.get('level', 'unknown').upper()
            
            # Determine indicator
            indicators = {
              'EXCELLENT': 'âœ…',
              'GOOD': 'âš ï¸',
              'FAIR': 'ðŸŸ¡',
              'POOR': 'âŒ'
            }
            indicator = indicators.get(level, '?')
            
            # Write to GitHub Step Summary
            with open(sys.environ['GITHUB_STEP_SUMMARY'], 'w') as summary:
              summary.write("# Repository Health Check Results\n\n")
              summary.write(f"## Overall Score: {score}/{max_score} ({percentage:.1f}%) {indicator}\n\n")
              summary.write(f"**Health Level**: {level}\n\n")
              
              summary.write("## Category Breakdown\n\n")
              summary.write("| Category | Points Earned | Max Points | Pass Rate |\n")
              summary.write("|----------|---------------|------------|----------|\n")
              
              for cat_id, cat_info in data.get('categories', {}).items():
                name = cat_info.get('name', cat_id)
                earned = cat_info.get('earned_points', 0)
                max_pts = cat_info.get('max_points', 0)
                passed = cat_info.get('checks_passed', 0)
                failed = cat_info.get('checks_failed', 0)
                total_checks = passed + failed
                pass_rate = (passed / total_checks * 100) if total_checks > 0 else 0
                
                summary.write(f"| {name} | {earned} | {max_pts} | {pass_rate:.0f}% |\n")
              
              # Show failed required checks
              failed_checks = [
                c for c in data.get('checks', [])
                if not c.get('passed', False) and c.get('required', True)
              ]
              
              if failed_checks:
                summary.write("\n## Required Checks Failed\n\n")
                for check in failed_checks[:10]:  # Limit to first 10
                  name = check.get('name', 'Unknown')
                  message = check.get('message', '')
                  remediation = check.get('remediation', '')
                  
                  summary.write(f"### âŒ {name}\n\n")
                  summary.write(f"**Status**: {message}\n\n")
                  if remediation:
                    summary.write(f"**Remediation**: {remediation}\n\n")
                
                if len(failed_checks) > 10:
                  summary.write(f"\n*...and {len(failed_checks) - 10} more failed checks*\n\n")
              
              summary.write("\n---\n\n")
              summary.write("*Health check performed using MokoStandards XML-based configuration*\n")
          
          except Exception as e:
            print(f"Error generating summary: {e}", file=sys.stderr)
            sys.exit(1)
          EOF
          else
            echo "No health report JSON file found. Check may have failed."
          fi

      - name: Check health threshold
        if: always()
        run: |
          # Fail the workflow if health score is below 70% (Good threshold)
          if [ -f health-report.json ]; then
            python3 - <<'EOF'
import json
import sys

try:
    with open('health-report.json', 'r') as f:
        data = json.load(f)
    
    percentage = data.get('percentage', 0)
    threshold = 70.0
    
    print(f"Health score: {percentage}%")
    
    if percentage < threshold:
        print(f"âŒ Health score below threshold ({threshold}%). Current: {percentage}%")
        print("Please address the failed checks to improve repository health.")
        sys.exit(1)
    else:
        print(f"âœ… Health score meets threshold. Current: {percentage}%")
        sys.exit(0)

except Exception as e:
    print(f"Error checking health threshold: {e}", file=sys.stderr)
    sys.exit(1)
EOF
          else
            echo "âš ï¸ Could not determine health score. Assuming failure."
            exit 1
          fi

  # Optional: Create GitHub issue for poor health
  create-issue:
    name: Create Health Alert Issue
    needs: health-check
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Create issue for poor health
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ¥ Repository Health Check Failed';
            const body = `
            ## Repository Health Alert
            
            The automated health check has detected that this repository's health score is below the acceptable threshold.
            
            **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### Actions Required
            
            1. Review the workflow run linked above for detailed failure information
            2. Download the health report artifact for full analysis
            3. Address the failed required checks
            4. Re-run the health check to verify improvements
            
            ### Resources
            
            - [Repository Health Scoring System](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/docs/health-scoring.md)
            - [Health Configuration Schema](https://github.com/mokoconsulting-tech/MokoStandards/blob/main/schemas/repo-health-default.xml)
            
            *This issue was automatically created by the Repository Health Check workflow.*
            `;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check',
            });
            
            const existingIssue = issues.data.find(issue => issue.title === title);
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'automated'],
              });
            } else {
              // Update existing issue with comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Health check still failing as of ${new Date().toISOString()}.\n\nWorkflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              });
            }
