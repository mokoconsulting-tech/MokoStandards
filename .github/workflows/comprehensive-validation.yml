# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Validation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/comprehensive-validation.yml
# VERSION: 04.00.00
# BRIEF: Comprehensive validation for all scripts, workflows, and templates
# NOTE: PHP-only repository (v04.00.00). Python validation removed Feb 2026.

name: Comprehensive File Validation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'templates/**'
      - 'docs/templates/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'templates/**'
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      file_type:
        description: 'Type of files to validate'
        required: false
        type: choice
        options:
          - all
          - php
          - shell
          - powershell
          - workflow
          - template
        default: 'all'
      strict:
        description: 'Strict mode (fail on any issues)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-php:
    name: Validate PHP Scripts
    runs-on: ubuntu-latest
    if: github.event.inputs.file_type == 'all' || github.event.inputs.file_type == 'php' || github.event.inputs.file_type == ''

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@2cb9b829437ee246e9b3cac53555a39208ca6d28 # v2.31.0
        with:
          php-version: '8.1'
          extensions: mbstring, curl, json

      - name: Validate PHP Scripts
        id: validate_php
        run: |
          echo "## üêò PHP Script Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all PHP files
          PHP_FILES=$(find scripts/ src/ public/ -name "*.php" -type f 2>/dev/null | wc -l)
          echo "Found $PHP_FILES PHP files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validate syntax
          EXIT_CODE=0
          while IFS= read -r file; do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Syntax error in $file" >> $GITHUB_STEP_SUMMARY
              EXIT_CODE=1
            fi
          done < <(find scripts/ src/ public/ -name "*.php" -type f 2>/dev/null)

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All PHP files have valid syntax" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some PHP files have syntax errors" >> $GITHUB_STEP_SUMMARY
          fi

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check Results
        if: steps.validate_php.outputs.exit_code != '0'
        run: |
          echo "‚ùå PHP validation failed"
          exit 1

  validate-shell:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    if: github.event.inputs.file_type == 'all' || github.event.inputs.file_type == 'shell' || github.event.inputs.file_type == ''

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Validate Shell Scripts
        id: validate_shell
        run: |
          echo "## üêö Shell Script Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all shell scripts
          SHELL_FILES=$(find scripts/ templates/ -name "*.sh" -type f 2>/dev/null | wc -l)
          echo "Found $SHELL_FILES shell scripts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validate with shellcheck
          EXIT_CODE=0
          while IFS= read -r file; do
            if ! shellcheck "$file" 2>&1 | tee -a /tmp/shell-validation.log; then
              echo "‚ö†Ô∏è Issues found in $file" >> $GITHUB_STEP_SUMMARY
              EXIT_CODE=1
            fi
          done < <(find scripts/ templates/ -name "*.sh" -type f 2>/dev/null)

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All shell scripts passed shellcheck" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some shell scripts have issues" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/shell-validation.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Upload Shell Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shell-validation-report
          path: /tmp/shell-validation.log
          retention-days: 30

      - name: Check Results
        if: steps.validate_shell.outputs.exit_code != '0'
        run: |
          echo "‚ùå Shell validation failed"
          exit 1

  validate-workflows:
    name: Validate GitHub Workflows
    runs-on: ubuntu-latest
    if: github.event.inputs.file_type == 'all' || github.event.inputs.file_type == 'workflow' || github.event.inputs.file_type == ''

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Workflows
        id: validate_workflows
        run: |
          echo "## ‚öôÔ∏è Workflow Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all workflow files
          WORKFLOW_FILES=$(find .github/workflows/ -name "*.yml" -type f 2>/dev/null | wc -l)
          echo "Found $WORKFLOW_FILES workflow files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validate YAML syntax
          EXIT_CODE=0
          while IFS= read -r file; do
            if ! yamllint -d '{extends: default, rules: {line-length: disable}}' "$file" 2>&1 | tee -a /tmp/workflow-validation.log; then
              echo "‚ö†Ô∏è Issues found in $file" >> $GITHUB_STEP_SUMMARY
              EXIT_CODE=1
            fi
          done < <(find .github/workflows/ -name "*.yml" -type f 2>/dev/null)

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All workflows have valid YAML syntax" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some workflows have YAML issues" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/workflow-validation.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Upload Workflow Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-validation-report
          path: /tmp/workflow-validation.log
          retention-days: 30

      - name: Check Results
        if: steps.validate_workflows.outputs.exit_code != '0'
        run: |
          echo "‚ùå Workflow validation failed"
          exit 1

  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest
    if: github.event.inputs.file_type == 'all' || github.event.inputs.file_type == 'template' || github.event.inputs.file_type == ''

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Templates
        id: validate_templates
        run: |
          echo "## üìù Template Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all template files
          TEMPLATE_FILES=$(find templates/ docs/templates/ .github/ISSUE_TEMPLATE/ -type f 2>/dev/null | wc -l)
          echo "Found $TEMPLATE_FILES template files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Basic validation - check if files exist and are readable
          EXIT_CODE=0
          while IFS= read -r file; do
            if [ ! -r "$file" ]; then
              echo "‚ùå Cannot read $file" >> $GITHUB_STEP_SUMMARY
              EXIT_CODE=1
            fi
          done < <(find templates/ docs/templates/ .github/ISSUE_TEMPLATE/ -type f 2>/dev/null)

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All template files are readable" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some template files have issues" >> $GITHUB_STEP_SUMMARY
          fi

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check Results
        if: steps.validate_templates.outputs.exit_code != '0'
        run: |
          echo "‚ùå Template validation failed"
          exit 1

  validate-yaml-tabs:
    name: Validate YAML Files (No Tabs)
    runs-on: ubuntu-latest
    if: github.event.inputs.file_type == 'all' || github.event.inputs.file_type == 'workflow' || github.event.inputs.file_type == 'template' || github.event.inputs.file_type == ''

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check YAML Files for Tabs
        id: validate_yaml_tabs
        run: |
          echo "## üìù YAML Tab Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for TAB characters in YAML files (forbidden by YAML spec)..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find YAML files with tabs
          EXIT_CODE=0
          FILES_WITH_TABS=$(find . -name "*.yml" -o -name "*.yaml" | xargs grep -l $'\t' 2>/dev/null || true)

          if [ -z "$FILES_WITH_TABS" ]; then
            echo "exit_code=0" >> $GITHUB_OUTPUT
            echo "‚úÖ No tabs found in YAML files" >> $GITHUB_STEP_SUMMARY
          else
            echo "exit_code=1" >> $GITHUB_OUTPUT
            echo "‚ùå Tabs found in YAML files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**YAML Specification:** Tab characters are forbidden in YAML files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Files with tabs:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$FILES_WITH_TABS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          fi

      - name: Check Results
        if: steps.validate_yaml_tabs.outputs.exit_code != '0'
        run: |
          echo "‚ùå YAML tab validation failed - tabs found in YAML files"
          echo "Fix: Use 'sed -i 's/\t/  /g' filename.yml' to convert tabs to spaces"
          exit 1

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-php, validate-shell, validate-workflows, validate-templates, validate-yaml-tabs]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# üîç Comprehensive Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PHP="${{ needs.validate-php.result }}"
          SHELL="${{ needs.validate-shell.result }}"
          WORKFLOWS="${{ needs.validate-workflows.result }}"
          TEMPLATES="${{ needs.validate-templates.result }}"
          YAML_TABS="${{ needs.validate-yaml-tabs.result }}"

          if [ "$PHP" = "success" ] || [ "$PHP" = "skipped" ]; then
            echo "- ‚úÖ **PHP Scripts**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå **PHP Scripts**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$SHELL" = "success" ] || [ "$SHELL" = "skipped" ]; then
            echo "- ‚úÖ **Shell Scripts**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå **Shell Scripts**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$WORKFLOWS" = "success" ] || [ "$WORKFLOWS" = "skipped" ]; then
            echo "- ‚úÖ **Workflows**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå **Workflows**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TEMPLATES" = "success" ] || [ "$TEMPLATES" = "skipped" ]; then
            echo "- ‚úÖ **Templates**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå **Templates**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$YAML_TABS" = "success" ] || [ "$YAML_TABS" = "skipped" ]; then
            echo "- ‚úÖ **YAML Tab Check**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå **YAML Tab Check**: FAILED (tabs found)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** MokoStandards v04.00.00 (PHP-only)" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** Comprehensive File Validation" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if Critical Issues
        if: |
          needs.validate-php.result == 'failure' ||
          needs.validate-shell.result == 'failure' ||
          needs.validate-workflows.result == 'failure' ||
          needs.validate-templates.result == 'failure'
        run: |
          echo "‚ùå Critical validation issues detected - workflow failed"
          exit 1
