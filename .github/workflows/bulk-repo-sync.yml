# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflows
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/bulk-repo-sync.yml
# VERSION: 01.00.00
# BRIEF: Monthly automation to sync workflows, scripts, and configurations to organization repositories
# NOTE: Runs bulk_update_repos.py (v2) script to deploy MokoStandards to all org repos

name: Bulk Repository Sync

on:
  # Run monthly on the 1st at 00:00 UTC
  schedule:
    - cron: '0 0 1 * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repositories to update (space-separated, leave empty for all)'
        required: false
        type: string
      exclude:
        description: 'Repositories to exclude (space-separated)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (preview changes without applying)'
        required: false
        type: boolean
        default: false

jobs:
  sync-repos:
    name: Sync MokoStandards to Organization Repositories
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
          echo "## ðŸ“¦ Python Dependencies Installed" >> $GITHUB_STEP_SUMMARY
          echo "- PyYAML (for .mokostandards-sync.yml override files)" >> $GITHUB_STEP_SUMMARY

      - name: Setup GitHub CLI
        run: |
          # GitHub CLI should be pre-installed on ubuntu-latest
          gh --version

      - name: Verify GitHub token availability
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          # Verify token is available before attempting authentication
          if [ -z "$GH_TOKEN" ]; then
            echo "## âŒ Error: ORG_ADMIN_TOKEN Not Set" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ORG_ADMIN_TOKEN secret is not set or is empty." >> $GITHUB_STEP_SUMMARY
            echo "Please configure the ORG_ADMIN_TOKEN secret in repository settings." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Required Permissions" >> $GITHUB_STEP_SUMMARY
            echo "- repo (full control)" >> $GITHUB_STEP_SUMMARY
            echo "- workflow" >> $GITHUB_STEP_SUMMARY
            echo "- admin:org (read)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # GH_TOKEN environment variable is automatically used by GitHub CLI
          # Verify authentication status
          if gh auth status 2>&1 || true; then
            echo "## âœ… GitHub CLI Authentication Verified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Successfully verified authentication with ORG_ADMIN_TOKEN." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Configure Git
        run: |
          git config --global user.email "automation@mokoconsulting.tech"
          git config --global user.name "Moko Standards Bot"

      - name: Validate required files availability
        run: |
          MISSING_FILES=()
          
          # Check for platform detection script
          if [ ! -f "scripts/validate/auto_detect_platform.py" ]; then
            MISSING_FILES+=("scripts/validate/auto_detect_platform.py")
          fi
          
          # Check for schema definition files required by bulk_update_repos.py
          if [ ! -f "scripts/definitions/crm-module.xml" ]; then
            MISSING_FILES+=("scripts/definitions/crm-module.xml")
          fi
          
          if [ ! -f "scripts/definitions/default-repository.xml" ]; then
            MISSING_FILES+=("scripts/definitions/default-repository.xml")
          fi
          
          if [ ! -f "scripts/definitions/waas-component.xml" ]; then
            MISSING_FILES+=("scripts/definitions/waas-component.xml")
          fi
          
          # Report errors if any files are missing
          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "## âŒ Error: Required Files Not Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following files are required for repository sync operations but were not found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for file in "${MISSING_FILES[@]}"; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please ensure all required files exist in the repository." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "## âœ… Required Files Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required files for repository sync validated and ready:" >> $GITHUB_STEP_SUMMARY
          echo "- Platform detection script" >> $GITHUB_STEP_SUMMARY
          echo "- Schema definition files (crm-module, default-repository, waas-component)" >> $GITHUB_STEP_SUMMARY

      - name: Run bulk update script (dry-run)
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == true
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          set -e

          ARGS="--dry-run"

          if [ -n "${{ inputs.repos }}" ]; then
            ARGS="$ARGS --repos ${{ inputs.repos }}"
          fi

          if [ -n "${{ inputs.exclude }}" ]; then
            ARGS="$ARGS --exclude ${{ inputs.exclude }}"
          fi

          echo "## ðŸ” Dry Run Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running bulk update in dry-run mode (no changes will be made)..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Arguments:** \`$ARGS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if python3 scripts/automation/bulk_update_repos.py $ARGS 2>&1 | tee /tmp/bulk_update.log; then
            echo "### âœ… Dry Run Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the logs above to see what changes would be made." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Dry Run Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the error messages in the workflow logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run bulk update script
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.dry_run != true)
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          set -e

          ARGS="--yes"

          # Default exclusions for scheduled runs
          if [ "${{ github.event_name }}" == "schedule" ]; then
            ARGS="$ARGS --exclude MokoStandards MokoStandards-Private"
          fi

          # Add user-specified repos/exclusions for manual runs
          if [ -n "${{ inputs.repos }}" ]; then
            ARGS="$ARGS --repos ${{ inputs.repos }}"
          fi

          if [ -n "${{ inputs.exclude }}" ]; then
            ARGS="$ARGS --exclude ${{ inputs.exclude }}"
          fi

          echo "## ðŸš€ Bulk Repository Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** Live (changes will be applied)" >> $GITHUB_STEP_SUMMARY
          echo "**Arguments:** \`$ARGS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Sync Features" >> $GITHUB_STEP_SUMMARY
          echo "- Schema-based file synchronization" >> $GITHUB_STEP_SUMMARY
          echo "- Respects \`always-overwrite\` flags" >> $GITHUB_STEP_SUMMARY
          echo "- Supports \`scripts/.mokostandards-sync.yml\` overrides" >> $GITHUB_STEP_SUMMARY
          echo "- Protected files: .gitignore, .editorconfig (and more)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify GH_TOKEN is available for git operations
          if [ -z "$GH_TOKEN" ]; then
            echo "### âŒ Error: GH_TOKEN Not Set" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "GH_TOKEN environment variable is required for git operations." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Run the script with automatic confirmation via --yes flag
          if python3 scripts/automation/bulk_update_repos.py $ARGS 2>&1 | tee /tmp/bulk_update.log; then
            echo "### âœ… Bulk Update Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All repositories have been updated with the latest standards." >> $GITHUB_STEP_SUMMARY
          else
            EXIT_CODE=$?
            echo "### âŒ Bulk Update Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Exit Code:** $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the error messages in the workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
            echo "- Token permissions insufficient" >> $GITHUB_STEP_SUMMARY
            echo "- Repository access denied" >> $GITHUB_STEP_SUMMARY
            echo "- Network or API rate limit issues" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi

      - name: Report results
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Details**" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- Dry run: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
            echo "- Repos: ${{ inputs.repos || 'all' }}" >> $GITHUB_STEP_SUMMARY
            echo "- Exclude: ${{ inputs.exclude || 'none' }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- Completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
