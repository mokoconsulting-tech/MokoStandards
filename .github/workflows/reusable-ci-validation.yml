# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Reusable
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/reusable-ci-validation.yml
# VERSION: 01.00.00
# BRIEF: Reusable CI validation workflow for repository standards enforcement
# NOTE: Supports multiple validation profiles (basic, full, strict) with configurable checks

name: Reusable CI Validation

on:
  workflow_call:
    inputs:
      profile:
        description: 'Validation profile (basic, full, strict)'
        required: false
        type: string
        default: 'basic'
      node-version:
        description: 'Node.js version for frontend validation'
        required: false
        type: string
        default: '20.x'
      php-version:
        description: 'PHP version for backend validation'
        required: false
        type: string
        default: '8.1'
      working-directory:
        description: 'Working directory for validation'
        required: false
        type: string
        default: '.'
      validate-manifests:
        description: 'Validate XML manifests (Joomla/Dolibarr)'
        required: false
        type: boolean
        default: true
      validate-changelogs:
        description: 'Validate CHANGELOG.md format and structure'
        required: false
        type: boolean
        default: true
      validate-licenses:
        description: 'Validate license headers in source files'
        required: false
        type: boolean
        default: true
      validate-security:
        description: 'Check for secrets and security issues'
        required: false
        type: boolean
        default: true
      fail-on-warnings:
        description: 'Fail the workflow on validation warnings'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  setup:
    name: Setup Validation Environment
    runs-on: ubuntu-latest
    outputs:
      has-php: ${{ steps.detect.outputs.has-php }}
      has-node: ${{ steps.detect.outputs.has-node }}
      has-scripts: ${{ steps.detect.outputs.has-scripts }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect project components
        id: detect
        working-directory: ${{ inputs.working-directory }}
        run: |
          # Detect PHP files
          if find . -name "*.php" -type f | head -1 | grep -q .; then
            echo "has-php=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PHP files detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "has-php=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No PHP files detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Detect Node.js project
          if [ -f "package.json" ]; then
            echo "has-node=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Node.js project detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "has-node=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No Node.js project detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Detect validation scripts
          if [ -d "scripts/validate" ] || [ -d ".github/scripts/validate" ]; then
            echo "has-scripts=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Validation scripts found" >> $GITHUB_STEP_SUMMARY
          else
            echo "has-scripts=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No validation scripts found" >> $GITHUB_STEP_SUMMARY
          fi

  required-validations:
    name: Required Validations
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Normalize line endings
        run: git config --global core.autocrlf false

      - name: Setup PHP
        if: needs.setup.outputs.has-php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          extensions: mbstring, xml
          coverage: none

      - name: Setup Node.js
        if: needs.setup.outputs.has-node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Make scripts executable
        if: needs.setup.outputs.has-scripts == 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -d "scripts" ]; then
            find scripts -name "*.sh" -type f -exec chmod +x {} \;
          fi
          if [ -d ".github/scripts" ]; then
            find .github/scripts -name "*.sh" -type f -exec chmod +x {} \;
          fi

      - name: Validate XML manifests
        if: inputs.validate-manifests
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### üìã Manifest Validation" >> $GITHUB_STEP_SUMMARY

          if [ -f "scripts/validate/manifest.sh" ]; then
            ./scripts/validate/manifest.sh
            echo "‚úÖ Manifest validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ -f ".github/scripts/validate/manifest.sh" ]; then
            ./.github/scripts/validate/manifest.sh
            echo "‚úÖ Manifest validation passed" >> $GITHUB_STEP_SUMMARY
          else
            # Basic XML validation
            find . -name "*.xml" -type f | while read -r file; do
              if ! xmllint --noout "$file" 2>/dev/null; then
                echo "‚ùå Invalid XML: $file" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            done
            echo "‚úÖ Basic XML validation passed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate XML well-formedness
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f "scripts/validate/xml_wellformed.sh" ]; then
            ./scripts/validate/xml_wellformed.sh
          elif [ -f ".github/scripts/validate/xml_wellformed.sh" ]; then
            ./.github/scripts/validate/xml_wellformed.sh
          else
            echo "‚ÑπÔ∏è No XML well-formedness validation script found, skipping"
          fi

      - name: Validate PHP syntax
        if: needs.setup.outputs.has-php == 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### üîç PHP Syntax Validation" >> $GITHUB_STEP_SUMMARY

          if [ -f "scripts/validate/php_syntax.sh" ]; then
            ./scripts/validate/php_syntax.sh
            echo "‚úÖ PHP syntax validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ -f ".github/scripts/validate/php_syntax.sh" ]; then
            ./.github/scripts/validate/php_syntax.sh
            echo "‚úÖ PHP syntax validation passed" >> $GITHUB_STEP_SUMMARY
          else
            # Basic PHP syntax check
            ERROR_FILE=$(mktemp)
            find . -name "*.php" -type f -exec sh -c 'if ! php -l "$1" > /dev/null 2>&1; then echo "‚ùå Syntax error in: $1"; exit 1; fi' _ {} \; || echo "1" > "$ERROR_FILE"
            if [ ! -s "$ERROR_FILE" ]; then
              echo "‚úÖ PHP syntax validation passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå PHP syntax errors found" >> $GITHUB_STEP_SUMMARY
              rm -f "$ERROR_FILE"
              exit 1
            fi
            rm -f "$ERROR_FILE"
          fi

  optional-validations:
    name: Optional Validations (${{ inputs.profile }})
    runs-on: ubuntu-latest
    needs: setup
    if: inputs.profile != 'basic'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup PHP
        if: needs.setup.outputs.has-php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          extensions: mbstring, xml
          coverage: none

      - name: Make scripts executable
        if: needs.setup.outputs.has-scripts == 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -d "scripts" ]; then
            find scripts -name "*.sh" -type f -exec chmod +x {} \;
          fi
          if [ -d ".github/scripts" ]; then
            find .github/scripts -name "*.sh" -type f -exec chmod +x {} \;
          fi

      - name: Validate changelog
        if: inputs.validate-changelogs
        continue-on-error: ${{ !inputs.fail-on-warnings }}
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### üìù Changelog Validation" >> $GITHUB_STEP_SUMMARY

          if [ -f "scripts/validate/changelog.sh" ]; then
            ./scripts/validate/changelog.sh
            echo "‚úÖ Changelog validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ -f ".github/scripts/validate/changelog.sh" ]; then
            ./.github/scripts/validate/changelog.sh
            echo "‚úÖ Changelog validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ -f "CHANGELOG.md" ]; then
            # Basic changelog validation
            if grep -q "## \[" CHANGELOG.md; then
              echo "‚úÖ Changelog appears well-formed" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Changelog may not follow standard format" >> $GITHUB_STEP_SUMMARY
              [ "${{ inputs.fail-on-warnings }}" = "true" ] && exit 1
            fi
          else
            echo "‚ö†Ô∏è No CHANGELOG.md found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate license headers
        if: inputs.validate-licenses
        continue-on-error: ${{ !inputs.fail-on-warnings }}
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### ‚öñÔ∏è License Header Validation" >> $GITHUB_STEP_SUMMARY

          if [ -f "scripts/validate/license_headers.sh" ]; then
            ./scripts/validate/license_headers.sh
            echo "‚úÖ License headers validated" >> $GITHUB_STEP_SUMMARY
          elif [ -f ".github/scripts/validate/license_headers.sh" ]; then
            ./.github/scripts/validate/license_headers.sh
            echo "‚úÖ License headers validated" >> $GITHUB_STEP_SUMMARY
          else
            # Basic license header check
            COUNT_FILE=$(mktemp)
            find . \( -name "*.php" -o -name "*.js" -o -name "*.py" \) -type f -exec sh -c 'if ! head -20 "$1" | grep -qi "license\|copyright\|spdx"; then echo "1"; fi' _ {} \; > "$COUNT_FILE"
            FILES_WITHOUT_LICENSE=$(wc -l < "$COUNT_FILE")
            rm -f "$COUNT_FILE"
            if [ "$FILES_WITHOUT_LICENSE" -eq 0 ]; then
              echo "‚úÖ License headers appear present" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Some files may be missing license headers" >> $GITHUB_STEP_SUMMARY
              [ "${{ inputs.fail-on-warnings }}" = "true" ] && exit 1
            fi
          fi

      - name: Validate language structure
        continue-on-error: true
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f "scripts/validate/language_structure.sh" ]; then
            ./scripts/validate/language_structure.sh
          elif [ -f ".github/scripts/validate/language_structure.sh" ]; then
            ./.github/scripts/validate/language_structure.sh
          else
            echo "‚ÑπÔ∏è No language structure validation script found"
          fi

      - name: Validate paths
        continue-on-error: true
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f "scripts/validate/paths.sh" ]; then
            ./scripts/validate/paths.sh
          elif [ -f ".github/scripts/validate/paths.sh" ]; then
            ./.github/scripts/validate/paths.sh
          else
            echo "‚ÑπÔ∏è No path validation script found"
          fi

      - name: Validate tabs/whitespace
        continue-on-error: true
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f "scripts/validate/tabs.sh" ]; then
            ./scripts/validate/tabs.sh
          elif [ -f ".github/scripts/validate/tabs.sh" ]; then
            ./.github/scripts/validate/tabs.sh
          else
            echo "‚ÑπÔ∏è No tabs validation script found"
          fi

      - name: Validate version alignment
        continue-on-error: ${{ !inputs.fail-on-warnings }}
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f "scripts/validate/version_alignment.sh" ]; then
            ./scripts/validate/version_alignment.sh
          elif [ -f ".github/scripts/validate/version_alignment.sh" ]; then
            ./.github/scripts/validate/version_alignment.sh
          else
            echo "‚ÑπÔ∏è No version alignment validation script found"
          fi

  security-validations:
    name: Security Validations
    runs-on: ubuntu-latest
    if: inputs.validate-security

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Make scripts executable
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -d "scripts" ]; then
            find scripts -name "*.sh" -type f -exec chmod +x {} \;
          fi
          if [ -d ".github/scripts" ]; then
            find .github/scripts -name "*.sh" -type f -exec chmod +x {} \;
          fi

      - name: Check for secrets
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### üîí Security Validation" >> $GITHUB_STEP_SUMMARY

          if [ -f "scripts/validate/no_secrets.sh" ]; then
            ./scripts/validate/no_secrets.sh
            echo "‚úÖ No secrets found" >> $GITHUB_STEP_SUMMARY
          elif [ -f ".github/scripts/validate/no_secrets.sh" ]; then
            ./.github/scripts/validate/no_secrets.sh
            echo "‚úÖ No secrets found" >> $GITHUB_STEP_SUMMARY
          else
            # Basic secrets check
            PATTERNS=(
              "password\s*=\s*['\"][^'\"]+['\"]"
              "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
              "secret\s*=\s*['\"][^'\"]+['\"]"
              "token\s*=\s*['\"][^'\"]+['\"]"
              "BEGIN RSA PRIVATE KEY"
              "BEGIN PRIVATE KEY"
            )

            FOUND=0
            for pattern in "${PATTERNS[@]}"; do
              if grep -rE "$pattern" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=vendor 2>/dev/null; then
                FOUND=1
              fi
            done

            if [ $FOUND -eq 0 ]; then
              echo "‚úÖ Basic security check passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Potential secrets or credentials detected" >> $GITHUB_STEP_SUMMARY
              echo "Please review the findings above" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [required-validations, optional-validations, security-validations]
    if: always()

    steps:
      - name: Generate validation summary
        run: |
          echo "### üéØ CI Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** ${{ inputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Required Validations | ${{ needs.required-validations.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Optional Validations | ${{ needs.optional-validations.result == 'success' && '‚úÖ Passed' || needs.optional-validations.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Validations | ${{ needs.security-validations.result == 'success' && '‚úÖ Passed' || needs.security-validations.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** $GITHUB_REPOSITORY" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** $GITHUB_REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY

      - name: Check validation results
        run: |
          if [ "${{ needs.required-validations.result }}" == "failure" ]; then
            echo "‚ùå Required validations failed"
            exit 1
          fi

          if [ "${{ needs.security-validations.result }}" == "failure" ]; then
            echo "‚ùå Security validations failed"
            exit 1
          fi

          if [ "${{ inputs.profile }}" == "strict" ] && [ "${{ needs.optional-validations.result }}" == "failure" ]; then
            echo "‚ùå Optional validations failed in strict mode"
            exit 1
          fi

          echo "‚úÖ CI validation completed successfully"
