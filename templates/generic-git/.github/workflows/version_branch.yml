name: Create version branch and bump versions

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: "New version number (for example: 01.02.00)"
        required: true
      base_branch:
        description: "Base branch to create version branch from"
        required: false
        default: "main"

permissions:
  contents: write

jobs:
  create-version-branch:
    name: Create version branch and update versions
    runs-on: ubuntu-latest

    env:
      NEW_VERSION: ${{ github.event.inputs.new_version }}
      BASE_BRANCH: ${{ github.event.inputs.base_branch }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.BASE_BRANCH }}

      - name: Compute branch name
        id: branch
        run: |
          SAFE_VERSION="${NEW_VERSION// /-}"
          BRANCH_NAME="version/${SAFE_VERSION}"
          echo "Using branch name: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Create version branch from base
        run: |
          git checkout -b "${{ steps.branch.outputs.branch_name }}"

      - name: Bump version strings across repo
        run: |
          echo "Updating version strings to ${NEW_VERSION} across repository"

          python << 'PY'
          import os
          import re
          from pathlib import Path

          new_version = os.environ["NEW_VERSION"]

          # Primary targets where code lives
          targets = [
              Path("src"),
              Path("docs"),
          ]

          # Patterns for common version locations
          patterns = [
              # Markdown or titles: "(VERSION 01.02.00)"
              (re.compile(r"\(VERSION\s+[0-9]+\.[0-9]+\.[0-9]+\)"), lambda v: f"(VERSION {v})"),

              # Metadata headers: "VERSION: 01.02.00" or "VERSION 01.02.00"
              (re.compile(r"(VERSION[:\s]+)([0-9]+\.[0-9]+\.[0-9]+)"), lambda v: r"\1" + v),

              # Joomla XML manifest tag: <version>01.02.00</version>
              (re.compile(r"(<version>)([0-9]+\.[0-9]+\.[0-9]+)(</version>)"), lambda v: r"\1" + v + r"\3"),

              # Joomla XML manifest attribute: <extension ... version="01.02.00" ...>
              (re.compile(r"(<extension\\b[^>]*\\bversion=\")([0-9]+\.[0-9]+\.[0-9]+)(\")"), lambda v: r"\1" + v + r"\3"),

              # JSON style fields: "version": "01.02.00"
              (re.compile(r"(\"version\"\s*:\s*\")(\d+\.\d+\.\d+)(\")"), lambda v: r"\1" + v + r"\3"),
          ]

          # Helper to update a single text file
          def update_file(path: Path) -> bool:
              try:
                  text = path.read_text(encoding="utf-8")
              except UnicodeDecodeError:
                  return False

              original = text
              for regex, repl in patterns:
                  text = regex.sub(lambda m, r=repl: r(new_version), text)

              if text != original:
                  path.write_text(text, encoding="utf-8")
                  print(f"Updated version in {path}")
                  return True

              return False

          # First pass: src/ and docs/
          for root in targets:
              if not root.exists():
                  continue

              for path in root.rglob("*"):
                  if not path.is_file():
                      continue

                  if path.suffix.lower() in {
                      ".png", ".jpg", ".jpeg", ".gif", ".svg", ".ico",
                      ".zip", ".pdf", ".tar", ".gz",
                  }:
                      continue

                  update_file(path)

          # Second pass: all *.md except README.md, outside src/ and docs/
          repo_root = Path(".").resolve()

          def is_under_any_target(p: Path) -> bool:
              for t in targets:
                  if not t.exists():
                      continue
                  try:
                      p.resolve().relative_to(t.resolve())
                      return True
                  except ValueError:
                      continue
              return False

          for path in repo_root.rglob("*.md"):
              if not path.is_file():
                  continue

              if path.name.lower() == "readme.md":
                  continue

              if is_under_any_target(path):
                  continue

              update_file(path)
          PY

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version bump
        run: |
          git status
          if git diff --quiet; then
            echo "No changes detected after version bump. Skipping commit."
            exit 0
          fi

          git commit -am "chore: bump version to ${NEW_VERSION}"

      - name: Push version branch
        run: |
          git push -u origin "${{ steps.branch.outputs.branch_name }}"
