# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflows
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/bulk-repo-sync.yml
# VERSION: 04.00.00
# BRIEF: Monthly automation to sync workflows, scripts, and configurations to organization repositories
# NOTE: Runs bulk_update_repos.php script to deploy MokoStandards to all org repos
# NOTE: Now uses Terraform format (MokoStandards.override.tf) for override configuration

name: Bulk Repository Sync

env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

# MokoStandards Policy Compliance:
# - File formatting: Enforces organizational coding standards
# - Reference: docs/policy/file-formatting.md

# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ                         WORKFLOW FLOW DIAGRAM                            ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#
#   TRIGGER: Monthly Schedule (1st @ 00:00 UTC) or Manual Dispatch
#        ‚îÇ
#        ‚ñº
#   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#   ‚îÇ  Parse Terraform ‚îÇ
#   ‚îÇ  Override Config ‚îÇ‚îÄ‚îÄ‚îÄ‚îê Read MokoStandards.override.tf
#   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ Extract exclusions & configs
#        ‚îÇ                 ‚îÇ
#        ‚ñº                 ‚îÇ
#   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
#   ‚îÇ  List All Org    ‚îÇ‚óÄ‚îÄ‚îÄ‚îò
#   ‚îÇ  Repositories    ‚îÇ
#   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#        ‚îÇ
#        ‚ñº
#   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#   ‚îÇ   Filter Repos   ‚îÇ‚îÄ‚îÄ‚îÄ‚îê Apply exclusions
#   ‚îÇ Apply Exclusions ‚îÇ   ‚îÇ Skip archived/disabled
#   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
#        ‚îÇ                 ‚îÇ
#        ‚ñº                 ‚îÇ
#   ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó   ‚îÇ
#   ‚ïë  FOR EACH REPO:  ‚ïë‚óÄ‚îÄ‚îÄ‚îò
#   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
#        ‚îÇ
#        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#        ‚ñº                ‚ñº                ‚ñº                ‚ñº
#   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#   ‚îÇ  Sync   ‚îÇ    ‚îÇ   Sync   ‚îÇ    ‚îÇ  Sync   ‚îÇ    ‚îÇ  Create  ‚îÇ
#   ‚îÇWorkflows‚îÇ    ‚îÇ Scripts  ‚îÇ    ‚îÇ Configs ‚îÇ    ‚îÇ   PR     ‚îÇ
#   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#        ‚îÇ                ‚îÇ                ‚îÇ                ‚îÇ
#        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#                         ‚îÇ
#                         ‚ñº
#                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#                ‚îÇ   OUTPUTS:      ‚îÇ
#                ‚îÇ ‚Ä¢ Sync Report   ‚îÇ
#                ‚îÇ ‚Ä¢ PR Links      ‚îÇ
#                ‚îÇ ‚Ä¢ Error Summary ‚îÇ
#                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

on:
  # Run monthly on the 1st at 00:00 UTC
  schedule:
    - cron: '0 0 1 * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repositories to update (space-separated, leave empty for all mokoconsulting-tech repos)'
        required: false
        type: string
      exclude:
        description: 'Repositories to exclude (space-separated)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (preview changes without applying)'
        required: false
        type: boolean
        default: false

# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ                         USAGE INSTRUCTIONS                               ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#
# This workflow syncs MokoStandards templates to ALL repositories in the
# mokoconsulting-tech organization.
#
# IMPORTANT: This workflow ALWAYS uses the mokoconsulting-tech organization.
# It cannot sync to other organizations. The bulk_update_repos.php script
# defaults to mokoconsulting-tech and this workflow does not override it.
#
# MANUAL TRIGGER OPTIONS:
#   repos:    Specific repositories to sync (e.g., "moko-cassiopeia moko-dolibarr")
#             Leave empty to sync ALL non-archived repos in the organization
#   exclude:  Repositories to skip (e.g., "MokoStandards test-repo")
#             Scheduled runs automatically exclude MokoStandards and MokoStandards-Private
#   dry_run:  Set to true to preview changes without creating PRs
#
# SCHEDULED BEHAVIOR:
#   - Runs monthly on the 1st at 00:00 UTC
#   - Automatically excludes MokoStandards and MokoStandards-Private
#   - Syncs to all other non-archived repositories
#
# SYNC BEHAVIOR:
#   - Checks MokoStandards.override.tf in target repo for platform type
#   - Falls back to auto-detection if override doesn't specify platform
#   - Respects exclude_files and protected_files from override
#   - Creates PR with synced files (never pushes directly to main/master)
#
# EXAMPLES:
#   1. Test sync to one repo (dry run):
#      repos: "moko-cassiopeia"
#      dry_run: true
#
#   2. Sync to specific repos (live):
#      repos: "moko-cassiopeia moko-dolibarr"
#      dry_run: false
#
#   3. Sync to all except specific repos:
#      exclude: "archived-repo test-repo"
#      dry_run: false
#

jobs:
  sync-repos:
    name: Sync MokoStandards to Organization Repositories
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2

      - name: Setup GitHub CLI
        run: |
          set -x
          # GitHub CLI should be pre-installed on ubuntu-latest
          gh --version

      - name: Verify GitHub token availability
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          set -x
          # Verify token is available before attempting authentication
          if [ -z "$GH_TOKEN" ]; then
            echo "## ‚ùå Error: ORG_ADMIN_TOKEN Not Set" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ORG_ADMIN_TOKEN secret is not set or is empty." >> $GITHUB_STEP_SUMMARY
            echo "Please configure the ORG_ADMIN_TOKEN secret in repository settings." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Required Permissions" >> $GITHUB_STEP_SUMMARY
            echo "- repo (full control)" >> $GITHUB_STEP_SUMMARY
            echo "- workflow" >> $GITHUB_STEP_SUMMARY
            echo "- admin:org (read)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # GH_TOKEN environment variable is automatically used by GitHub CLI
          # Verify authentication status
          if gh auth status 2>&1 || true; then
            echo "## ‚úÖ GitHub CLI Authentication Verified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Successfully verified authentication with ORG_ADMIN_TOKEN." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Configure Git
        run: |
          set -x
          git config --global user.email "automation@mokoconsulting.tech"
          git config --global user.name "Moko Standards Bot"

      - name: Validate required files availability
        run: |
          set -x
          MISSING_FILES=()

          # Check for platform detection script
          if [ ! -f "scripts/validate/auto_detect_platform.py" ]; then
            MISSING_FILES+=("scripts/validate/auto_detect_platform.py")
          fi

          # Check for schema definition files required by bulk_update_repos.php
          if [ ! -f "scripts/definitions/crm-module.xml" ]; then
            MISSING_FILES+=("scripts/definitions/crm-module.xml")
          fi

          if [ ! -f "scripts/definitions/default-repository.xml" ]; then
            MISSING_FILES+=("scripts/definitions/default-repository.xml")
          fi

          if [ ! -f "scripts/definitions/waas-component.xml" ]; then
            MISSING_FILES+=("scripts/definitions/waas-component.xml")
          fi

          # Report errors if any files are missing
          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "## ‚ùå Error: Required Files Not Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following files are required for repository sync operations but were not found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for file in "${MISSING_FILES[@]}"; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please ensure all required files exist in the repository." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "## ‚úÖ Required Files Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required files for repository sync validated and ready:" >> $GITHUB_STEP_SUMMARY
          echo "- Platform detection script" >> $GITHUB_STEP_SUMMARY
          echo "- Schema definition files (crm-module, default-repository, waas-component)" >> $GITHUB_STEP_SUMMARY

      - name: Run bulk update script (dry-run)
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == true
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          set -x
          set -e

          ARGS="--dry-run"

          if [ -n "${{ inputs.repos }}" ]; then
            ARGS="$ARGS --repos ${{ inputs.repos }}"
          fi

          if [ -n "${{ inputs.exclude }}" ]; then
            ARGS="$ARGS --exclude ${{ inputs.exclude }}"
          fi

          echo "## üîç Dry Run Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running bulk update in dry-run mode (no changes will be made)..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Arguments:** \`$ARGS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if php scripts/automation/bulk_update_repos.php $ARGS 2>&1 | tee /tmp/bulk_update.log; then
            echo "### ‚úÖ Dry Run Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the logs above to see what changes would be made." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Dry Run Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the error messages in the workflow logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run bulk update script
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.dry_run != true)
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          set -x
          set -e

          ARGS="--yes"

          # Default exclusions for scheduled runs
          if [ "${{ github.event_name }}" == "schedule" ]; then
            ARGS="$ARGS --exclude MokoStandards MokoStandards-Private"
          fi

          # Add user-specified repos/exclusions for manual runs
          if [ -n "${{ inputs.repos }}" ]; then
            ARGS="$ARGS --repos ${{ inputs.repos }}"
          fi

          if [ -n "${{ inputs.exclude }}" ]; then
            ARGS="$ARGS --exclude ${{ inputs.exclude }}"
          fi

          echo "## üöÄ Bulk Repository Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** Live (changes will be applied)" >> $GITHUB_STEP_SUMMARY
          echo "**Arguments:** \`$ARGS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Sync Features" >> $GITHUB_STEP_SUMMARY
          echo "- Schema-based file synchronization" >> $GITHUB_STEP_SUMMARY
          echo "- Respects \`always-overwrite\` flags" >> $GITHUB_STEP_SUMMARY
          echo "- Supports \`scripts/.mokostandards-sync.yml\` overrides" >> $GITHUB_STEP_SUMMARY
          echo "- Protected files: .gitignore, .editorconfig (and more)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify GH_TOKEN is available for git operations
          if [ -z "$GH_TOKEN" ]; then
            echo "### ‚ùå Error: GH_TOKEN Not Set" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "GH_TOKEN environment variable is required for git operations." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Run the script with automatic confirmation via --yes flag
          if php scripts/automation/bulk_update_repos.php $ARGS 2>&1 | tee /tmp/bulk_update.log; then
            echo "### ‚úÖ Bulk Update Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All repositories have been updated with the latest standards." >> $GITHUB_STEP_SUMMARY
          else
            EXIT_CODE=$?
            echo "### ‚ùå Bulk Update Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Exit Code:** $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the error messages in the workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
            echo "- Token permissions insufficient" >> $GITHUB_STEP_SUMMARY
            echo "- Repository access denied" >> $GITHUB_STEP_SUMMARY
            echo "- Network or API rate limit issues" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi

      - name: Create tracking issue on failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let logContent = '';
            try {
              logContent = fs.readFileSync('/tmp/bulk_update.log', 'utf8');
              // Limit log size to prevent API issues
              if (logContent.length > 50000) {
                logContent = logContent.substring(0, 50000) + '\n\n... (log truncated)';
              }
            } catch (err) {
              logContent = '_Log file not available_';
            }

            const body = `## üö® Bulk Repository Sync Failed

            **Event**: ${context.eventName}
            **Workflow Run**: [${context.runId}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Triggered by**: @${context.actor}
            **Date**: ${new Date().toISOString()}

            ### Sync Configuration
            ${context.eventName === 'schedule' ? '- **Mode**: Scheduled monthly sync' : '- **Mode**: Manual workflow dispatch'}
            ${context.eventName === 'workflow_dispatch' ? `- **Repos**: ${{ inputs.repos || 'all' }}
            - **Exclude**: ${{ inputs.exclude || 'default exclusions' }}
            - **Dry run**: ${{ inputs.dry_run }}` : ''}

            ### ‚ùå Error Details
            The bulk repository synchronization process has failed. This affects organization-wide deployment of MokoStandards updates.

            <details>
            <summary>üìã View Sync Log (last 50KB)</summary>

            \`\`\`
            ${logContent}
            \`\`\`
            </details>

            ### üîç Common Causes
            - **Token permissions**: ORG_ADMIN_TOKEN may lack required permissions
            - **Repository access**: Unable to access one or more org repositories
            - **API rate limits**: GitHub API rate limit exceeded
            - **Network issues**: Temporary connectivity problems
            - **Script errors**: Python script encountered an unexpected error

            ### ‚úÖ Resolution Steps
            1. Review the workflow run logs for detailed error messages
            2. Check ORG_ADMIN_TOKEN permissions (requires: repo, workflow, admin:org read)
            3. Verify repository accessibility
            4. Check GitHub API rate limit status
            5. Re-run the workflow manually if it was a transient issue
            6. Update the bulk_update_repos.php script if there's a bug

            ### üìö Resources
            - [Bulk Sync Script](scripts/automation/bulk_update_repos.php)
            - [Workflow Configuration](.github/workflows/bulk-repo-sync.yml)
            - [MokoStandards Documentation](https://github.com/mokoconsulting-tech/MokoStandards)

            ---
            *This issue was automatically created by the Bulk Repository Sync workflow.*
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'bulk-sync-failure',
              per_page: 1
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `### üîÑ Sync Failed Again\n\n${body}`
              });
              console.log(`Updated existing issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Infrastructure] Bulk Repository Sync Failed - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['infrastructure', 'bulk-sync-failure', 'automation'],
                assignees: ['copilot', 'jmiller-moko']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }

      - name: Report results
        if: always()
        run: |
          set -x
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Details**" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- Dry run: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
            echo "- Repos: ${{ inputs.repos || 'all' }}" >> $GITHUB_STEP_SUMMARY
            echo "- Exclude: ${{ inputs.exclude || 'none' }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- Completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
