# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.WorkflowTemplate
# INGROUP: MokoStandards.Templates
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /templates/workflows/release-cycle.yml.template
# VERSION: 02.00.00
# BRIEF: Unified release management workflow merging release-cycle and unified-release features
# NOTE: Supports auto-detection, manual dispatch, and comprehensive release flow
# MERGED: Combines features from release-cycle.yml and unified-release.yml

name: Release Management

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW ARCHITECTURE                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER OPTIONS:
#   1. Push to main â†’ Auto-detect version from files â†’ Create release
#   2. Manual dispatch â†’ Specify version/action â†’ Execute release action
#
#   RELEASE FLOW:
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚   Trigger    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚   Action Selection           â”‚
#   â”‚ â€¢ start-release (dev branch) â”‚
#   â”‚ â€¢ create-rc (RC + tag)       â”‚
#   â”‚ â€¢ finalize (stable release)  â”‚
#   â”‚ â€¢ hotfix (emergency fix)     â”‚
#   â”‚ â€¢ simple-release (one-step)  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Create       â”‚
#   â”‚ GitHub       â”‚
#   â”‚ Release      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  # Auto-release on push to main (file-based version detection)
  push:
    branches:
      - main
    paths:
      - 'CITATION.cff'
      - 'pyproject.toml'
      - 'CHANGELOG.md'
      - 'package.json'

  # Manual release with full control
  workflow_dispatch:
    inputs:
      action:
        description: 'Release action to perform'
        required: true
        type: choice
        options:
          - simple-release      # One-step release (auto-detect or specify version)
          - start-release      # Start dev branch for version
          - create-rc          # Create release candidate from dev
          - finalize-release   # Finalize RC to stable release
          - hotfix             # Emergency hotfix release
        default: 'simple-release'

      version:
        description: 'Version (e.g., 1.2.3 or 1.2.3-rc1). Leave empty for auto-detect.'
        required: false
        type: string

      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: false

      release-notes:
        description: 'Custom release notes (optional; if empty, a default release body is used)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  # Detect version and determine action
  detect:
    name: Detect Version & Mode
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine.outputs.version }}
      major: ${{ steps.determine.outputs.major }}
      minor: ${{ steps.determine.outputs.minor }}
      patch: ${{ steps.determine.outputs.patch }}
      action: ${{ steps.determine.outputs.action }}
      skip-release: ${{ steps.determine.outputs.skip-release }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine Version and Action
        id: determine
        run: |
          set -e

          echo "## Version Detection" >> $GITHUB_STEP_SUMMARY

          # Determine release action
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ inputs.action }}"
            echo "ðŸ“‹ **Mode**: Manual dispatch" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **Action**: $ACTION" >> $GITHUB_STEP_SUMMARY
          else
            # Auto-release on push to main
            ACTION="simple-release"
            echo "ðŸ“‹ **Mode**: Automatic (push to main)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT

          # Check for skip release flag
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" =~ \[skip\ release\] ]] || [[ "$COMMIT_MSG" =~ \[skip\ ci\] ]]; then
            echo "â­ï¸ Release skipped (commit message flag)" >> $GITHUB_STEP_SUMMARY
            echo "skip-release=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "skip-release=false" >> $GITHUB_OUTPUT

          # Determine version
          VERSION=""

          # Method 1: Manual input
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "âœ… Version from manual input: $VERSION" >> $GITHUB_STEP_SUMMARY

          # Method 2: File diff detection (for auto-releases)
          elif [ "${{ github.event_name }}" == "push" ]; then
            # Use the full push range for diffing to catch multi-commit and merge pushes
            DIFF_RANGE="${{ github.event.before }}..${{ github.sha }}"
            # Fallback for cases where 'before' is empty or all zeros (e.g., first push)
            if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              DIFF_RANGE="HEAD~1..HEAD"
            fi

            # Check CITATION.cff
            if git diff "$DIFF_RANGE" -- CITATION.cff 2>/dev/null | grep -q "^+version:"; then
              VERSION=$(grep "^version:" CITATION.cff | head -1 | sed 's/version: *//' | tr -d '"' | tr -d "'")
              echo "âœ… Version from CITATION.cff: $VERSION" >> $GITHUB_STEP_SUMMARY

            # Check pyproject.toml
            elif git diff "$DIFF_RANGE" -- pyproject.toml 2>/dev/null | grep -q "^+version"; then
              VERSION=$(grep "^version = " pyproject.toml | head -1 | sed 's/version = *//' | tr -d '"' | tr -d "'")
              echo "âœ… Version from pyproject.toml: $VERSION" >> $GITHUB_STEP_SUMMARY

            # Check package.json
            elif git diff "$DIFF_RANGE" -- package.json 2>/dev/null | grep -q "^+.*\"version\""; then
              VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"version": "//' | sed 's/".*//')
              echo "âœ… Version from package.json: $VERSION" >> $GITHUB_STEP_SUMMARY

            # Check CHANGELOG.md
            elif git diff "$DIFF_RANGE" -- CHANGELOG.md 2>/dev/null | grep -qE "^+## \[[0-9]+\.[0-9]+\.[0-9]+"; then
              VERSION=$(git diff "$DIFF_RANGE" -- CHANGELOG.md | grep -E "^+## \[" | head -1 | grep -oE "[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?")
              echo "âœ… Version from CHANGELOG.md: $VERSION" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Remove 'v' prefix if present
          VERSION=${VERSION#v}

          # Validate version format
          if [ -z "$VERSION" ]; then
            echo "âŒ No version detected or specified" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
            echo "âŒ Invalid version format: $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "Expected: MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-prerelease" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Extract version components
          BASE_VERSION=$(echo "$VERSION" | sed 's/-.*$//')
          MAJOR=$(echo "$BASE_VERSION" | cut -d. -f1)
          MINOR=$(echo "$BASE_VERSION" | cut -d. -f2)
          PATCH=$(echo "$BASE_VERSION" | cut -d. -f3)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

          echo "âœ… Valid version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Major: $MAJOR, Minor: $MINOR, Patch: $PATCH" >> $GITHUB_STEP_SUMMARY

  start-release:
    name: Start Release (main â†’ dev)
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.skip-release != 'true' && needs.detect.outputs.action == 'start-release'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Development Branch
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          DEV_BRANCH="dev/$VERSION"

          if git ls-remote --heads origin "$DEV_BRANCH" | grep -q "$DEV_BRANCH"; then
            echo "âš ï¸ Development branch $DEV_BRANCH already exists" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          git checkout -b "$DEV_BRANCH"
          git push origin "$DEV_BRANCH"

          echo "âœ… Created development branch: $DEV_BRANCH" >> $GITHUB_STEP_SUMMARY

  create-rc:
    name: Create Release Candidate (dev â†’ rc)
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.skip-release != 'true' && needs.detect.outputs.action == 'create-rc'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Create RC Branch and Tag
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          RC_BRANCH="rc/$VERSION"
          if [[ "$VERSION" == *-* ]]; then
            RC_TAG="v$VERSION"
          else
            RC_TAG="v$VERSION-rc"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$RC_BRANCH"
          git tag "$RC_TAG"
          git push origin "$RC_BRANCH" "$RC_TAG"

          echo "âœ… Created RC branch and tag" >> $GITHUB_STEP_SUMMARY

  finalize-release:
    name: Finalize Release (create GitHub release)
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.skip-release != 'true' && (needs.detect.outputs.action == 'finalize-release' || needs.detect.outputs.action == 'simple-release')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: rc/${{ needs.detect.outputs.version }}

      - name: Create Git Tag
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.detect.outputs.version }}
          release_name: Release ${{ needs.detect.outputs.version }}
          body: ${{ inputs.release-notes || 'Release notes will be added here' }}
          draft: ${{ inputs.draft || false }}
          prerelease: ${{ inputs.prerelease || false }}

  hotfix:
    name: Create Hotfix Branch
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.skip-release != 'true' && needs.detect.outputs.action == 'hotfix'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Create Hotfix Branch
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          HOTFIX_BRANCH="hotfix/$VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$HOTFIX_BRANCH"
          git push origin "$HOTFIX_BRANCH"

          echo "âœ… Created hotfix branch: $HOTFIX_BRANCH" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [detect, start-release, create-rc, finalize-release, hotfix]
    if: always() && needs.detect.outputs.skip-release != 'true'

    steps:
      - name: Generate Summary
        run: |
          echo "## Release Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.detect.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ needs.detect.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Completed" >> $GITHUB_STEP_SUMMARY
