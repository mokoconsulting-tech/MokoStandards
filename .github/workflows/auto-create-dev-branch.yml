# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: MokoStandards.Workflows
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/auto-create-dev-branch.yml
# VERSION: 03.01.01
# BRIEF: Automatically creates dev/<version> branch and tracking issue assigned to copilot and jmiller-moko

name: Auto-Create Dev Branch

env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

# MokoStandards Policy Compliance:
# - File formatting: Enforces organizational coding standards
# - Reference: docs/policy/file-formatting.md

# ┌─────────────────────────────────────────────────────────────────────────┐
# │                         WORKFLOW FLOW DIAGRAM                            │
# └─────────────────────────────────────────────────────────────────────────┘
#
#   TRIGGER: PR Merged to Main
#        │
#        ▼
#   ┌──────────────────┐
#   │ Extract Current  │
#   │    Version       │──────┐ Read CHANGELOG.md, VERSION file
#   │ (XX.YY.ZZ)       │      │ or fallback to 03.00.00
#   └──────────────────┘      │
#        │                    │
#        ▼                    │
#   ┌──────────────────┐      │
#   │ Calculate Next   │◀─────┘
#   │    Version       │
#   │ (XX.YY.ZZ+1)     │
#   └──────────────────┘
#        │
#        ├─────────────────────────┐
#        ▼                         ▼
#   ┌──────────────────┐      ┌──────────────────┐
#   │  Create Branch   │      │  Create Issue    │
#   │  dev/XX.YY.ZZ    │      │  "Dev Branch:    │
#   │                  │      │   vXX.YY.ZZ"     │
#   └──────────────────┘      └──────────────────┘
#        │                         │
#        │                         ▼
#        │                    ┌──────────────────┐
#        │                    │ Assign to:       │
#        │                    │ • copilot        │
#        │                    │ • jmiller-moko   │
#        │                    └──────────────────┘
#        │                         │
#        └─────────────┬───────────┘
#                      ▼
#              ┌──────────────┐
#              │   OUTPUTS:   │
#              │ • New Branch │
#              │ • New Issue  │
#              └──────────────┘

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-dev-branch:
    name: Create Development Branch with Version Bump
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          set -x
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract current version
        id: version
        run: |
          set -x
          # Try to extract version from CHANGELOG.md first
          if [ -f "CHANGELOG.md" ]; then
            # Look for version in format [XX.YY.ZZ] or XX.YY.ZZ
            VERSION=$(grep -oP '\[?\d+\.\d+\.\d+\]?' CHANGELOG.md | head -1 | tr -d '[]')
          fi

          # Fallback: Try to find VERSION file or header
          if [ -z "$VERSION" ]; then
            if [ -f "VERSION" ]; then
              VERSION=$(cat VERSION)
            else
              # Look for VERSION: in any markdown file
              VERSION=$(grep -r "^VERSION: " . --include="*.md" | head -1 | grep -oP '\d+\.\d+\.\d+' || echo "03.00.00")
            fi
          fi

          echo "Current version: $VERSION"
          echo "current=$VERSION" >> $GITHUB_OUTPUT

      - name: Calculate next patch version
        id: next_version
        run: |
          set -x
          CURRENT="${{ steps.version.outputs.current }}"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Increment patch version
          NEXT_PATCH=$((PATCH + 1))

          # Format with leading zeros if needed
          if [ ${#MAJOR} -eq 2 ]; then
            # Zero-padded format (XX.YY.ZZ)
            NEXT_VERSION=$(printf "%02d.%02d.%02d" "$MAJOR" "$MINOR" "$NEXT_PATCH")
          else
            # Standard semver format (X.Y.Z)
            NEXT_VERSION="$MAJOR.$MINOR.$NEXT_PATCH"
          fi

          echo "Next version: $NEXT_VERSION"
          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Check if dev branch already exists
        id: check_branch
        run: |
          set -x
          BRANCH_NAME="dev/${{ steps.next_version.outputs.version }}"

          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Branch $BRANCH_NAME already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Branch $BRANCH_NAME does not exist"
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create new dev branch
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          set -x
          BRANCH_NAME="${{ steps.check_branch.outputs.branch_name }}"

          # Create branch from main
          git checkout main
          git pull origin main
          git checkout -b "$BRANCH_NAME"

          # Push new branch
          git push origin "$BRANCH_NAME"

          echo "✅ Created and pushed branch: $BRANCH_NAME"

      - name: Create tracking issue
        if: steps.check_branch.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const nextVersion = '${{ steps.next_version.outputs.version }}';
            const branchName = '${{ steps.check_branch.outputs.branch_name }}';
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;

            const issueBody = `## Development Branch Created

            A new development branch has been automatically created following the merge of PR #${prNumber}.

            ### Details
            - **Branch**: \`${branchName}\`
            - **Version**: ${nextVersion}
            - **Merged PR**: #${prNumber} - ${prTitle}
            - **Created**: ${new Date().toISOString()}

            ### Next Steps
            1. Checkout the new branch: \`git fetch origin && git checkout ${branchName}\`
            2. Begin development for version ${nextVersion}
            3. Create PRs targeting this branch for feature development
            4. When ready, merge this branch to main for release

            ### Branch Strategy
            This branch follows the semantic versioning patch increment strategy. It represents the next patch release after the current version.

            ---

            ## Launch Checklist - Prepare for Merge to Main

            Complete this checklist before merging this dev branch to main. Reference: [Copilot Pre-Merge Checklist Policy](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/policy/copilot-pre-merge-checklist.md)

            ### 1. Version Management ✅
            - [ ] All version numbers updated consistently (VERSION file, package.json, etc.)
            - [ ] Version updated in documentation headers
            - [ ] Version updated in CHANGELOG.md
            - [ ] No version number inconsistencies remain

            ### 2. Changelog Updates ✅
            - [ ] CHANGELOG.md updated with all branch changes
            - [ ] Changes grouped by type (Added, Changed, Fixed, Deprecated, Removed, Security)
            - [ ] Clear descriptions with implementation details
            - [ ] Files affected listed
            - [ ] Proper date format used (YYYY-MM-DD or ISO 8601 UTC)

            ### 3. Code Review Response ✅
            - [ ] All review comments addressed
            - [ ] Requested changes implemented
            - [ ] Explanations provided for declined suggestions
            - [ ] Re-review requested if significant changes made

            ### 4. Security Scanning ✅
            - [ ] CodeQL security analysis completed
            - [ ] Dependency vulnerabilities checked
            - [ ] No secrets/credentials in code
            - [ ] Critical and high severity issues fixed
            - [ ] Accepted risks documented (if any)

            ### 5. Code Quality ✅
            - [ ] All linters pass without errors
            - [ ] Code properly formatted
            - [ ] No compiler warnings
            - [ ] All tests passing
            - [ ] Code coverage meets threshold
            - [ ] Shell scripts validated with shellcheck

            ### 6. Documentation Updates ✅
            - [ ] README updated (if public API changed)
            - [ ] API documentation updated
            - [ ] User guides updated (if features changed)
            - [ ] Code comments accurate and complete
            - [ ] Examples working and updated
            - [ ] Links validated

            ### 7. Drift Detection ✅
            - [ ] Documentation matches implementation
            - [ ] File paths in docs are correct
            - [ ] Code examples validated and working
            - [ ] Workflow inputs match documentation
            - [ ] No outdated information remains

            ### 8. Standards Compliance ✅
            - [ ] File headers present and correct
            - [ ] Tabs used (not spaces) except in YAML/Makefiles
            - [ ] Timestamps use UTC
            - [ ] Revision histories in descending order
            - [ ] Metadata tables complete and accurate
            - [ ] Semantic versioning followed

            ### 9. Release Preparation ✅
            - [ ] Release notes drafted
            - [ ] Breaking changes documented
            - [ ] Migration guide prepared (if needed)
            - [ ] Deployment notes documented
            - [ ] Rollback plan prepared

            ### 10. Final Verification ✅
            - [ ] All PRs to this branch reviewed and merged
            - [ ] No pending issues blocking release
            - [ ] Stakeholders notified of upcoming merge
            - [ ] Final PR to main created and ready for review
            - [ ] All checklist items above completed

            ---

            *This issue was automatically created by the auto-create-dev-branch workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Development Branch: ${branchName}`,
              body: issueBody,
              labels: ['automation', 'version-management', 'dev-branch'],
              assignees: ['copilot', 'jmiller-moko']
            });

      - name: Comment on merged PR
        if: steps.check_branch.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.check_branch.outputs.branch_name }}';
            const nextVersion = '${{ steps.next_version.outputs.version }}';

            const comment = `## ✅ Development Branch Created

            A new development branch has been automatically created:
            - **Branch**: \`${branchName}\`
            - **Version**: ${nextVersion}

            You can checkout this branch with:
            \`\`\`bash
            git fetch origin
            git checkout ${branchName}
            \`\`\`

            This branch is ready for the next development cycle.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Branch already exists notification
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.check_branch.outputs.branch_name }}';

            const comment = `## ℹ️ Development Branch Already Exists

            The development branch \`${branchName}\` already exists.

            No new branch was created. Continue development on the existing branch.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Workflow summary
        run: |
          set -x
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: ${{ steps.version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Next Version**: ${{ steps.next_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch Name**: \`${{ steps.check_branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_branch.outputs.exists }}" == "false" ]; then
            echo "- **Status**: ✅ Branch created successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ℹ️ Branch already exists" >> $GITHUB_STEP_SUMMARY
          fi
