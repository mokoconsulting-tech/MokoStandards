# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/branch-cleanup.yml
# VERSION: 01.00.00
# BRIEF: Clean up stale and merged branches in the repository
# NOTE: Runs monthly or manually, uses centralized workflow from .github-private

name: Branch Cleanup

on:
  # Run monthly on the 15th at 02:00 UTC
  schedule:
    - cron: '0 2 15 * *'

  # Allow manual triggering with options
  workflow_dispatch:
    inputs:
      stale-days:
        description: 'Days before branch is considered stale'
        required: false
        type: number
        default: 90
      delete-merged:
        description: 'Delete merged branches'
        required: false
        type: boolean
        default: true
      delete-stale:
        description: 'Delete stale branches'
        required: false
        type: boolean
        default: true
      dry-run:
        description: 'Preview changes without deleting'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  cleanup:
    name: Cleanup Branches
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history to check branch age

      - name: Setup environment
        id: setup
        run: |
          # Set input values with defaults
          STALE_DAYS="${{ inputs.stale-days || 90 }}"
          DELETE_MERGED="${{ inputs.delete-merged != false }}"
          DELETE_STALE="${{ inputs.delete-stale != false }}"
          DRY_RUN="${{ inputs.dry-run == true }}"

          echo "stale-days=$STALE_DAYS" >> $GITHUB_OUTPUT
          echo "delete-merged=$DELETE_MERGED" >> $GITHUB_OUTPUT
          echo "delete-stale=$DELETE_STALE" >> $GITHUB_OUTPUT
          echo "dry-run=$DRY_RUN" >> $GITHUB_OUTPUT

          echo "## Branch Cleanup Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Stale Days Threshold:** $STALE_DAYS" >> $GITHUB_STEP_SUMMARY
          echo "- **Delete Merged Branches:** $DELETE_MERGED" >> $GITHUB_STEP_SUMMARY
          echo "- **Delete Stale Branches:** $DELETE_STALE" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run Mode:** $DRY_RUN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Verify GitHub token availability
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verify token is available before attempting authentication
          if [ -z "$GH_TOKEN" ]; then
            echo "## âŒ Error: GitHub Token Not Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "GITHUB_TOKEN is required for this workflow." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # GH_TOKEN environment variable is automatically used by GitHub CLI
          # Verify authentication status
          if gh auth status 2>&1 || true; then
            echo "âœ… GitHub CLI authentication verified" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Find and cleanup branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STALE_DAYS: ${{ steps.setup.outputs.stale-days }}
          DELETE_MERGED: ${{ steps.setup.outputs.delete-merged }}
          DELETE_STALE: ${{ steps.setup.outputs.delete-stale }}
          DRY_RUN: ${{ steps.setup.outputs.dry-run }}
        run: |
          set -e

          # Protected branch patterns
          EXCLUDE_PATTERNS=("main" "master" "develop" "dev" "staging" "production")
          EXCLUDE_PREFIXES=("dependabot/" "renovate/" "copilot/" "dev/" "rc/" "release/")

          echo "## Branch Cleanup Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detect default branch dynamically
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          echo "**Default Branch:** \`$DEFAULT_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to check if branch is protected
          is_protected() {
            local branch="$1"

            # Check exact matches
            for pattern in "${EXCLUDE_PATTERNS[@]}"; do
              if [ "$branch" = "$pattern" ]; then
                return 0
              fi
            done

            # Check prefixes
            for prefix in "${EXCLUDE_PREFIXES[@]}"; do
              if [[ "$branch" == "$prefix"* ]]; then
                return 0
              fi
            done

            return 1
          }

          # Fetch all remote branches
          git fetch --all --prune

          MERGED_COUNT=0
          STALE_COUNT=0
          PROTECTED_COUNT=0
          ERROR_COUNT=0

          # Get current date in seconds
          CURRENT_DATE=$(date +%s)
          STALE_THRESHOLD=$((CURRENT_DATE - (STALE_DAYS * 86400)))

          # List all remote branches except HEAD
          for branch in $(git branch -r | grep -v 'HEAD' | sed 's/origin\///'); do
            # Skip if protected
            if is_protected "$branch"; then
              ((PROTECTED_COUNT++))
              continue
            fi

            # Check if branch is merged into default branch
            IS_MERGED=false
            if [ "$DELETE_MERGED" = "true" ]; then
              if git branch -r --merged "origin/$DEFAULT_BRANCH" | grep -q "origin/$branch"; then
                IS_MERGED=true
              fi
            fi

            # Check if branch is stale
            IS_STALE=false
            if [ "$DELETE_STALE" = "true" ] && [ "$IS_MERGED" = "false" ]; then
              LAST_COMMIT_DATE=$(git log -1 --format=%ct "origin/$branch" 2>/dev/null || echo "0")
              if [ "$LAST_COMMIT_DATE" -lt "$STALE_THRESHOLD" ] && [ "$LAST_COMMIT_DATE" -ne "0" ]; then
                IS_STALE=true
              fi
            fi

            # Delete if merged or stale
            if [ "$IS_MERGED" = "true" ] || [ "$IS_STALE" = "true" ]; then
              REASON="unknown"
              if [ "$IS_MERGED" = "true" ]; then
                REASON="merged"
                ((MERGED_COUNT++))
              elif [ "$IS_STALE" = "true" ]; then
                REASON="stale (no commits for $STALE_DAYS days)"
                ((STALE_COUNT++))
              fi

              if [ "$DRY_RUN" = "true" ]; then
                echo "- ðŸ” **Would delete:** \`$branch\` ($REASON)" >> $GITHUB_STEP_SUMMARY
              else
                if gh api --method DELETE "/repos/${{ github.repository }}/git/refs/heads/$branch" 2>&1; then
                  echo "- âœ… **Deleted:** \`$branch\` ($REASON)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- âŒ **Failed to delete:** \`$branch\` ($REASON)" >> $GITHUB_STEP_SUMMARY
                  ((ERROR_COUNT++))
                fi
              fi
            fi
          done

          # Summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" = "true" ]; then
            echo "**Mode:** Dry Run (no branches were deleted)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Merged branches:** $MERGED_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Stale branches:** $STALE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Protected branches (skipped):** $PROTECTED_COUNT" >> $GITHUB_STEP_SUMMARY
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "- **Errors:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$ERROR_COUNT" -gt 0 ] && [ "$DRY_RUN" = "false" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Some branches could not be deleted. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Report completion
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
