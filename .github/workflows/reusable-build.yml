# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Reusable
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/reusable-build.yml
# VERSION: 01.00.00
# BRIEF: Reusable type-aware build workflow for Joomla, Dolibarr, and generic projects
# NOTE: Automatically detects project type and applies appropriate build steps

name: Reusable Build

on:
  workflow_call:
    inputs:
      php-version:
        description: 'PHP version to use for build'
        required: false
        type: string
        default: '8.1'
      node-version:
        description: 'Node.js version to use for build'
        required: false
        type: string
        default: '20.x'
      dotnet-version:
        description: '.NET SDK version to use for build'
        required: false
        type: string
        default: '8.0.x'
      working-directory:
        description: 'Working directory for build'
        required: false
        type: string
        default: '.'
      upload-artifacts:
        description: 'Upload build artifacts'
        required: false
        type: boolean
        default: true
      artifact-name:
        description: 'Name for uploaded artifacts'
        required: false
        type: string
        default: 'build-artifacts'

permissions:
  contents: read

jobs:
  detect:
    name: Detect Project Type
    permissions:
      contents: read
    uses: ./.github/workflows/reusable-project-detector.yml
    with:
      working-directory: ${{ inputs.working-directory }}

  build:
    name: Build (${{ needs.detect.outputs.project-type }})
    runs-on: ubuntu-latest
    needs: detect

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup PHP
        if: needs.detect.outputs.has-php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          extensions: mbstring, xml, zip, json
          tools: composer:v2

      - name: Setup Node.js
        if: needs.detect.outputs.has-node == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node-version }}

      - name: Setup .NET
        if: needs.detect.outputs.has-dotnet == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Get Composer cache directory
        if: needs.detect.outputs.has-php == 'true'
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        if: needs.detect.outputs.has-php == 'true'
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Cache Node modules
        if: needs.detect.outputs.has-node == 'true'
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Cache NuGet packages
        if: needs.detect.outputs.has-dotnet == 'true'
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Install PHP dependencies
        if: needs.detect.outputs.has-php == 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f "composer.json" ]; then
            composer install --prefer-dist --no-progress --no-interaction
            echo "âœ… Composer dependencies installed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Install Node dependencies
        if: needs.detect.outputs.has-node == 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f "package.json" ]; then
            npm ci
            echo "âœ… npm dependencies installed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Restore .NET dependencies
        if: needs.detect.outputs.has-dotnet == 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          if find . -name "*.csproj" -type f 2>/dev/null | grep -q .; then
            dotnet restore
            echo "âœ… .NET dependencies restored" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Build Joomla Extension
        if: needs.detect.outputs.project-type == 'joomla'
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### ðŸ—ï¸ Building Joomla Extension" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Extension Type:** ${{ needs.detect.outputs.extension-type }}" >> $GITHUB_STEP_SUMMARY

          # Run npm build if package.json has build script
          if [ -f "package.json" ] && grep -q '"build"' package.json; then
            echo "Running npm build..."
            npm run build
            echo "- âœ… npm build completed" >> $GITHUB_STEP_SUMMARY
          fi

          # Run composer scripts if available
          if [ -f "composer.json" ] && grep -q '"build"' composer.json; then
            echo "Running composer build..."
            composer run-script build
            echo "- âœ… composer build completed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- âœ… Joomla extension build completed" >> $GITHUB_STEP_SUMMARY

      - name: Build Dolibarr Module
        if: needs.detect.outputs.project-type == 'dolibarr'
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### ðŸ—ï¸ Building Dolibarr Module" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run npm build if available
          if [ -f "package.json" ] && grep -q '"build"' package.json; then
            echo "Running npm build..."
            npm run build
            echo "- âœ… npm build completed" >> $GITHUB_STEP_SUMMARY
          fi

          # Install Dolibarr-specific dependencies
          if [ -f "composer.json" ]; then
            composer install --no-dev --optimize-autoloader
            echo "- âœ… Production dependencies installed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- âœ… Dolibarr module build completed" >> $GITHUB_STEP_SUMMARY

      - name: Build Generic Project
        if: needs.detect.outputs.project-type == 'generic'
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### ðŸ—ï¸ Building Generic Project" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Try various build methods
          if [ -f "package.json" ] && grep -q '"build"' package.json; then
            npm run build
            echo "- âœ… npm build completed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "Makefile" ]; then
            make build 2>/dev/null || echo "- â„¹ï¸ Makefile build not available" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- âœ… Generic project build completed" >> $GITHUB_STEP_SUMMARY

      - name: Build C# Project
        if: needs.detect.outputs.project-type == 'csharp'
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### ðŸ—ï¸ Building C# Project" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build all solutions or projects
          if find . -name "*.sln" -type f 2>/dev/null | grep -q .; then
            for sln in $(find . -name "*.sln" -type f); do
              echo "Building solution: $sln"
              dotnet build "$sln" --configuration Release
              echo "- âœ… Built solution: $(basename $sln)" >> $GITHUB_STEP_SUMMARY
            done
          elif find . -name "*.csproj" -type f 2>/dev/null | grep -q .; then
            for proj in $(find . -name "*.csproj" -type f -not -path "*/bin/*" -not -path "*/obj/*"); do
              echo "Building project: $proj"
              dotnet build "$proj" --configuration Release
              echo "- âœ… Built project: $(basename $proj)" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "- âœ… C# project build completed" >> $GITHUB_STEP_SUMMARY

      - name: Verify build output
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### ðŸ“¦ Build Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for common build output directories
          for dir in dist build public out bin/Release; do
            if [ -d "$dir" ]; then
              echo "- âœ… Found build output: \`$dir/\`" >> $GITHUB_STEP_SUMMARY
              # Note: du may fail on permission issues or broken symlinks
              if ! du -sh "$dir" 2>/dev/null >> $GITHUB_STEP_SUMMARY; then
                echo "  (size information unavailable)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Upload build artifacts
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.artifact-name }}-${{ needs.detect.outputs.project-type }}
          path: |
            ${{ inputs.working-directory }}/dist/
            ${{ inputs.working-directory }}/build/
            ${{ inputs.working-directory }}/public/
            ${{ inputs.working-directory }}/out/
            ${{ inputs.working-directory }}/bin/Release/
          retention-days: 7
          if-no-files-found: ignore
