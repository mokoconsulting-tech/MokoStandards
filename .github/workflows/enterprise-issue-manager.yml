# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later

name: Enterprise Issue Manager

env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

# MokoStandards Policy Compliance:
# - File formatting: Enforces organizational coding standards
# - Reference: docs/policy/file-formatting.md

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW FLOW DIAGRAM                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER (PR/Issue/Manual)
#        â”‚
#        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#        â”‚                                                   â”‚
#        â–¼                                                   â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Load Config â”‚                                  â”‚   Validate   â”‚
#   â”‚   & Parse   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    Config    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚
#        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#        â”‚            â”‚             â”‚              â”‚             â”‚
#        â–¼            â–¼             â–¼              â–¼             â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚   PR    â”‚  â”‚ Issue  â”‚  â”‚  Link    â”‚  â”‚  Auto    â”‚  â”‚  Report  â”‚
#   â”‚Lifecycleâ”‚  â”‚Lifecycle  â”‚  PR to   â”‚  â”‚  Close   â”‚  â”‚Generator â”‚
#   â”‚         â”‚  â”‚        â”‚  â”‚  Issue   â”‚  â”‚ on Merge â”‚  â”‚          â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#        â”‚            â”‚             â”‚              â”‚             â”‚
#        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                   â”‚
#                                   â–¼
#                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                          â”‚    OUTPUTS:     â”‚
#                          â”‚  â€¢ Updated PR   â”‚
#                          â”‚  â€¢ Closed Issue â”‚
#                          â”‚  â€¢ Summary      â”‚
#                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  pull_request:
    types: [opened, closed, reopened, ready_for_review]
  delete:
  issues:
    types: [opened, edited, closed, reopened]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - 'audit'
          - 'sync-all'
          - 'generate-report'
          - 'validate-config'

permissions:
  issues: write
  pull-requests: write
  contents: read
  repository-projects: write

jobs:
  # Load configuration and validate
  load-config:
    name: Load Configuration
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.load.outputs.config }}
      is_valid: ${{ steps.validate.outputs.is_valid }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Load configuration
        id: load
        run: |
          set -x
          if [ -f ".github/issue-management-config.yml" ]; then
            echo "Configuration file found"
            CONFIG=$(cat .github/issue-management-config.yml)
            # Export as JSON for use in other jobs
            echo "config<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFIG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "::error::Configuration file not found"
            exit 1
          fi

      - name: Validate configuration
        id: validate
        run: |
          set -x
          # Basic validation - check for required fields
          if grep -q "version:" .github/issue-management-config.yml && \
             grep -q "enterprise:" .github/issue-management-config.yml; then
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… Configuration is valid"
          else
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "::warning::Configuration validation failed"
          fi

  # Handle PR lifecycle
  pr-lifecycle:
    name: PR Lifecycle Management
    runs-on: ubuntu-latest
    needs: load-config
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Determine PR action
        id: pr_action
        run: |
          set -x
          ACTION="${{ github.event.action }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          IS_MERGED="${{ github.event.pull_request.merged }}"

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "head_branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT
          echo "is_merged=$IS_MERGED" >> $GITHUB_OUTPUT

          # Determine if this is a dev/rc branch
          if [[ "$BASE_BRANCH" =~ ^(dev|rc)/ ]]; then
            echo "is_tracked_branch=true" >> $GITHUB_OUTPUT
          else
            echo "is_tracked_branch=false" >> $GITHUB_OUTPUT
          fi

      - name: Find parent tracking issue
        id: find_issue
        if: steps.pr_action.outputs.is_tracked_branch == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseBranch = '${{ steps.pr_action.outputs.base_branch }}';

            try {
              // Search for tracking issue with retry logic
              let attempt = 0;
              const maxRetries = 3;
              let issues = null;

              while (attempt < maxRetries) {
                try {
                  const response = await github.rest.issues.listForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'open',
                    labels: 'dev-branch',
                    per_page: 100
                  });
                  issues = response.data;
                  break;
                } catch (error) {
                  attempt++;
                  if (attempt >= maxRetries) throw error;
                  await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
                }
              }

              // Find issue matching the base branch
              const trackingIssue = issues.find(issue =>
                issue.title.includes(baseBranch) ||
                issue.body.includes(`\`${baseBranch}\``)
              );

              if (trackingIssue) {
                core.setOutput('found', 'true');
                core.setOutput('issue_number', trackingIssue.number);
                core.setOutput('issue_title', trackingIssue.title);
                console.log(`âœ… Found tracking issue #${trackingIssue.number}`);

                // Log to audit trail
                core.info(JSON.stringify({
                  timestamp: new Date().toISOString(),
                  event: 'tracking_issue_found',
                  issue_number: trackingIssue.number,
                  branch: baseBranch,
                  pr_number: context.payload.pull_request.number
                }));
              } else {
                core.setOutput('found', 'false');
                console.log(`â„¹ï¸ No tracking issue found for branch ${baseBranch}`);
              }
            } catch (error) {
              core.setOutput('found', 'false');
              core.error(`Error finding tracking issue: ${error.message}`);
              // Don't fail the workflow - graceful degradation
            }

      - name: Link PR to tracking issue
        if: |
          steps.pr_action.outputs.action == 'opened' &&
          steps.find_issue.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          retries: 3
          script: |
            const issueNumber = parseInt('${{ steps.find_issue.outputs.issue_number }}');
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prAuthor = context.payload.pull_request.user.login;

            try {
              // Get current issue body
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              let body = issue.data.body || '';

              // Add PR as a checklist item
              const prEntry = `- [ ] #${prNumber} - ${prTitle} (@${prAuthor})`;

              if (!body.includes(`#${prNumber}`)) {
                // Find the PR tracking section (match until next --- or end of document)
                const prSectionMatch = body.match(/(### ğŸ“ Pull Requests.*?)(\n---\n|$)/s);

                if (prSectionMatch) {
                  // Insert PR entry at the end of the PR section
                  const prSection = prSectionMatch[1];
                  const updatedPrSection = prSection.trimEnd() + `\n${prEntry}\n`;
                  body = body.replace(prSectionMatch[1], updatedPrSection);
                } else {
                  // PR section doesn't exist, add it before the final separator
                  const prSection = `\n\n### ğŸ“ Pull Requests\n\n` +
                    `This section tracks all PRs associated with this branch:\n\n${prEntry}\n`;

                  // Find the last --- separator and insert before it
                  const lastSeparatorIndex = body.lastIndexOf('\n---\n');
                  if (lastSeparatorIndex !== -1) {
                    body = body.substring(0, lastSeparatorIndex) + prSection + body.substring(lastSeparatorIndex);
                  } else {
                    body += prSection;
                  }
                }

                // Update issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: body
                });

                console.log(`âœ… Linked PR #${prNumber} to issue #${issueNumber}`);

                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `ğŸ”— **PR Opened**: #${prNumber} - ${prTitle}\n\nOpened by @${prAuthor}`
                });

                // Log to audit trail
                core.info(JSON.stringify({
                  timestamp: new Date().toISOString(),
                  event: 'pr_linked_to_issue',
                  issue_number: issueNumber,
                  pr_number: prNumber,
                  action: 'linked'
                }));
              }
            } catch (error) {
              core.error(`Error linking PR to issue: ${error.message}`);
              // Continue workflow - don't fail on this error
            }

      - name: Mark PR as completed in tracking issue
        if: |
          steps.pr_action.outputs.action == 'closed' &&
          steps.pr_action.outputs.is_merged == 'true' &&
          steps.find_issue.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          retries: 3
          script: |
            const issueNumber = parseInt('${{ steps.find_issue.outputs.issue_number }}');
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const mergedBy = context.payload.pull_request.merged_by.login;

            try {
              // Get current issue body
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              let body = issue.data.body || '';

              // Update checklist item from [ ] to [x]
              const uncheckedPattern = new RegExp(`- \\[ \\] #${prNumber}`, 'g');
              body = body.replace(uncheckedPattern, `- [x] #${prNumber}`);

              // Update issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });

              console.log(`âœ… Marked PR #${prNumber} as completed in issue #${issueNumber}`);

              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âœ… **PR Merged**: #${prNumber} - ${prTitle}\n\nMerged by @${mergedBy}`
              });

              // Log to audit trail
              core.info(JSON.stringify({
                timestamp: new Date().toISOString(),
                event: 'pr_completed_in_issue',
                issue_number: issueNumber,
                pr_number: prNumber,
                merged_by: mergedBy
              }));
            } catch (error) {
              core.error(`Error updating PR status in issue: ${error.message}`);
            }

      - name: Close tracking issue on branch merge
        if: |
          steps.pr_action.outputs.action == 'closed' &&
          steps.pr_action.outputs.is_merged == 'true' &&
          steps.pr_action.outputs.base_branch == 'main' &&
          steps.find_issue.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          retries: 3
          script: |
            const issueNumber = parseInt('${{ steps.find_issue.outputs.issue_number }}');
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const mergedBy = context.payload.pull_request.merged_by.login;
            const branchName = '${{ steps.pr_action.outputs.head_branch }}';

            try {
              // Create comprehensive closing comment
              const closeComment = [
                '## ğŸ‰ Branch Lifecycle Complete',
                '',
                `**Branch**: \`${branchName}\` has been merged to main via PR #${prNumber}.`,
                '',
                '### Merge Details',
                `- **PR**: #${prNumber} - ${prTitle}`,
                `- **Merged by**: @${mergedBy}`,
                `- **Merged at**: ${new Date().toISOString()}`,
                '',
                '### ğŸ Development Cycle Completed',
                '',
                'This branch has completed its development cycle and been integrated into the main branch.',
                '',
                '---',
                '',
                '*This issue was automatically closed by the Enterprise Issue Manager workflow.*'
              ].join('\n');

              // Add closing comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: closeComment
              });

              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed',
                state_reason: 'completed'
              });

              console.log(`âœ… Closed tracking issue #${issueNumber}`);

              // Log to audit trail
              core.info(JSON.stringify({
                timestamp: new Date().toISOString(),
                event: 'tracking_issue_closed',
                issue_number: issueNumber,
                branch: branchName,
                pr_number: prNumber,
                reason: 'branch_merged_to_main'
              }));
            } catch (error) {
              core.error(`Error closing tracking issue: ${error.message}`);
            }

  # Handle branch deletion
  branch-deletion:
    name: Handle Branch Deletion
    runs-on: ubuntu-latest
    needs: load-config
    if: github.event_name == 'delete'

    steps:
      - name: Find and close tracking issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          retries: 3
          script: |
            const branchName = context.payload.ref;

            // Only process dev/rc branches
            if (!branchName.startsWith('dev/') && !branchName.startsWith('rc/')) {
              console.log(`â„¹ï¸ Branch ${branchName} is not a tracked branch type`);
              return;
            }

            try {
              // Find tracking issue
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dev-branch',
                per_page: 100
              });

              const trackingIssue = issues.data.find(issue =>
                issue.title.includes(branchName) ||
                issue.body.includes(`\`${branchName}\``)
              );

              if (trackingIssue) {
                // Close with deletion message
                const closeComment = [
                  '## ğŸ—‘ï¸ Branch Deleted',
                  '',
                  `The branch \`${branchName}\` has been deleted.`,
                  '',
                  '### Deletion Details',
                  `- **Deleted by**: @${context.actor}`,
                  `- **Deleted at**: ${new Date().toISOString()}`,
                  '',
                  'This tracking issue is now closed.',
                  '',
                  '---',
                  '',
                  '*This issue was automatically closed by the Enterprise Issue Manager workflow.*'
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: trackingIssue.number,
                  body: closeComment
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: trackingIssue.number,
                  state: 'closed',
                  state_reason: 'not_planned'
                });

                console.log(`âœ… Closed issue #${trackingIssue.number} for deleted branch`);

                // Audit log
                core.info(JSON.stringify({
                  timestamp: new Date().toISOString(),
                  event: 'tracking_issue_closed',
                  issue_number: trackingIssue.number,
                  branch: branchName,
                  reason: 'branch_deleted'
                }));
              }
            } catch (error) {
              core.error(`Error handling branch deletion: ${error.message}`);
            }

  # Generate summary report
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [load-config, pr-lifecycle, branch-deletion]
    if: always()

    steps:
      - name: Generate summary
        run: |
          set -x
          echo "## ğŸ“Š Enterprise Issue Manager Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration loaded: ${{ needs.load-config.outputs.is_valid }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Performed" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "- PR lifecycle management executed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" == "delete" ]; then
            echo "- Branch deletion handling executed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Enterprise Issue Manager v1.0.0_" >> $GITHUB_STEP_SUMMARY
