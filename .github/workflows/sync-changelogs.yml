# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Automation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/sync-changelogs.yml
# VERSION: 01.00.00
# BRIEF: Synchronize CHANGELOG files between root and src directory for Dolibarr modules
# NOTE: Automatically detects changes and syncs content bidirectionally

name: Sync CHANGELOG Files

on:
  push:
    branches:
      - main
      - dev/**
      - rc/**
    paths:
      - 'CHANGELOG.md'
      - 'src/CHANGELOG.md'
  pull_request:
    paths:
      - 'CHANGELOG.md'
      - 'src/CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-changelogs:
    name: Synchronize CHANGELOG Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check if both CHANGELOG files exist
        id: check-files
        run: |
          ROOT_EXISTS=false
          SRC_EXISTS=false
          
          if [ -f "CHANGELOG.md" ]; then
            ROOT_EXISTS=true
            echo "Root CHANGELOG.md exists"
          fi
          
          if [ -f "src/CHANGELOG.md" ]; then
            SRC_EXISTS=true
            echo "src/CHANGELOG.md exists"
          fi
          
          echo "root_exists=$ROOT_EXISTS" >> $GITHUB_OUTPUT
          echo "src_exists=$SRC_EXISTS" >> $GITHUB_OUTPUT
      
      - name: Detect which file was changed
        id: detect-change
        if: steps.check-files.outputs.root_exists == 'true' && steps.check-files.outputs.src_exists == 'true'
        run: |
          # Get the list of changed files in this push/PR
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            # Handle initial commit or new branch
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            else
              # First commit - check all files
              CHANGED_FILES=$(git ls-files)
            fi
          fi
          
          ROOT_CHANGED=false
          SRC_CHANGED=false
          
          if echo "$CHANGED_FILES" | grep -q "^CHANGELOG.md$"; then
            ROOT_CHANGED=true
            echo "Root CHANGELOG.md was changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^src/CHANGELOG.md$"; then
            SRC_CHANGED=true
            echo "src/CHANGELOG.md was changed"
          fi
          
          echo "root_changed=$ROOT_CHANGED" >> $GITHUB_OUTPUT
          echo "src_changed=$SRC_CHANGED" >> $GITHUB_OUTPUT
      
      - name: Check if files are already in sync
        id: check-sync
        if: steps.check-files.outputs.root_exists == 'true' && steps.check-files.outputs.src_exists == 'true'
        run: |
          if diff -q CHANGELOG.md src/CHANGELOG.md > /dev/null 2>&1; then
            echo "in_sync=true" >> $GITHUB_OUTPUT
            echo "CHANGELOG files are already in sync"
          else
            echo "in_sync=false" >> $GITHUB_OUTPUT
            echo "CHANGELOG files are out of sync"
          fi
      
      - name: Sync root CHANGELOG to src
        if: |
          steps.check-files.outputs.root_exists == 'true' && 
          steps.check-files.outputs.src_exists == 'true' &&
          steps.check-sync.outputs.in_sync == 'false' &&
          steps.detect-change.outputs.root_changed == 'true' &&
          steps.detect-change.outputs.src_changed == 'false'
        run: |
          echo "Syncing root CHANGELOG.md to src/CHANGELOG.md"
          cp CHANGELOG.md src/CHANGELOG.md
          echo "sync_direction=root-to-src" >> $GITHUB_ENV
      
      - name: Sync src CHANGELOG to root
        if: |
          steps.check-files.outputs.root_exists == 'true' && 
          steps.check-files.outputs.src_exists == 'true' &&
          steps.check-sync.outputs.in_sync == 'false' &&
          steps.detect-change.outputs.root_changed == 'false' &&
          steps.detect-change.outputs.src_changed == 'true'
        run: |
          echo "Syncing src/CHANGELOG.md to root CHANGELOG.md"
          cp src/CHANGELOG.md CHANGELOG.md
          echo "sync_direction=src-to-root" >> $GITHUB_ENV
      
      - name: Handle conflict (both files changed)
        if: |
          steps.check-files.outputs.root_exists == 'true' && 
          steps.check-files.outputs.src_exists == 'true' &&
          steps.check-sync.outputs.in_sync == 'false' &&
          steps.detect-change.outputs.root_changed == 'true' &&
          steps.detect-change.outputs.src_changed == 'true'
        run: |
          echo "⚠️  Both CHANGELOG files were modified in this commit"
          echo "This requires manual resolution. Please ensure both files have the same content."
          echo ""
          echo "To resolve:"
          echo "  1. Choose which version to keep:"
          echo "     - Use root as source: cp CHANGELOG.md src/CHANGELOG.md"
          echo "     - Use src as source: cp src/CHANGELOG.md CHANGELOG.md"
          echo "  2. Commit the resolved files: git add CHANGELOG.md src/CHANGELOG.md"
          echo "  3. Commit: git commit -m 'docs: resolve CHANGELOG sync conflict'"
          echo "  4. Push: git push"
          echo "sync_direction=conflict" >> $GITHUB_ENV
          exit 1
      
      - name: Commit synchronized changes
        if: env.sync_direction != 'conflict' && env.sync_direction != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No changes to commit"
          else
            if [ "$sync_direction" == "root-to-src" ]; then
              git add src/CHANGELOG.md
              git commit -m "chore: sync CHANGELOG from root to src directory [automated]"
            elif [ "$sync_direction" == "src-to-root" ]; then
              git add CHANGELOG.md
              git commit -m "chore: sync CHANGELOG from src to root directory [automated]"
            fi
            
            # Push changes with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            PUSH_SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$PUSH_SUCCESS" == "false" ]; do
              if git push; then
                PUSH_SUCCESS=true
                echo "Successfully pushed changes"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 2
                  git pull --rebase
                else
                  echo "Failed to push after $MAX_RETRIES attempts"
                  echo "This may be due to protected branch settings or concurrent pushes"
                  echo "Please manually sync and push the changes"
                  exit 1
                fi
              fi
            done
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "### CHANGELOG Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-files.outputs.root_exists }}" == "true" ] && [ "${{ steps.check-files.outputs.src_exists }}" == "true" ]; then
            if [ "${{ steps.check-sync.outputs.in_sync }}" == "true" ]; then
              echo "✅ CHANGELOG files are in sync" >> $GITHUB_STEP_SUMMARY
            elif [ "$sync_direction" == "root-to-src" ]; then
              echo "✅ Synced root CHANGELOG.md → src/CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
            elif [ "$sync_direction" == "src-to-root" ]; then
              echo "✅ Synced src/CHANGELOG.md → root CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
            elif [ "$sync_direction" == "conflict" ]; then
              echo "⚠️  Both CHANGELOG files were modified - manual resolution required" >> $GITHUB_STEP_SUMMARY
            else
              echo "ℹ️  No sync needed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ steps.check-files.outputs.root_exists }}" == "false" ]; then
              echo "ℹ️  Root CHANGELOG.md not found" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ steps.check-files.outputs.src_exists }}" == "false" ]; then
              echo "ℹ️  src/CHANGELOG.md not found" >> $GITHUB_STEP_SUMMARY
            fi
          fi
