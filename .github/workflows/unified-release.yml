# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Release
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/unified-release.yml
# VERSION: 01.01.00
# BRIEF: Unified release pipeline consolidating all release workflows and scripts
# NOTE: Supports auto, manual, and file-based triggers with multi-stage release flow
#
# RELATED FILES:
# - .github/workflows/reusable-release.yml - Called by this workflow for build/package
# - docs/release-management/README.md - Detailed release procedures and guidelines
# - docs/policy/governance/release-management.md - Release management policy
# - .github/WORKFLOW_ARCHITECTURE.md - Overall workflow architecture patterns
#
# WORKFLOW SELECTION:
# - For all release scenarios, use this workflow (unified-release.yml)
# - This is the PRIMARY and ONLY release orchestration workflow
# - Replaces deprecated: release-cycle.yml (removed), auto-release.yml (disabled)
#
# QUICK START:
# - Automatic: Update version in CITATION.cff, pyproject.toml, or CHANGELOG.md â†’ push to main
# - Manual: Actions â†’ Unified Release Pipeline â†’ Run workflow â†’ Choose action
# - See usage examples at end of file for detailed scenarios

name: Unified Release Pipeline

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         WORKFLOW ARCHITECTURE                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   TRIGGER OPTIONS:
#   1. Push to main â†’ Auto-detect version from files â†’ Create release
#   2. Manual dispatch â†’ Specify version/type â†’ Execute release action
#   3. Version file change â†’ Detect change â†’ Create release
#
#   RELEASE FLOW:
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚   Trigger    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Detect Mode  â”‚â”€â”€â”€â”€â”€â†’â”‚ Version Source  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â€¢ File diff     â”‚
#          â”‚              â”‚ â€¢ Manual input  â”‚
#          â”‚              â”‚ â€¢ Commit msgs   â”‚
#          â–¼              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Validate     â”‚
#   â”‚ Version      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚   Action Selection           â”‚
#   â”‚ â€¢ start-dev (dev branch)     â”‚
#   â”‚ â€¢ create-rc (RC + tag)       â”‚
#   â”‚ â€¢ finalize (stable release)  â”‚
#   â”‚ â€¢ hotfix (emergency fix)     â”‚
#   â”‚ â€¢ simple-release (one-step)  â”‚
#   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Build &      â”‚â”€â”€â”€â”€â”€â†’â”‚ Create Package  â”‚
#   â”‚ Package      â”‚      â”‚ (reusable-      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  release.yml)   â”‚
#          â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ Create       â”‚
#   â”‚ GitHub       â”‚
#   â”‚ Release      â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  # Auto-release on push to main (file-based version detection)
  push:
    branches:
      - main
    paths:
      - 'CITATION.cff'
      - 'pyproject.toml'
      - 'CHANGELOG.md'

  # Manual release with full control
  workflow_dispatch:
    inputs:
      action:
        description: 'Release action to perform'
        required: true
        type: choice
        options:
          - simple-release      # One-step release (auto-detect or specify version)
          - start-dev          # Start dev branch for version
          - create-rc          # Create release candidate from dev
          - finalize-release   # Finalize RC to stable release
          - hotfix             # Emergency hotfix release
        default: 'simple-release'

      version:
        description: 'Version (e.g., 1.2.3 or 1.2.3-rc1). Leave empty for auto-detect.'
        required: false
        type: string

      version-bump:
        description: 'Auto version bump type (if version not specified)'
        required: false
        type: choice
        options:
          - auto    # Detect from commit messages
          - major   # X.0.0
          - minor   # 0.X.0
          - patch   # 0.0.X
        default: 'auto'

      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: false

      skip-build:
        description: 'Skip package building (tag and branch only)'
        required: false
        type: boolean
        default: false

      release-notes:
        description: 'Custom release notes (optional, auto-generated if empty)'
        required: false
        type: string

env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

permissions:
  contents: write
  pull-requests: write
  deployments: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB: Detect Release Mode and Version
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect:
    name: Detect Version & Mode
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine.outputs.version }}
      base-version: ${{ steps.determine.outputs.base-version }}
      major: ${{ steps.determine.outputs.major }}
      minor: ${{ steps.determine.outputs.minor }}
      patch: ${{ steps.determine.outputs.patch }}
      prerelease-suffix: ${{ steps.determine.outputs.prerelease-suffix }}
      is-prerelease: ${{ steps.determine.outputs.is-prerelease }}
      action: ${{ steps.determine.outputs.action }}
      version-source: ${{ steps.determine.outputs.version-source }}
      skip-release: ${{ steps.determine.outputs.skip-release }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine Version and Action
        id: determine
        run: |
          set -e

          echo "## Version Detection" >> $GITHUB_STEP_SUMMARY

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Determine release action
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ inputs.action }}"
            echo "ğŸ“‹ **Mode**: Manual dispatch" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ¯ **Action**: $ACTION" >> $GITHUB_STEP_SUMMARY
          else
            # Auto-release on push to main
            ACTION="simple-release"
            echo "ğŸ“‹ **Mode**: Automatic (push to main)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Check for skip release flag in commit message
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" =~ \[skip\ release\] ]] || [[ "$COMMIT_MSG" =~ \[skip\ ci\] ]]; then
            echo "â­ï¸ Release skipped (commit message flag)" >> $GITHUB_STEP_SUMMARY
            echo "skip-release=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "skip-release=false" >> $GITHUB_OUTPUT

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Determine version
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          VERSION=""
          VERSION_SOURCE=""

          # Method 1: Manual input (highest priority)
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            VERSION_SOURCE="manual input"
            echo "âœ… Version from manual input: $VERSION" >> $GITHUB_STEP_SUMMARY

          # Method 2: File diff detection (for auto-releases)
          elif [ "${{ github.event_name }}" == "push" ]; then
            # Check CITATION.cff first
            if git diff HEAD~1 HEAD -- CITATION.cff | grep -q "^+version:"; then
              VERSION=$(grep "^version:" CITATION.cff | head -1 | sed 's/version: *//' | tr -d '"' | tr -d "'")
              VERSION_SOURCE="CITATION.cff"
              echo "âœ… Version detected from CITATION.cff: $VERSION" >> $GITHUB_STEP_SUMMARY

            # Check pyproject.toml
            elif git diff HEAD~1 HEAD -- pyproject.toml | grep -q "^+version"; then
              VERSION=$(grep "^version = " pyproject.toml | head -1 | sed 's/version = *//' | tr -d '"' | tr -d "'")
              VERSION_SOURCE="pyproject.toml"
              echo "âœ… Version detected from pyproject.toml: $VERSION" >> $GITHUB_STEP_SUMMARY

            # Check CHANGELOG.md
            elif git diff HEAD~1 HEAD -- CHANGELOG.md | grep -qE "^+## \[[0-9]+\.[0-9]+\.[0-9]+"; then
              VERSION=$(git diff HEAD~1 HEAD -- CHANGELOG.md | grep -E "^+## \[" | head -1 | grep -oE "[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?")
              VERSION_SOURCE="CHANGELOG.md"
              echo "âœ… Version detected from CHANGELOG.md: $VERSION" >> $GITHUB_STEP_SUMMARY
            fi

          # Method 3: Read from existing files
          elif [ -f "CITATION.cff" ]; then
            VERSION=$(grep "^version:" CITATION.cff | head -1 | sed 's/version: *//' | tr -d '"' | tr -d "'")
            VERSION_SOURCE="CITATION.cff (current)"
            echo "âœ… Version read from CITATION.cff: $VERSION" >> $GITHUB_STEP_SUMMARY

          elif [ -f "pyproject.toml" ]; then
            VERSION=$(grep "^version = " pyproject.toml | head -1 | sed 's/version = *//' | tr -d '"' | tr -d "'")
            VERSION_SOURCE="pyproject.toml (current)"
            echo "âœ… Version read from pyproject.toml: $VERSION" >> $GITHUB_STEP_SUMMARY
          fi

          # Method 4: Auto-bump from last tag
          if [ -z "$VERSION" ] && [ "${{ inputs.version-bump }}" != "" ]; then
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.0.0")
            BUMP="${{ inputs.version-bump }}"

            echo "ğŸ“Œ Last tag: $LAST_TAG" >> $GITHUB_STEP_SUMMARY

            if [ "$BUMP" == "auto" ]; then
              # Detect from commit messages
              COMMITS=$(git log ${LAST_TAG}..HEAD --oneline)
              if echo "$COMMITS" | grep -qiE "BREAKING CHANGE|^feat!:|^fix!:"; then
                BUMP="major"
              elif echo "$COMMITS" | grep -qiE "^feat:|^feature:"; then
                BUMP="minor"
              else
                BUMP="patch"
              fi
              echo "ğŸ” Auto-detected bump type: $BUMP" >> $GITHUB_STEP_SUMMARY
            fi

            IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST_TAG"
            case $BUMP in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch) PATCH=$((PATCH + 1)) ;;
            esac

            VERSION=$(printf "%d.%d.%d" $MAJOR $MINOR $PATCH)
            VERSION_SOURCE="auto-bump ($BUMP from $LAST_TAG)"
            echo "âœ… Auto-bumped version: $VERSION" >> $GITHUB_STEP_SUMMARY
          fi

          # Fallback: use last tag or default
          if [ -z "$VERSION" ]; then
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.1.0")
            VERSION_SOURCE="git tag (fallback)"
            echo "âš ï¸ Using fallback version: $VERSION" >> $GITHUB_STEP_SUMMARY
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Remove 'v' prefix if present
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          VERSION=${VERSION#v}

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Validate semantic versioning format
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
            echo "âŒ Invalid version format: $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "Expected: MAJOR.MINOR.PATCH[-PRERELEASE]" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Extract version components
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          BASE_VERSION=$(echo "$VERSION" | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+')
          MAJOR=$(echo "$BASE_VERSION" | cut -d. -f1)
          MINOR=$(echo "$BASE_VERSION" | cut -d. -f2)
          PATCH=$(echo "$BASE_VERSION" | cut -d. -f3)

          # Extract prerelease suffix if present
          if echo "$VERSION" | grep -qE '-[a-zA-Z0-9.-]+$'; then
            PRERELEASE_SUFFIX=$(echo "$VERSION" | grep -oE '\-[a-zA-Z0-9.-]+$')
            IS_PRERELEASE="true"
          else
            PRERELEASE_SUFFIX=""
            IS_PRERELEASE="false"
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Output results
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "base-version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "prerelease-suffix=$PRERELEASE_SUFFIX" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "version-source=$VERSION_SOURCE" >> $GITHUB_OUTPUT

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Version Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Full Version**: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Version**: \`$BASE_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Components**: Major=$MAJOR, Minor=$MINOR, Patch=$PATCH" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease**: $IS_PRERELEASE${PRERELEASE_SUFFIX:+ ($PRERELEASE_SUFFIX)}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: $VERSION_SOURCE" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB: Start Development Branch
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  start-dev:
    name: Start Development Branch
    runs-on: ubuntu-latest
    needs: detect
    if: |
      needs.detect.outputs.skip-release != 'true' &&
      needs.detect.outputs.action == 'start-dev'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Development Branch
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          DEV_BRANCH="dev/$VERSION"

          if git ls-remote --heads origin "$DEV_BRANCH" | grep -q "$DEV_BRANCH"; then
            echo "âš ï¸ Development branch already exists: $DEV_BRANCH" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          git checkout -b "$DEV_BRANCH"
          git push origin "$DEV_BRANCH"

          echo "âœ… Created development branch: \`$DEV_BRANCH\`" >> $GITHUB_STEP_SUMMARY

      - name: Update Version Files
        run: |
          VERSION="${{ needs.detect.outputs.version }}"

          # Update version in common files (if they exist)
          if [ -f "package.json" ]; then
            npm version "$VERSION" --no-git-tag-version
            git add package.json package-lock.json 2>/dev/null || true
            echo "âœ… Updated package.json" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "composer.json" ]; then
            # Update version in composer.json if version field exists
            if grep -q "\"version\":" composer.json; then
              sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" composer.json
              git add composer.json
              echo "âœ… Updated composer.json" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Commit changes if any
          if ! git diff --staged --quiet; then
            git commit -m "chore: bump version to $VERSION"
            git push origin "dev/$VERSION"
            echo "âœ… Version files updated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No version files to update" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB: Create Release Candidate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-rc:
    name: Create Release Candidate
    runs-on: ubuntu-latest
    needs: detect
    if: |
      needs.detect.outputs.skip-release != 'true' &&
      needs.detect.outputs.action == 'create-rc'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: dev/${{ needs.detect.outputs.version }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create RC Branch and Tag
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          RC_BRANCH="rc/$VERSION"

          # Create RC branch
          if git ls-remote --heads origin "$RC_BRANCH" | grep -q "$RC_BRANCH"; then
            echo "âš ï¸ RC branch already exists: $RC_BRANCH" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          git checkout -b "$RC_BRANCH"
          git push origin "$RC_BRANCH"

          # Create RC tag (add -rc suffix if not present)
          if echo "$VERSION" | grep -qE '-[a-zA-Z0-9.-]+$'; then
            TAG="v${VERSION}"
          else
            TAG="v${VERSION}-rc"
          fi

          git tag -a "$TAG" -m "Release Candidate $VERSION"
          git push origin "$TAG"

          echo "âœ… Created RC branch: \`$RC_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Created RC tag: \`$TAG\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB: Finalize Release (RC â†’ version â†’ main â†’ release)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  finalize-release:
    name: Finalize Release to Main
    runs-on: ubuntu-latest
    needs: detect
    if: |
      needs.detect.outputs.skip-release != 'true' &&
      needs.detect.outputs.action == 'finalize-release'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: rc/${{ needs.detect.outputs.version }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Version Branch
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          VERSION_BRANCH="version/$VERSION"

          # Create version branch (permanent record)
          git checkout -b "$VERSION_BRANCH"
          git push origin "$VERSION_BRANCH"

          echo "âœ… Created version branch: \`$VERSION_BRANCH\`" >> $GITHUB_STEP_SUMMARY

      - name: Merge to Main
        run: |
          VERSION="${{ needs.detect.outputs.version }}"

          # Merge to main using no-fast-forward
          git checkout main
          git pull origin main
          git merge --no-ff "version/$VERSION" -m "Release version $VERSION"
          git push origin main

          echo "âœ… Merged to main branch using --no-ff" >> $GITHUB_STEP_SUMMARY

      - name: Create Release Tag
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          TAG="v$VERSION"

          git tag -a "$TAG" -m "Release $VERSION"
          git push origin "$TAG"

          echo "âœ… Created release tag: \`$TAG\`" >> $GITHUB_STEP_SUMMARY

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ needs.detect.outputs.version }}"

          # Try to extract from CHANGELOG.md first
          if [ -f "CHANGELOG.md" ]; then
            # Extract section for this version
            NOTES=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' | sed '/^$/d' || echo "")
          fi

          # Fallback to git log if CHANGELOG doesn't have content
          if [ -z "$NOTES" ]; then
            # Determine the RC tag to compare against
            if echo "$VERSION" | grep -qE '-[a-zA-Z0-9.-]+$'; then
              RC_TAG="v${VERSION}"
            else
              RC_TAG="v${VERSION}-rc"
            fi

            NOTES=$(git log --pretty=format:"- %s" "${RC_TAG}"..HEAD 2>/dev/null || echo "Initial release")
          fi

          # Save to file for GitHub release
          cat > release_notes.md <<EOF
          ## Release $VERSION

          $NOTES
          EOF

          echo "âœ… Generated release notes" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect.outputs.version }}
          name: Release ${{ needs.detect.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: Cleanup Information
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          
          echo "â„¹ï¸ Development branches retained for history" >> $GITHUB_STEP_SUMMARY
          echo "To manually cleanup, run:" >> $GITHUB_STEP_SUMMARY
          echo "  \`git push origin --delete dev/$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "  \`git push origin --delete rc/$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** version/$VERSION branch is permanent and should NOT be deleted" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB: Hotfix Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  hotfix:
    name: Create Hotfix Release
    runs-on: ubuntu-latest
    needs: detect
    if: |
      needs.detect.outputs.skip-release != 'true' &&
      needs.detect.outputs.action == 'hotfix'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Hotfix Branch
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          HOTFIX_BRANCH="hotfix/$VERSION"

          # Check if hotfix branch already exists
          if git ls-remote --heads origin "$HOTFIX_BRANCH" | grep -q "$HOTFIX_BRANCH"; then
            echo "âš ï¸ Hotfix branch already exists: $HOTFIX_BRANCH" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Create hotfix branch from main
          git checkout -b "$HOTFIX_BRANCH"
          git push origin "$HOTFIX_BRANCH"

          echo "âœ… Created hotfix branch: \`$HOTFIX_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Apply hotfix changes to \`$HOTFIX_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Test thoroughly" >> $GITHUB_STEP_SUMMARY
          echo "3. Create PR to merge back to main" >> $GITHUB_STEP_SUMMARY
          echo "4. After merge, create release tag manually or tag from main" >> $GITHUB_STEP_SUMMARY
    permissions:
      contents: write

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB: Simple Release (One-Step)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  simple-release:
    name: Simple Release
    needs: detect
    if: |
      needs.detect.outputs.skip-release != 'true' &&
      (needs.detect.outputs.action == 'simple-release' || github.event_name == 'push')
    uses: ./.github/workflows/reusable-release.yml
    with:
      version: ${{ needs.detect.outputs.version }}
      prerelease: ${{ needs.detect.outputs.is-prerelease == 'true' || inputs.prerelease }}
      draft: ${{ inputs.draft || false }}
      create-github-release: ${{ !inputs.skip-build }}
    secrets: inherit
    permissions:
      contents: write

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB: Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [detect, start-dev, create-rc, finalize-release, hotfix, simple-release]
    if: always() && needs.detect.outputs.skip-release != 'true'

    steps:
      - name: Generate Summary
        run: |
          echo "# ğŸš€ Unified Release Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ needs.detect.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`${{ needs.detect.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Source**: ${{ needs.detect.outputs.version-source }}" >> $GITHUB_STEP_SUMMARY
          echo "**Prerelease**: ${{ needs.detect.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "${{ needs.detect.outputs.action }}" in
            start-dev)
              echo "âœ… Development branch created" >> $GITHUB_STEP_SUMMARY
              ;;
            create-rc)
              echo "âœ… Release candidate created" >> $GITHUB_STEP_SUMMARY
              ;;
            finalize-release)
              echo "âœ… Release finalized to main" >> $GITHUB_STEP_SUMMARY
              ;;
            hotfix)
              echo "âœ… Hotfix release created" >> $GITHUB_STEP_SUMMARY
              ;;
            simple-release)
              echo "âœ… Simple release created" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# USAGE EXAMPLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. AUTO-RELEASE (File-based):
#    - Update version in CITATION.cff or pyproject.toml
#    - Commit and push to main
#    - Pipeline auto-detects and creates release
#
# 2. MANUAL SIMPLE RELEASE:
#    - Workflow dispatch â†’ action: "simple-release" â†’ version: "1.2.3"
#    - Creates release in one step
#
# 3. STAGED RELEASE (Dev â†’ RC â†’ Stable):
#    Step 1: action: "start-dev" â†’ version: "1.2.3"
#    Step 2: Make changes in dev/1.2.3 branch
#    Step 3: action: "create-rc" â†’ version: "1.2.3"
#    Step 4: Test RC thoroughly
#    Step 5: action: "finalize-release" â†’ version: "1.2.3"
#
# 4. PRERELEASE:
#    - Workflow dispatch â†’ action: "simple-release" â†’ version: "1.2.3-rc1"
#    - OR set prerelease: true
#
# 5. HOTFIX:
#    - Workflow dispatch â†’ action: "hotfix" â†’ version: "1.2.4"
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
